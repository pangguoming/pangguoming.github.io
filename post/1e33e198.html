<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="C#,异步编程,">










<meta name="description" content="什么是异步编程什么是异步编程呢？举个简单的例子： 123456789101112131415161718192021222324252627using System.Net.Http;using System.Threading.Tasks;using static System.Console;namespace Core&amp;#123;    class Async    &amp;#123;">
<meta name="keywords" content="C#,异步编程">
<meta property="og:type" content="article">
<meta property="og:title" content="C#异步编程">
<meta property="og:url" content="http://pangguoming.com/post/1e33e198.html">
<meta property="og:site_name" content="庞国明-博客">
<meta property="og:description" content="什么是异步编程什么是异步编程呢？举个简单的例子： 123456789101112131415161718192021222324252627using System.Net.Http;using System.Threading.Tasks;using static System.Console;namespace Core&amp;#123;    class Async    &amp;#123;">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://pangguoming.com/blog/images/8f2312da-a35d-4e23-9b6c-63cd1b5827a8.png">
<meta property="og:image" content="https://upload-images.jianshu.io/upload_images/1458860-36624514d5ee5c6c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:image" content="https://upload-images.jianshu.io/upload_images/1458860-2e3248c3d8c31d06.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:image" content="https://upload-images.jianshu.io/upload_images/1458860-83f79cb9d52b86d9.jpeg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:image" content="https://upload-images.jianshu.io/upload_images/1458860-c6ce4499f00271f2.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:image" content="https://upload-images.jianshu.io/upload_images/1458860-a0480dc37f942cb6.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:image" content="https://upload-images.jianshu.io/upload_images/1458860-0872a2014f5f118b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:image" content="https://upload-images.jianshu.io/upload_images/1458860-7640b9783f9438bb.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:image" content="https://upload-images.jianshu.io/upload_images/1458860-58a677be2d2da045.PNG?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:image" content="https://upload-images.jianshu.io/upload_images/1458860-115e1968e2cf96c3.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:updated_time" content="2019-07-10T03:30:55.641Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="C#异步编程">
<meta name="twitter:description" content="什么是异步编程什么是异步编程呢？举个简单的例子： 123456789101112131415161718192021222324252627using System.Net.Http;using System.Threading.Tasks;using static System.Console;namespace Core&amp;#123;    class Async    &amp;#123;">
<meta name="twitter:image" content="http://pangguoming.com/blog/images/8f2312da-a35d-4e23-9b6c-63cd1b5827a8.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":true},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://pangguoming.com/post/1e33e198.html">





  <title>C#异步编程 | 庞国明-博客</title>
  








</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">庞国明-博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">此心用度八千遍，不曾厌倦</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  
  <div class="algolia-popup popup search-popup">
    <div class="algolia-search">
      <div class="algolia-search-input-icon">
        <i class="fa fa-search"></i>
      </div>
      <div class="algolia-search-input" id="algolia-search-input"></div>
    </div>

    <div class="algolia-results">
      <div id="algolia-stats"></div>
      <div id="algolia-hits"></div>
      <div id="algolia-pagination" class="algolia-pagination"></div>
    </div>

    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
  </div>




    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://pangguoming.com/post/1e33e198.html">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="庞国明">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars0.githubusercontent.com/u/7269202?s=460&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="庞国明-博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">C#异步编程</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-06-24T14:32:00+08:00">
                2018-06-24
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/post/1e33e198.html#comments" itemprop="discussionUrl">
                  <span class="post-comments-count gitment-comments-count" data-xid="/post/1e33e198.html" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="什么是异步编程"><a href="#什么是异步编程" class="headerlink" title="什么是异步编程"></a>什么是异步编程</h1><p>什么是异步编程呢？举个简单的例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">using System.Net.Http;</span><br><span class="line">using System.Threading.Tasks;</span><br><span class="line">using static System.Console;</span><br><span class="line"></span><br><span class="line">namespace Core</span><br><span class="line">&#123;</span><br><span class="line">    class Async</span><br><span class="line">    &#123;</span><br><span class="line">        static void Main()</span><br><span class="line">        &#123;</span><br><span class="line">            Start();</span><br><span class="line">            End();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        static void Wait()=&gt;WriteLine(&quot;waiting...&quot;);</span><br><span class="line">        static void End()=&gt;WriteLine(&quot;end...&quot;);</span><br><span class="line">        static int Start()</span><br><span class="line">        &#123;</span><br><span class="line">            WriteLine(&quot;start...&quot;);</span><br><span class="line">            HttpClient client = new HttpClient();</span><br><span class="line">            Waiting();</span><br><span class="line">            var result = client.GetStringAsync(&quot;https://www.visualstudio.com/&quot;);</span><br><span class="line">            string str = result.Result;</span><br><span class="line">            return str.Length;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面这段代码中，Main方法中的代码是按照自上而下的顺序执行的。网络状况不佳时，<code>Start()</code>方法是比较耗时（注意，这里在<code>Start</code>方法中调用了异步方法<code>GetStringAsync</code>，但该方法在此处是以同步方式执行的，具体原因下文会进行说明），在<code>Start()</code>方法执行完毕之前，整个程序处于阻塞状态。而异步编程可以很好的解决这个问题，一句简单的话来概括异步编程就是，<strong>程序无须按照代码顺序自上而下的执行</strong>。</p>
<h1 id="async-await"><a href="#async-await" class="headerlink" title="async/await"></a>async/await</h1><p><strong>C#5.0新增了async和await关键字，使用这两个关键字可以大大简化异步编程</strong></p>
<p>使用 <strong>async</strong> 关键字可将方法、<a href="https://msdn.microsoft.com/zh-cn/library/bb397687.aspx" target="_blank" rel="noopener">lambda 表达式</a>或<a href="https://msdn.microsoft.com/zh-cn/library/0yw3tz5k.aspx" target="_blank" rel="noopener">匿名方法</a><strong>标记为异步，</strong>即，方法中应该包含一个或多个await表达式，但async关键字本身不会创建异步操作。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public async Task Asy()</span><br><span class="line">&#123;</span><br><span class="line">　　//do something...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里需要注意一点，若使用async关键字标记的方法中没有使用await关键字（编译器会给出警告但不报错），那么该方法将会以同步方式执行。</p>
<h1 id="定义异步方法的几点要求"><a href="#定义异步方法的几点要求" class="headerlink" title="定义异步方法的几点要求"></a>定义异步方法的几点要求</h1><p>定义一个异步方法应满足以下几点：</p>
<ul>
<li>使用async关键字来修饰方法</li>
<li>在异步方法中使用await关键字（不使用编译器会给出警告但不报错），否则异步方法会以同步方式执行</li>
<li>尽量不使用void作为返回类型，若希望异步方法返回void类型，请使用Task</li>
<li>异步方法名称以Async结尾</li>
<li>异步方法中不能声明使用ref或out关键字修饰的变量</li>
</ul>
<p>下面定义一个异步方法<code>StartAsync()</code>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">static async Task&lt;int&gt; StartAsync()</span><br><span class="line">&#123;</span><br><span class="line">    HttpClient client = new HttpClient();</span><br><span class="line">    var str = await client.GetStringAsync(&quot;https://www.visualstudio.com/&quot;);</span><br><span class="line">    return str.Length;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="异步方法的返回类型"><a href="#异步方法的返回类型" class="headerlink" title="异步方法的返回类型"></a>异步方法的返回类型</h1><ul>
<li><p>Task<t><br>如果在调用匿名方法时使用了<strong>await</strong>关键字，且匿名方法的返回类型是Task<t>，那么我们得到的返回类型是T。若未使用<strong>await</strong>关键字，则返回类型是Task。未使用await，调用GetStringAsync方法时result是Task类型。</t></t></p>
<p><img src="http://pangguoming.com/blog/images/8f2312da-a35d-4e23-9b6c-63cd1b5827a8.png" alt=""></p>
</li>
</ul>
<p>从上图我们可以看到调用GetStringAsync方法时未使用await关键字，result是Task类型，我们可以通过GetType()方法来获取result的详细类型信息：</p>
<div class="image-package imagebubble"><img src="https://upload-images.jianshu.io/upload_images/1458860-36624514d5ee5c6c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""><br><br>从上图可以看到result的类型全名是System.Threading.Tasks.Task<br><br><div class="image-package imagebubble"><img src="https://upload-images.jianshu.io/upload_images/1458860-2e3248c3d8c31d06.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""><br><br><div class="image-caption"><br><br>从上图我们可以看到使用await关键字时，result是string类型，而匿名方法GetStringAsync的返回类型是Task<string><br><br><em><br><br>Task<br>如果在调用匿名方法时使用了<strong>await</strong>关键字，且匿名方法的返回类型是Task，那么我们得到的返回类型是void。若为使用await关键字，则得到的返回类型是Task。

</em><br><br>void<br>不建议使用void作为异步方法的返回值。<br>因为使用Task或Task<tresult>任务作为返回值，其属性携带有关其状态和历史记录的信息，如任务是否完成、异步方法是否导致异常或已取消以及最终结果是什么。而await运算符可访问这些属性。<br><br># 异步方法执行流程<br><br><div class="image-package imagebubble"><img src="https://upload-images.jianshu.io/upload_images/1458860-83f79cb9d52b86d9.jpeg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""><br><br><div class="image-caption">异步程序执行流程<br><br>上图是微软官方提供的讲解异步程序<a href="https://msdn.microsoft.com/zh-cn/library/mt674882.aspx" target="_blank" rel="noopener">执行流程</a>的图示，并附有解释说明：<br><br>&gt; The numbers in the diagram correspond to the following steps.<br>&gt;<br>&gt; 1.  An event handler calls and awaits the AccessTheWebAsync async method.<br>&gt; 2.  AccessTheWebAsync creates an <a href="https://msdn.microsoft.com/zh-cn/library/system.net.http.httpclient.aspx" target="_blank" rel="noopener">HttpClient</a> instance and calls the <a href="https://msdn.microsoft.com/zh-cn/library/hh551746.aspx" target="_blank" rel="noopener">GetStringAsync</a>asynchronous method to download the contents of a website as a string.<br>&gt; 3.  Something happens in <strong>GetStringAsync</strong> that suspends its progress. Perhaps it must wait for a website to download or some other blocking activity. To avoid blocking resources, <strong>GetStringAsync</strong> yields control to its caller, AccessTheWebAsync.<br>&gt; <strong>GetStringAsync</strong> returns a <a href="https://msdn.microsoft.com/zh-cn/library/dd321424.aspx" target="_blank" rel="noopener">Task<tresult></tresult></a> where <strong>TResult </strong>is a string, and AccessTheWebAsync assigns the task to thegetStringTask variable. The task represents the ongoing process for the call to <strong>GetStringAsync</strong>, with a commitment to produce an actual string value when the work is complete.<br>&gt; 4.  Because getStringTask hasn’t been awaited yet, AccessTheWebAsync can continue with other work that doesn’t depend on the final result from <strong>GetStringAsync</strong>. That work is represented by a call to the synchronous method DoIndependentWork.<br>&gt; 5.  DoIndependentWork is a synchronous method that does its work and returns to its caller.<br>&gt; 6.  AccessTheWebAsync has run out of work that it can do without a result from getStringTask. AccessTheWebAsync next wants to calculate and return the length of the downloaded string, but the method can’t calculate that value until the method has the string.<br>&gt; Therefore, AccessTheWebAsync uses an await operator to suspend its progress and to yield control to the method that called AccessTheWebAsync. AccessTheWebAsync returns a <strong>Task<int></int></strong> to the caller. The task represents a promise to produce an integer result that’s the length of the downloaded string.<br>&gt; <blockquote><br>&gt;<br>&gt; <strong>Note</strong><br>&gt; If <strong>GetStringAsync</strong> (and therefore getStringTask) is complete before AccessTheWebAsync awaits it, control remains inAccessTheWebAsync. The expense of suspending and then returning to AccessTheWebAsync would be wasted if the called asynchronous process (getStringTask) has already completed and AccessTheWebSync doesn’t have to wait for the final result.<br>&gt; Inside the caller (the event handler in this example), the processing pattern continues. The caller might do other work that doesn’t depend on the result from AccessTheWebAsync before awaiting that result, or the caller might await immediately. The event handler is waiting for AccessTheWebAsync, and AccessTheWebAsync is waiting for <strong>GetStringAsync</strong>.<br>&gt;<br>&gt; </blockquote><br>&gt;<br>&gt; 7.  <strong>GetStringAsync</strong> completes and produces a string result. The string result isn’t returned by the call to <strong>GetStringAsync</strong> in the way that you might expect. (Remember that the method already returned a task in step Instead, the string result is stored in the task that represents the completion of the method, getStringTask. The await operator retrieves the result from getStringTask. The assignment statement assigns the retrieved result to urlContents.<br>&gt; 8.  When AccessTheWebAsync has the string result, the method can calculate the length of the string. Then the work ofAccessTheWebAsync is also complete, and the waiting event handler can resume. In the full example at the end of the topic, you can confirm that the event handler retrieves and prints the value of the length result.<br>&gt; If you are new to asynchronous programming, take a minute to consider the difference between synchronous and asynchronous behavior. A synchronous method returns when its work is complete (step 5), but an async method returns a task value when its work is suspended (steps 3 and 6). When the async method eventually completes its work, the task is marked as completed and the result, if any, is stored in the task.<br><br>解释虽是英文，但并没有太难的单词，是可以看懂其意思的。通过上面的说明，我们可以知道：<br>在遇到<strong>awiat</strong>关键字之前，程序是按照代码顺序自上而下以同步方式执行的。<br>在遇到<strong>await</strong>关键字之后，系统做了以下工作：<br><br>1.  异步方法将被挂起<br>2.  将控制权返回给调用者<br>3.  使用线程池中的线程（而非额外创建新的线程）来计算await表达式的结果，所以await不会造成程序的阻塞<br>4.  完成对await表达式的计算之后，若await表达式后面还有代码则由执行await表达式的线程（不是调用方所在的线程）继续执行这些代码<br><br>使用一段代码来进行验证：<br><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">static void Main()</span><br><span class="line">&#123;</span><br><span class="line">    Task&lt;int&gt; task = StartAsync();</span><br><span class="line">    Thread.Sleep(5000);</span><br><span class="line">    End();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static async Task&lt;int&gt; StartAsync()</span><br><span class="line">&#123;</span><br><span class="line">    WriteLine(&quot;start...&quot;);</span><br><span class="line">    HttpClient client = new HttpClient();</span><br><span class="line">    var result = client.GetStringAsync(&quot;https://www.visualstudio.com/&quot;);</span><br><span class="line">    string str = await result;</span><br><span class="line">    return str.Length;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br><br>执行代码<br><br><div class="image-package imagebubble"><img src="https://upload-images.jianshu.io/upload_images/1458860-c6ce4499f00271f2.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""><br><br>从上图左侧的调用栈中可以看到，在遇到await关键字之前，异步方法<code>StartAsync</code>自上而下同步执行。注意，这里异步方法<code>GetStringAsync</code>方法是被挂起的，不会造成程序的阻塞，控制权回到调用者<code>StartAsync</code>中，仔细看英文解释中的第3步。<br>然后在Debug Console中输入<code>System.Threading.Thread.Current</code>查看当前工作线程信息，以及<code>System.Threading.Thread.CurrentThread.IsThreadPoolThread</code>查看当前线程是否在线程池中。<br><br><div class="image-package imagebubble"><img src="https://upload-images.jianshu.io/upload_images/1458860-a0480dc37f942cb6.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""><br><br><div class="image-caption"><br><br>从上图我们看到，当前线程Id是1，不在线程池中。继续执行程序：<br><br><div class="image-package imagebubble"><img src="https://upload-images.jianshu.io/upload_images/1458860-0872a2014f5f118b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""><br><br>遇到await关键字后，异步方法<code>StartAsync</code>被挂起，控制权也回到了调用者Main方法中。<br><br><div class="image-package imagebubble"><img src="https://upload-images.jianshu.io/upload_images/1458860-7640b9783f9438bb.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""><br><br>从上图我们可以看到异步方法<code>StartAsync</code>中的result变量的Status属性值是<code>WaitingForActivation</code>，Result属性值是<code>Not yet computed</code>。<br><br>代码继续执行，将Main方法所在线程接挂起5秒，系统使用线程池中的线程计算await表达式的值：<br><br><div class="image-package imagebubble"><img src="https://upload-images.jianshu.io/upload_images/1458860-58a677be2d2da045.PNG?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""><br><br>从上图我们可以看到，程序已经成功计算出await表达式的值，变量result的Status属性值变成了<code>RanToCompletion</code>。完成对await表达式的计算之后，程序继续执行后面的代码(<code>return str.Length</code>)。<br><br>再看此时的工作线程信息：<br><br><div class="image-package imagebubble"><img src="https://upload-images.jianshu.io/upload_images/1458860-115e1968e2cf96c3.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""><br><br>我们看到，当前线程Id是5且存在于线程池中。<br><br>从这里我们可以得知<strong>异步是借助于多线程来实现的</strong>。<br><br># Task<br><br><a href="https://msdn.microsoft.com/en-us/library/system.threading.tasks.task.aspx" target="_blank" rel="noopener">Task</a>类拥有执行异步方法的两个方法：<code>Task.Run()</code>,<code>Task.Run&lt;T&gt;</code>，<code>Task.Run</code>以及<code>Task.Run&lt;T&gt;</code>使用线程池中的线程来执行代码，它和使用await关键字的区别是：Task.Run直接使用线程池中的线程，而使用await的异步方法是在遇到await关键字后才使用多线程。<br><br># Thread<br><br><a href="https://msdn.microsoft.com/en-us/library/system.threading.thread(v=vs.110" target="_blank" rel="noopener">线程</a>.aspx)是前面所说的异步（async/await）和任务（Task）的基础。和线程紧密相关的另外一个概念是进程，这里不多赘述。<br><br># ThreadPool<br><br>线程也是对象，频繁的创建和销毁线程比较影响性能，.NET提供<a href="https://msdn.microsoft.com/zh-cn/library/system.threading.threadpool(v=vs.110" target="_blank" rel="noopener">线程池</a>.aspx)使得我们能够复用线程对象从而避免频繁创建和销毁线程。<br><br># 结语<br><br>自己创建线程比较麻烦但能够更好的控制程序的运行，使用async/await关键字来编码显得较为简洁，但对程序的控制力度会有所降低。<br><br># 参考文章：<br><br><a href="https://msdn.microsoft.com/zh-cn/library/mt674882.aspx" target="_blank" rel="noopener">Asynchronous Programming with async and await (C#)</a><br><a href="https://msdn.microsoft.com/zh-cn/library/hh156513.aspx" target="_blank" rel="noopener">async</a><br><a href="https://msdn.microsoft.com/zh-cn/library/hh156528.aspx" target="_blank" rel="noopener">await</a><br><a href="http://www.cnblogs.com/liqingwen/p/5831951.html" target="_blank" rel="noopener">走进异步编程的世界 - 开始接触 async/await</a><br><a href="http://www.cnblogs.com/durow/p/4826653.html" target="_blank" rel="noopener">C#执行异步操作的几种方式比较和总结</a><br><a href="http://blog.csdn.net/huwei2003/article/details/47167235" target="_blank" rel="noopener">thread task parallel plinq async await多线程 任务及异步编程</a><br><a href="http://www.cnblogs.com/liqingwen/p/5877042.html" target="_blank" rel="noopener">走进异步编程的世界 - 在 GUI 中执行异步操作</a><br><br><a href="https://msdn.microsoft.com/en-us/magazine/jj991977.aspx" target="_blank" rel="noopener">Async/Await - Best Practices in Asynchronous Programming</a><br><br><div><br><br>### 版权声明<br><br></div></div></div></div></div></div></div></div></div></div></tresult></string></div></div></div>
      
    </div>
    
    
    

    

    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div>感谢支持原创技术分享</div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>打赏</span>
  </button>
  <div id="QR" style="display: none;">

    
      <div id="wechat" style="display: inline-block">
        <img id="wechat_qr" src="/repo/wechatpay.png" alt="庞国明 微信支付">
        <p>微信支付</p>
      </div>
    

    
      <div id="alipay" style="display: inline-block">
        <img id="alipay_qr" src="/repo/alipay.jpg" alt="庞国明 支付宝">
        <p>支付宝</p>
      </div>
    

    

  </div>
</div>

      </div>
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/C/" rel="tag"># C#</a>
          
            <a href="/tags/异步编程/" rel="tag"># 异步编程</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/post/125f6c25.html" rel="next" title="mongodb 按配置文件mongodb.conf启动">
                <i class="fa fa-chevron-left"></i> mongodb 按配置文件mongodb.conf启动
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/post/90d7057.html" rel="prev" title="kafka 主要内容介绍">
                kafka 主要内容介绍 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
      
        <div id="gitment-container"></div>
      
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
      <div id="sidebar-dimmer"></div>
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="https://avatars0.githubusercontent.com/u/7269202?s=460&v=4" alt="庞国明">
            
              <p class="site-author-name" itemprop="name">庞国明</p>
              <p class="site-description motion-element" itemprop="description">Software make the information world run, and programer make the softeware run.</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">420</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">3</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">267</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/pangguoming" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:pangguoming@yeah.net" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://twitter.com/pangguoming" target="_blank" title="Twitter">
                      
                        <i class="fa fa-fw fa-twitter"></i>Twitter</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://stackoverflow.com/users/1570700/pangguoming" target="_blank" title="StackOverflow">
                      
                        <i class="fa fa-fw fa-stack-overflow"></i>StackOverflow</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://instagram.com/pangguoming" target="_blank" title="Instagram">
                      
                        <i class="fa fa-fw fa-instagram"></i>Instagram</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#什么是异步编程"><span class="nav-number">1.</span> <span class="nav-text">什么是异步编程</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#async-await"><span class="nav-number">2.</span> <span class="nav-text">async/await</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#定义异步方法的几点要求"><span class="nav-number">3.</span> <span class="nav-text">定义异步方法的几点要求</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#异步方法的返回类型"><span class="nav-number">4.</span> <span class="nav-text">异步方法的返回类型</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">庞国明</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  







<!-- LOCAL: You can save these files to your site and update links -->
    
        
        <link rel="stylesheet" href="https://aimingoo.github.io/gitmint/style/default.css">
        <script src="https://aimingoo.github.io/gitmint/dist/gitmint.browser.js"></script>
    
<!-- END LOCAL -->

    

    
      <script type="text/javascript">
      function renderGitment(){
        var gitment = new Gitmint({
            id: window.location.pathname, 
            owner: 'pangguoming',
            repo: 'pangguoming.github.io',
            
            lang: "" || navigator.language || navigator.systemLanguage || navigator.userLanguage,
            
            oauth: {
            
            
                client_secret: '51f66abac54ca9e1b5a5608d706ce6af47ffaa51',
            
                client_id: '1e9770fed2b4d227cd0a'
            }});
        gitment.render('gitment-container');
      }

      
      renderGitment();
      
      </script>
    







  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>




  
  
  
  <link rel="stylesheet" href="/lib/algolia-instant-search/instantsearch.min.css">

  
  
  <script src="/lib/algolia-instant-search/instantsearch.min.js"></script>
  

  <script src="/js/src/algolia-search.js?v=5.1.4"></script>



  

  

  

  
  

  

  

  

</body>
</html>
