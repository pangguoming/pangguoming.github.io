<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">










<meta name="description" content="Software make the information world run, and programer make the softeware run.">
<meta property="og:type" content="website">
<meta property="og:title" content="庞国明-博客">
<meta property="og:url" content="http://pangguoming.com/page/22/index.html">
<meta property="og:site_name" content="庞国明-博客">
<meta property="og:description" content="Software make the information world run, and programer make the softeware run.">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="庞国明-博客">
<meta name="twitter:description" content="Software make the information world run, and programer make the softeware run.">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":true},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://pangguoming.com/page/22/">





  <title>庞国明-博客</title>
  








</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">庞国明-博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">此心用度八千遍，不曾厌倦</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  
  <div class="algolia-popup popup search-popup">
    <div class="algolia-search">
      <div class="algolia-search-input-icon">
        <i class="fa fa-search"></i>
      </div>
      <div class="algolia-search-input" id="algolia-search-input"></div>
    </div>

    <div class="algolia-results">
      <div id="algolia-stats"></div>
      <div id="algolia-hits"></div>
      <div id="algolia-pagination" class="algolia-pagination"></div>
    </div>

    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
  </div>




    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://pangguoming.com/post/a9d5e7f5.html">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="庞国明">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars0.githubusercontent.com/u/7269202?s=460&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="庞国明-博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/post/a9d5e7f5.html" itemprop="url">当spring 容器初始化完成后执行某个方法</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-12-12T16:26:00+08:00">
                2017-12-12
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>在做web项目开发中，尤其是企业级应用开发的时候，往往会在工程启动的时候做许多的前置检查。</p>
<p>比如检查是否使用了我们组禁止使用的Mysql的group_concat函数，如果使用了项目就不能启动，并指出哪个文件的xml文件使用了这个函数。</p>
<p>而在Spring的web项目中，我们可以介入Spring的启动过程。我们希望在Spring容器将所有的Bean都初始化完成之后，做一些操作，这个时候我们就可以实现一个接口：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">package com.yk.test.executor.processor</span><br><span class="line">public class InstantiationTracingBeanPostProcessor implements ApplicationListener&lt;ContextRefreshedEvent&gt; &#123;</span><br><span class="line">@Override</span><br><span class="line">public void onApplicationEvent(ContextRefreshedEvent event) &#123;</span><br><span class="line">//需要执行的逻辑代码，当spring容器初始化完成后就会执行该方法。</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>同时在Spring的配置文件中，添加注入：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- 当Spring容器启动完成后执行下面的这个Bean --&gt;</span><br><span class="line">&lt;bean class=&quot;com.yk.test.executor.processor.InstantiationTracingBeanPostProcessor&quot;/&gt;</span><br></pre></td></tr></table></figure>
<p>但是这个时候，会存在一个问题，在web 项目中（spring mvc），系统会存在两个容器，一个是root application context ,另一个就是我们自己的 projectName-servlet context（作为root application context的子容器）。</p>
<p>这种情况下，就会造成onApplicationEvent方法被执行两次。为了避免上面提到的问题，我们可以只在root application context初始化完成后调用逻辑代码，其他的容器的初始化完成，则不做任何处理，修改后代码</p>
<p>如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void onApplicationEvent(ContextRefreshedEvent event) &#123;</span><br><span class="line">if(event.getApplicationContext().getParent() == null)&#123;//root application context 没有parent，他就是老大.</span><br><span class="line">//需要执行的逻辑代码，当spring容器初始化完成后就会执行该方法。</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>其实更简单的方法是使用注解：<code>@PostConstruct</code>，只需要在需要启动的时候执行的方法上标注这个注解就搞定了。</strong></p>
<p><strong>例子：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 服务启动时就执行--添加超级管理员</span><br><span class="line"> */</span><br><span class="line">@PostConstruct</span><br><span class="line">public void addDefaultAdmin() &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        User user = new User();</span><br><span class="line">        user.setCreateTime(new Date());</span><br><span class="line">        try &#123;</span><br><span class="line">            user.setPassword(Md5.md5Encode(&quot;admin&quot;));</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        user.setUserName(&quot;admin&quot;);</span><br><span class="line">        user.setRole(FrameConstant.USER_SUPER_ADMIN);</span><br><span class="line">        userDao.save(user);</span><br><span class="line">        log.debug(&quot;初始化完毕！&quot;);</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">        log.debug(&quot;初始化完毕！&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://pangguoming.com/post/97b49600.html">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="庞国明">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars0.githubusercontent.com/u/7269202?s=460&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="庞国明-博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/post/97b49600.html" itemprop="url">Activiti学习——Activiti与Spring集成</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-12-12T15:20:00+08:00">
                2017-12-12
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="与Spring集成"><a href="#与Spring集成" class="headerlink" title="与Spring集成"></a>与Spring集成</h1><h2 id="基础准备"><a href="#基础准备" class="headerlink" title="基础准备"></a>基础准备</h2><h3 id="目录结构"><a href="#目录结构" class="headerlink" title="目录结构"></a>目录结构</h3><p><img src="http://i.imgur.com/0CfoqXp.png" alt=""></p>
<h3 id="相关jar包"><a href="#相关jar包" class="headerlink" title="相关jar包"></a>相关jar包</h3><p>Activiti的相关jar包<br>Activiti依赖的相关jar包<br>Spring的相关jar包<br>Spring依赖的相关jar包<br>本示例相关jar包截图<br><img src="http://i.imgur.com/FPpXrFY.png" alt=""><br><img src="http://i.imgur.com/C0cLW1R.png" alt=""></p>
<h2 id="配置文件设置"><a href="#配置文件设置" class="headerlink" title="配置文件设置"></a>配置文件设置</h2><h3 id="web-xml"><a href="#web-xml" class="headerlink" title="web.xml"></a>web.xml</h3><p><code class="language-xml hljs  has-numbering"><span class="hljs-pi">&lt;?xml version=”1.0” encoding=”UTF-8”?&gt;<br>    <span class="hljs-tag">&lt;<span class="hljs-title">web-app <span class="hljs-attribute">xmlns:xsi=<span class="hljs-value">“<a href="http://www.w3.org/2001/XMLSchema-instance&quot;" target="_blank" rel="noopener">http://www.w3.org/2001/XMLSchema-instance&quot;</a><br>        <span class="hljs-attribute">xmlns=<span class="hljs-value">“<a href="http://java.sun.com/xml/ns/javaee&quot;" target="_blank" rel="noopener">http://java.sun.com/xml/ns/javaee&quot;</a> <span class="hljs-attribute">xmlns:web=<span class="hljs-value">“<a href="http://java.sun.com/xml/ns/javaee/web-app_2_5.xsd&quot;" target="_blank" rel="noopener">http://java.sun.com/xml/ns/javaee/web-app_2_5.xsd&quot;</a><br>        <span class="hljs-attribute">xsi:schemaLocation=<span class="hljs-value">“<a href="http://java.sun.com/xml/ns/javaee" target="_blank" rel="noopener">http://java.sun.com/xml/ns/javaee</a><br>        <a href="http://java.sun.com/xml/ns/javaee/web-app_2_5.xsd&quot;" target="_blank" rel="noopener">http://java.sun.com/xml/ns/javaee/web-app_2_5.xsd&quot;</a><br>        <span class="hljs-attribute">id=<span class="hljs-value">“WebApp_ActivitiDemo2” <span class="hljs-attribute">version=<span class="hljs-value">“2.5”&gt;<br>        <span class="hljs-tag">&lt;<span class="hljs-title">display-name&gt;ActivitiDemo2<span class="hljs-tag">&lt;/<span class="hljs-title">display-name&gt;</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></code></p>
<pre><code>    &lt;span class=&quot;hljs-comment&quot;&gt;&lt;!-- 监听： 在启动Web 容器时，自动装配Spring applicationContext.xml 的配置信息 --&gt;
    &lt;span class=&quot;hljs-tag&quot;&gt;&lt;&lt;span class=&quot;hljs-title&quot;&gt;listener&gt;
        &lt;span class=&quot;hljs-tag&quot;&gt;&lt;&lt;span class=&quot;hljs-title&quot;&gt;listener-class&gt;org.springframework.web.context.ContextLoaderListener&lt;span class=&quot;hljs-tag&quot;&gt;&lt;/&lt;span class=&quot;hljs-title&quot;&gt;listener-class&gt;
    &lt;span class=&quot;hljs-tag&quot;&gt;&lt;/&lt;span class=&quot;hljs-title&quot;&gt;listener&gt;
    &lt;span class=&quot;hljs-comment&quot;&gt;&lt;!-- 加载spring主配置文件 --&gt;
    &lt;span class=&quot;hljs-tag&quot;&gt;&lt;&lt;span class=&quot;hljs-title&quot;&gt;context-param&gt;
        &lt;span class=&quot;hljs-tag&quot;&gt;&lt;&lt;span class=&quot;hljs-title&quot;&gt;param-name&gt;contextConfigLocation&lt;span class=&quot;hljs-tag&quot;&gt;&lt;/&lt;span class=&quot;hljs-title&quot;&gt;param-name&gt;
        &lt;span class=&quot;hljs-tag&quot;&gt;&lt;&lt;span class=&quot;hljs-title&quot;&gt;param-value&gt;classpath:config/applicationContext.xml&lt;span class=&quot;hljs-tag&quot;&gt;&lt;/&lt;span class=&quot;hljs-title&quot;&gt;param-value&gt;
    &lt;span class=&quot;hljs-tag&quot;&gt;&lt;/&lt;span class=&quot;hljs-title&quot;&gt;context-param&gt;
    &lt;span class=&quot;hljs-comment&quot;&gt;&lt;!-- 配置spring拦截器 --&gt;
    &lt;span class=&quot;hljs-tag&quot;&gt;&lt;&lt;span class=&quot;hljs-title&quot;&gt;servlet&gt;
        &lt;span class=&quot;hljs-tag&quot;&gt;&lt;&lt;span class=&quot;hljs-title&quot;&gt;servlet-name&gt;springMvc&lt;span class=&quot;hljs-tag&quot;&gt;&lt;/&lt;span class=&quot;hljs-title&quot;&gt;servlet-name&gt;
        &lt;span class=&quot;hljs-tag&quot;&gt;&lt;&lt;span class=&quot;hljs-title&quot;&gt;servlet-class&gt;org.springframework.web.servlet.DispatcherServlet&lt;span class=&quot;hljs-tag&quot;&gt;&lt;/&lt;span class=&quot;hljs-title&quot;&gt;servlet-class&gt;
        &lt;span class=&quot;hljs-tag&quot;&gt;&lt;&lt;span class=&quot;hljs-title&quot;&gt;init-param&gt;
            &lt;span class=&quot;hljs-tag&quot;&gt;&lt;&lt;span class=&quot;hljs-title&quot;&gt;param-name&gt;contextConfigLocation&lt;span class=&quot;hljs-tag&quot;&gt;&lt;/&lt;span class=&quot;hljs-title&quot;&gt;param-name&gt;
            &lt;span class=&quot;hljs-comment&quot;&gt;&lt;!-- 配置请求路径 --&gt;
            &lt;span class=&quot;hljs-tag&quot;&gt;&lt;&lt;span class=&quot;hljs-title&quot;&gt;param-value&gt;classpath:config/spring-servlet.xml&lt;span class=&quot;hljs-tag&quot;&gt;&lt;/&lt;span class=&quot;hljs-title&quot;&gt;param-value&gt;
        &lt;span class=&quot;hljs-tag&quot;&gt;&lt;/&lt;span class=&quot;hljs-title&quot;&gt;init-param&gt;
        &lt;span class=&quot;hljs-tag&quot;&gt;&lt;&lt;span class=&quot;hljs-title&quot;&gt;load-on-startup&gt;1&lt;span class=&quot;hljs-tag&quot;&gt;&lt;/&lt;span class=&quot;hljs-title&quot;&gt;load-on-startup&gt;&lt;span class=&quot;hljs-comment&quot;&gt;&lt;!-- load-on-startup必须放在最后 --&gt;
    &lt;span class=&quot;hljs-tag&quot;&gt;&lt;/&lt;span class=&quot;hljs-title&quot;&gt;servlet&gt;
    &lt;span class=&quot;hljs-tag&quot;&gt;&lt;&lt;span class=&quot;hljs-title&quot;&gt;servlet-mapping&gt;
        &lt;span class=&quot;hljs-tag&quot;&gt;&lt;&lt;span class=&quot;hljs-title&quot;&gt;servlet-name&gt;springMvc&lt;span class=&quot;hljs-tag&quot;&gt;&lt;/&lt;span class=&quot;hljs-title&quot;&gt;servlet-name&gt;
        &lt;span class=&quot;hljs-tag&quot;&gt;&lt;&lt;span class=&quot;hljs-title&quot;&gt;url-pattern&gt;/&lt;span class=&quot;hljs-tag&quot;&gt;&lt;/&lt;span class=&quot;hljs-title&quot;&gt;url-pattern&gt;
    &lt;span class=&quot;hljs-tag&quot;&gt;&lt;/&lt;span class=&quot;hljs-title&quot;&gt;servlet-mapping&gt;
    &lt;span class=&quot;hljs-comment&quot;&gt;&lt;!-- 转换为UTF-8编码 --&gt;
    &lt;span class=&quot;hljs-tag&quot;&gt;&lt;&lt;span class=&quot;hljs-title&quot;&gt;filter&gt;
        &lt;span class=&quot;hljs-tag&quot;&gt;&lt;&lt;span class=&quot;hljs-title&quot;&gt;filter-name&gt;itxxzEncoding&lt;span class=&quot;hljs-tag&quot;&gt;&lt;/&lt;span class=&quot;hljs-title&quot;&gt;filter-name&gt;
        &lt;span class=&quot;hljs-tag&quot;&gt;&lt;&lt;span class=&quot;hljs-title&quot;&gt;filter-class&gt;org.springframework.web.filter.CharacterEncodingFilter&lt;span class=&quot;hljs-tag&quot;&gt;&lt;/&lt;span class=&quot;hljs-title&quot;&gt;filter-class&gt;
        &lt;span class=&quot;hljs-tag&quot;&gt;&lt;&lt;span class=&quot;hljs-title&quot;&gt;init-param&gt;
            &lt;span class=&quot;hljs-tag&quot;&gt;&lt;&lt;span class=&quot;hljs-title&quot;&gt;param-name&gt;encoding&lt;span class=&quot;hljs-tag&quot;&gt;&lt;/&lt;span class=&quot;hljs-title&quot;&gt;param-name&gt;
            &lt;span class=&quot;hljs-tag&quot;&gt;&lt;&lt;span class=&quot;hljs-title&quot;&gt;param-value&gt;UTF-8&lt;span class=&quot;hljs-tag&quot;&gt;&lt;/&lt;span class=&quot;hljs-title&quot;&gt;param-value&gt;
        &lt;span class=&quot;hljs-tag&quot;&gt;&lt;/&lt;span class=&quot;hljs-title&quot;&gt;init-param&gt;
        &lt;span class=&quot;hljs-tag&quot;&gt;&lt;&lt;span class=&quot;hljs-title&quot;&gt;init-param&gt;
            &lt;span class=&quot;hljs-tag&quot;&gt;&lt;&lt;span class=&quot;hljs-title&quot;&gt;param-name&gt;forceEncoding&lt;span class=&quot;hljs-tag&quot;&gt;&lt;/&lt;span class=&quot;hljs-title&quot;&gt;param-name&gt;
            &lt;span class=&quot;hljs-tag&quot;&gt;&lt;&lt;span class=&quot;hljs-title&quot;&gt;param-value&gt;true&lt;span class=&quot;hljs-tag&quot;&gt;&lt;/&lt;span class=&quot;hljs-title&quot;&gt;param-value&gt;
        &lt;span class=&quot;hljs-tag&quot;&gt;&lt;/&lt;span class=&quot;hljs-title&quot;&gt;init-param&gt;
    &lt;span class=&quot;hljs-tag&quot;&gt;&lt;/&lt;span class=&quot;hljs-title&quot;&gt;filter&gt;
    &lt;span class=&quot;hljs-tag&quot;&gt;&lt;&lt;span class=&quot;hljs-title&quot;&gt;filter-mapping&gt;
        &lt;span class=&quot;hljs-tag&quot;&gt;&lt;&lt;span class=&quot;hljs-title&quot;&gt;filter-name&gt;itxxzEncoding&lt;span class=&quot;hljs-tag&quot;&gt;&lt;/&lt;span class=&quot;hljs-title&quot;&gt;filter-name&gt;
        &lt;span class=&quot;hljs-tag&quot;&gt;&lt;&lt;span class=&quot;hljs-title&quot;&gt;url-pattern&gt;/*&lt;span class=&quot;hljs-tag&quot;&gt;&lt;/&lt;span class=&quot;hljs-title&quot;&gt;url-pattern&gt;
    &lt;span class=&quot;hljs-tag&quot;&gt;&lt;/&lt;span class=&quot;hljs-title&quot;&gt;filter-mapping&gt;
&lt;span class=&quot;hljs-tag&quot;&gt;&lt;/&lt;span class=&quot;hljs-title&quot;&gt;web-app&gt;  &lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">### spring-servlet.xml</span><br><span class="line"></span><br><span class="line">&lt;pre class=&quot;prettyprint&quot;&gt;&lt;code class=&quot;language-xml hljs  has-numbering&quot;&gt;&lt;span class=&quot;hljs-pi&quot;&gt;&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;span class=&quot;hljs-tag&quot;&gt;&lt;&lt;span class=&quot;hljs-title&quot;&gt;beans &lt;span class=&quot;hljs-attribute&quot;&gt;xmlns=&lt;span class=&quot;hljs-value&quot;&gt;&quot;http://www.springframework.org/schema/beans&quot;</span><br><span class="line">    &lt;span class=&quot;hljs-attribute&quot;&gt;xmlns:xsi=&lt;span class=&quot;hljs-value&quot;&gt;&quot;http://www.w3.org/2001/XMLSchema-instance&quot; &lt;span class=&quot;hljs-attribute&quot;&gt;xmlns:mvc=&lt;span class=&quot;hljs-value&quot;&gt;&quot;http://www.springframework.org/schema/mvc&quot;</span><br><span class="line">    &lt;span class=&quot;hljs-attribute&quot;&gt;xmlns:context=&lt;span class=&quot;hljs-value&quot;&gt;&quot;http://www.springframework.org/schema/context&quot;</span><br><span class="line">    &lt;span class=&quot;hljs-attribute&quot;&gt;xsi:schemaLocation=&lt;span class=&quot;hljs-value&quot;&gt;&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd</span><br><span class="line">        http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd</span><br><span class="line">        http://www.springframework.org/schema/mvc http://www.springframework.org/schema/mvc/spring-mvc.xsd&quot;&gt;</span><br><span class="line"></span><br><span class="line">    &lt;span class=&quot;hljs-comment&quot;&gt;&lt;!-- 启用spring mvc 注解 --&gt;</span><br><span class="line">    &lt;span class=&quot;hljs-tag&quot;&gt;&lt;&lt;span class=&quot;hljs-title&quot;&gt;context:annotation-config /&gt;</span><br><span class="line">    &lt;span class=&quot;hljs-comment&quot;&gt;&lt;!-- 设置使用注解的类所在的jar包 controller扫描路径 --&gt;</span><br><span class="line">    &lt;span class=&quot;hljs-tag&quot;&gt;&lt;&lt;span class=&quot;hljs-title&quot;&gt;context:component-scan &lt;span class=&quot;hljs-attribute&quot;&gt;base-package=&lt;span class=&quot;hljs-value&quot;&gt;&quot;com.pzr.demo2.web.controller&quot;&gt;&lt;span class=&quot;hljs-tag&quot;&gt;&lt;/&lt;span class=&quot;hljs-title&quot;&gt;context:component-scan&gt;</span><br><span class="line"></span><br><span class="line">    &lt;span class=&quot;hljs-tag&quot;&gt;&lt;&lt;span class=&quot;hljs-title&quot;&gt;mvc:annotation-driven&gt;</span><br><span class="line">        &lt;span class=&quot;hljs-comment&quot;&gt;&lt;!-- 消息转换器，配置字符集解决乱码问题 --&gt;</span><br><span class="line">        &lt;span class=&quot;hljs-tag&quot;&gt;&lt;&lt;span class=&quot;hljs-title&quot;&gt;mvc:message-converters &lt;span class=&quot;hljs-attribute&quot;&gt;register-defaults=&lt;span class=&quot;hljs-value&quot;&gt;&quot;true&quot;&gt;</span><br><span class="line">            &lt;span class=&quot;hljs-tag&quot;&gt;&lt;&lt;span class=&quot;hljs-title&quot;&gt;bean &lt;span class=&quot;hljs-attribute&quot;&gt;class=&lt;span class=&quot;hljs-value&quot;&gt;&quot;org.springframework.http.converter.StringHttpMessageConverter&quot;&gt;</span><br><span class="line">                &lt;span class=&quot;hljs-tag&quot;&gt;&lt;&lt;span class=&quot;hljs-title&quot;&gt;property &lt;span class=&quot;hljs-attribute&quot;&gt;name=&lt;span class=&quot;hljs-value&quot;&gt;&quot;supportedMediaTypes&quot; &lt;span class=&quot;hljs-attribute&quot;&gt;value=&lt;span class=&quot;hljs-value&quot;&gt;&quot;text/html;charset=UTF-8&quot; /&gt;</span><br><span class="line">            &lt;span class=&quot;hljs-tag&quot;&gt;&lt;/&lt;span class=&quot;hljs-title&quot;&gt;bean&gt;</span><br><span class="line">        &lt;span class=&quot;hljs-tag&quot;&gt;&lt;/&lt;span class=&quot;hljs-title&quot;&gt;mvc:message-converters&gt;</span><br><span class="line">    &lt;span class=&quot;hljs-tag&quot;&gt;&lt;/&lt;span class=&quot;hljs-title&quot;&gt;mvc:annotation-driven&gt;</span><br><span class="line"></span><br><span class="line">    &lt;span class=&quot;hljs-comment&quot;&gt;&lt;!-- 使用jsp作为视图 --&gt;</span><br><span class="line">    &lt;span class=&quot;hljs-tag&quot;&gt;&lt;&lt;span class=&quot;hljs-title&quot;&gt;bean &lt;span class=&quot;hljs-attribute&quot;&gt;id=&lt;span class=&quot;hljs-value&quot;&gt;&quot;viewResolver&quot;</span><br><span class="line">        &lt;span class=&quot;hljs-attribute&quot;&gt;class=&lt;span class=&quot;hljs-value&quot;&gt;&quot;org.springframework.web.servlet.view.InternalResourceViewResolver&quot;&gt;</span><br><span class="line">        &lt;span class=&quot;hljs-tag&quot;&gt;&lt;&lt;span class=&quot;hljs-title&quot;&gt;property &lt;span class=&quot;hljs-attribute&quot;&gt;name=&lt;span class=&quot;hljs-value&quot;&gt;&quot;viewClass&quot;</span><br><span class="line">            &lt;span class=&quot;hljs-attribute&quot;&gt;value=&lt;span class=&quot;hljs-value&quot;&gt;&quot;org.springframework.web.servlet.view.JstlView&quot; /&gt;</span><br><span class="line">        &lt;span class=&quot;hljs-tag&quot;&gt;&lt;&lt;span class=&quot;hljs-title&quot;&gt;property &lt;span class=&quot;hljs-attribute&quot;&gt;name=&lt;span class=&quot;hljs-value&quot;&gt;&quot;prefix&quot; &lt;span class=&quot;hljs-attribute&quot;&gt;value=&lt;span class=&quot;hljs-value&quot;&gt;&quot;/WEB-INF/views/&quot; /&gt;</span><br><span class="line">        &lt;span class=&quot;hljs-tag&quot;&gt;&lt;&lt;span class=&quot;hljs-title&quot;&gt;property &lt;span class=&quot;hljs-attribute&quot;&gt;name=&lt;span class=&quot;hljs-value&quot;&gt;&quot;suffix&quot; &lt;span class=&quot;hljs-attribute&quot;&gt;value=&lt;span class=&quot;hljs-value&quot;&gt;&quot;.jsp&quot;&gt;&lt;span class=&quot;hljs-tag&quot;&gt;&lt;/&lt;span class=&quot;hljs-title&quot;&gt;property&gt;</span><br><span class="line">    &lt;span class=&quot;hljs-tag&quot;&gt;&lt;/&lt;span class=&quot;hljs-title&quot;&gt;bean&gt;</span><br><span class="line">&lt;span class=&quot;hljs-tag&quot;&gt;&lt;/&lt;span class=&quot;hljs-title&quot;&gt;beans&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;</span><br></pre></td></tr></table></figure>

### applicationContext.xml

&lt;pre class=&quot;prettyprint&quot;&gt;&lt;code class=&quot;language-xml hljs  has-numbering&quot;&gt;&lt;span class=&quot;hljs-pi&quot;&gt;&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;span class=&quot;hljs-tag&quot;&gt;&lt;&lt;span class=&quot;hljs-title&quot;&gt;beans &lt;span class=&quot;hljs-attribute&quot;&gt;xmlns=&lt;span class=&quot;hljs-value&quot;&gt;&quot;http://www.springframework.org/schema/beans&quot;
    &lt;span class=&quot;hljs-attribute&quot;&gt;xmlns:xsi=&lt;span class=&quot;hljs-value&quot;&gt;&quot;http://www.w3.org/2001/XMLSchema-instance&quot; &lt;span class=&quot;hljs-attribute&quot;&gt;xmlns:context=&lt;span class=&quot;hljs-value&quot;&gt;&quot;http://www.springframework.org/schema/context&quot;
    &lt;span class=&quot;hljs-attribute&quot;&gt;xmlns:aop=&lt;span class=&quot;hljs-value&quot;&gt;&quot;http://www.springframework.org/schema/aop&quot; &lt;span class=&quot;hljs-attribute&quot;&gt;xmlns:tx=&lt;span class=&quot;hljs-value&quot;&gt;&quot;http://www.springframework.org/schema/tx&quot;
    &lt;span class=&quot;hljs-attribute&quot;&gt;xsi:schemaLocation=&lt;span class=&quot;hljs-value&quot;&gt;&quot;
            http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-3.1.xsd
            http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context-3.1.xsd
            http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx-3.1.xsd
            http://www.springframework.org/schema/util http://www.springframework.org/schema/util/spring-util-3.1.xsd
            http://www.springframework.org/schema/data/jpa http://www.springframework.org/schema/data/jpa/spring-jpa-1.0.xsd
            http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd http://cxf.apache.org/jaxws http://cxf.apache.org/schemas/jaxws.xsd&quot;&gt;

    &lt;span class=&quot;hljs-tag&quot;&gt;&lt;&lt;span class=&quot;hljs-title&quot;&gt;bean &lt;span class=&quot;hljs-attribute&quot;&gt;id=&lt;span class=&quot;hljs-value&quot;&gt;&quot;dataSource&quot; &lt;span class=&quot;hljs-attribute&quot;&gt;class=&lt;span class=&quot;hljs-value&quot;&gt;&quot;org.apache.commons.dbcp.BasicDataSource&quot;
        &lt;span class=&quot;hljs-attribute&quot;&gt;destroy-method=&lt;span class=&quot;hljs-value&quot;&gt;&quot;close&quot;&gt;
        &lt;span class=&quot;hljs-tag&quot;&gt;&lt;&lt;span class=&quot;hljs-title&quot;&gt;property &lt;span class=&quot;hljs-attribute&quot;&gt;name=&lt;span class=&quot;hljs-value&quot;&gt;&quot;driverClassName&quot; &lt;span class=&quot;hljs-attribute&quot;&gt;value=&lt;span class=&quot;hljs-value&quot;&gt;&quot;com.mysql.jdbc.Driver&quot;&gt;
        &lt;span class=&quot;hljs-tag&quot;&gt;&lt;/&lt;span class=&quot;hljs-title&quot;&gt;property&gt;
        &lt;span class=&quot;hljs-tag&quot;&gt;&lt;&lt;span class=&quot;hljs-title&quot;&gt;property &lt;span class=&quot;hljs-attribute&quot;&gt;name=&lt;span class=&quot;hljs-value&quot;&gt;&quot;url&quot;&gt;
            &lt;span class=&quot;hljs-tag&quot;&gt;&lt;&lt;span class=&quot;hljs-title&quot;&gt;value&gt;jdbc:mysql://localhost:3306/actdemo1?useUnicode=true&amp;amp;characterEncoding=utf-8&lt;span class=&quot;hljs-tag&quot;&gt;&lt;/&lt;span class=&quot;hljs-title&quot;&gt;value&gt;
        &lt;span class=&quot;hljs-tag&quot;&gt;&lt;/&lt;span class=&quot;hljs-title&quot;&gt;property&gt;
        &lt;span class=&quot;hljs-tag&quot;&gt;&lt;&lt;span class=&quot;hljs-title&quot;&gt;property &lt;span class=&quot;hljs-attribute&quot;&gt;name=&lt;span class=&quot;hljs-value&quot;&gt;&quot;username&quot; &lt;span class=&quot;hljs-attribute&quot;&gt;value=&lt;span class=&quot;hljs-value&quot;&gt;&quot;root&quot;&gt;
        &lt;span class=&quot;hljs-tag&quot;&gt;&lt;/&lt;span class=&quot;hljs-title&quot;&gt;property&gt;
        &lt;span class=&quot;hljs-tag&quot;&gt;&lt;&lt;span class=&quot;hljs-title&quot;&gt;property &lt;span class=&quot;hljs-attribute&quot;&gt;name=&lt;span class=&quot;hljs-value&quot;&gt;&quot;password&quot; &lt;span class=&quot;hljs-attribute&quot;&gt;value=&lt;span class=&quot;hljs-value&quot;&gt;&quot;&quot;&gt;
        &lt;span class=&quot;hljs-tag&quot;&gt;&lt;/&lt;span class=&quot;hljs-title&quot;&gt;property&gt;
    &lt;span class=&quot;hljs-tag&quot;&gt;&lt;/&lt;span class=&quot;hljs-title&quot;&gt;bean&gt;

    &lt;span class=&quot;hljs-comment&quot;&gt;&lt;!-- 配置事务 --&gt;
    &lt;span class=&quot;hljs-tag&quot;&gt;&lt;&lt;span class=&quot;hljs-title&quot;&gt;bean &lt;span class=&quot;hljs-attribute&quot;&gt;id=&lt;span class=&quot;hljs-value&quot;&gt;&quot;txManager&quot;
        &lt;span class=&quot;hljs-attribute&quot;&gt;class=&lt;span class=&quot;hljs-value&quot;&gt;&quot;org.springframework.jdbc.datasource.DataSourceTransactionManager&quot;&gt;
        &lt;span class=&quot;hljs-tag&quot;&gt;&lt;&lt;span class=&quot;hljs-title&quot;&gt;property &lt;span class=&quot;hljs-attribute&quot;&gt;name=&lt;span class=&quot;hljs-value&quot;&gt;&quot;dataSource&quot; &lt;span class=&quot;hljs-attribute&quot;&gt;ref=&lt;span class=&quot;hljs-value&quot;&gt;&quot;dataSource&quot;&gt;&lt;span class=&quot;hljs-tag&quot;&gt;&lt;/&lt;span class=&quot;hljs-title&quot;&gt;property&gt;
    &lt;span class=&quot;hljs-tag&quot;&gt;&lt;/&lt;span class=&quot;hljs-title&quot;&gt;bean&gt;

    &lt;span class=&quot;hljs-comment&quot;&gt;&lt;!--使用基于注解方式配置事务 --&gt;
    &lt;span class=&quot;hljs-tag&quot;&gt;&lt;&lt;span class=&quot;hljs-title&quot;&gt;tx:annotation-driven &lt;span class=&quot;hljs-attribute&quot;&gt;transaction-manager=&lt;span class=&quot;hljs-value&quot;&gt;&quot;txManager&quot; /&gt;

    &lt;span class=&quot;hljs-comment&quot;&gt;&lt;!-- activiti事务管理 --&gt;
    &lt;span class=&quot;hljs-tag&quot;&gt;&lt;&lt;span class=&quot;hljs-title&quot;&gt;bean &lt;span class=&quot;hljs-attribute&quot;&gt;id=&lt;span class=&quot;hljs-value&quot;&gt;&quot;transactionManager&quot;
        &lt;span class=&quot;hljs-attribute&quot;&gt;class=&lt;span class=&quot;hljs-value&quot;&gt;&quot;org.springframework.jdbc.datasource.DataSourceTransactionManager&quot;&gt;
        &lt;span class=&quot;hljs-tag&quot;&gt;&lt;&lt;span class=&quot;hljs-title&quot;&gt;property &lt;span class=&quot;hljs-attribute&quot;&gt;name=&lt;span class=&quot;hljs-value&quot;&gt;&quot;dataSource&quot; &lt;span class=&quot;hljs-attribute&quot;&gt;ref=&lt;span class=&quot;hljs-value&quot;&gt;&quot;dataSource&quot; /&gt;
    &lt;span class=&quot;hljs-tag&quot;&gt;&lt;/&lt;span class=&quot;hljs-title&quot;&gt;bean&gt;

    &lt;span class=&quot;hljs-comment&quot;&gt;&lt;!-- 加载activiti引擎 --&gt;
    &lt;span class=&quot;hljs-tag&quot;&gt;&lt;&lt;span class=&quot;hljs-title&quot;&gt;bean &lt;span class=&quot;hljs-attribute&quot;&gt;id=&lt;span class=&quot;hljs-value&quot;&gt;&quot;processEngine&quot; &lt;span class=&quot;hljs-attribute&quot;&gt;class=&lt;span class=&quot;hljs-value&quot;&gt;&quot;org.activiti.spring.ProcessEngineFactoryBean&quot;&gt;
        &lt;span class=&quot;hljs-tag&quot;&gt;&lt;&lt;span class=&quot;hljs-title&quot;&gt;property &lt;span class=&quot;hljs-attribute&quot;&gt;name=&lt;span class=&quot;hljs-value&quot;&gt;&quot;processEngineConfiguration&quot; &lt;span class=&quot;hljs-attribute&quot;&gt;ref=&lt;span class=&quot;hljs-value&quot;&gt;&quot;processEngineConfiguration&quot; /&gt;
    &lt;span class=&quot;hljs-tag&quot;&gt;&lt;/&lt;span class=&quot;hljs-title&quot;&gt;bean&gt;
    &lt;span class=&quot;hljs-tag&quot;&gt;&lt;&lt;span class=&quot;hljs-title&quot;&gt;bean &lt;span class=&quot;hljs-attribute&quot;&gt;id=&lt;span class=&quot;hljs-value&quot;&gt;&quot;processEngineConfiguration&quot; &lt;span class=&quot;hljs-attribute&quot;&gt;class=&lt;span class=&quot;hljs-value&quot;&gt;&quot;org.activiti.spring.SpringProcessEngineConfiguration&quot;&gt;
        &lt;span class=&quot;hljs-tag&quot;&gt;&lt;&lt;span class=&quot;hljs-title&quot;&gt;property &lt;span class=&quot;hljs-attribute&quot;&gt;name=&lt;span class=&quot;hljs-value&quot;&gt;&quot;dataSource&quot; &lt;span class=&quot;hljs-attribute&quot;&gt;ref=&lt;span class=&quot;hljs-value&quot;&gt;&quot;dataSource&quot; /&gt;
        &lt;span class=&quot;hljs-tag&quot;&gt;&lt;&lt;span class=&quot;hljs-title&quot;&gt;property &lt;span class=&quot;hljs-attribute&quot;&gt;name=&lt;span class=&quot;hljs-value&quot;&gt;&quot;transactionManager&quot; &lt;span class=&quot;hljs-attribute&quot;&gt;ref=&lt;span class=&quot;hljs-value&quot;&gt;&quot;transactionManager&quot; /&gt;
        &lt;span class=&quot;hljs-tag&quot;&gt;&lt;&lt;span class=&quot;hljs-title&quot;&gt;property &lt;span class=&quot;hljs-attribute&quot;&gt;name=&lt;span class=&quot;hljs-value&quot;&gt;&quot;databaseSchemaUpdate&quot; &lt;span class=&quot;hljs-attribute&quot;&gt;value=&lt;span class=&quot;hljs-value&quot;&gt;&quot;true&quot; /&gt;
        &lt;span class=&quot;hljs-tag&quot;&gt;&lt;&lt;span class=&quot;hljs-title&quot;&gt;property &lt;span class=&quot;hljs-attribute&quot;&gt;name=&lt;span class=&quot;hljs-value&quot;&gt;&quot;jobExecutorActivate&quot; &lt;span class=&quot;hljs-attribute&quot;&gt;value=&lt;span class=&quot;hljs-value&quot;&gt;&quot;false&quot; /&gt;
    &lt;span class=&quot;hljs-tag&quot;&gt;&lt;/&lt;span class=&quot;hljs-title&quot;&gt;bean&gt;

    &lt;span class=&quot;hljs-comment&quot;&gt;&lt;!-- activiti的各种服务接口 --&gt;
    &lt;span class=&quot;hljs-tag&quot;&gt;&lt;&lt;span class=&quot;hljs-title&quot;&gt;bean &lt;span class=&quot;hljs-attribute&quot;&gt;id=&lt;span class=&quot;hljs-value&quot;&gt;&quot;repositoryService&quot; &lt;span class=&quot;hljs-attribute&quot;&gt;factory-bean=&lt;span class=&quot;hljs-value&quot;&gt;&quot;processEngine&quot;
        &lt;span class=&quot;hljs-attribute&quot;&gt;factory-method=&lt;span class=&quot;hljs-value&quot;&gt;&quot;getRepositoryService&quot; /&gt;
    &lt;span class=&quot;hljs-tag&quot;&gt;&lt;&lt;span class=&quot;hljs-title&quot;&gt;bean &lt;span class=&quot;hljs-attribute&quot;&gt;id=&lt;span class=&quot;hljs-value&quot;&gt;&quot;runtimeService&quot; &lt;span class=&quot;hljs-attribute&quot;&gt;factory-bean=&lt;span class=&quot;hljs-value&quot;&gt;&quot;processEngine&quot;
        &lt;span class=&quot;hljs-attribute&quot;&gt;factory-method=&lt;span class=&quot;hljs-value&quot;&gt;&quot;getRuntimeService&quot; /&gt;
    &lt;span class=&quot;hljs-tag&quot;&gt;&lt;&lt;span class=&quot;hljs-title&quot;&gt;bean &lt;span class=&quot;hljs-attribute&quot;&gt;id=&lt;span class=&quot;hljs-value&quot;&gt;&quot;taskService&quot; &lt;span class=&quot;hljs-attribute&quot;&gt;factory-bean=&lt;span class=&quot;hljs-value&quot;&gt;&quot;processEngine&quot;
        &lt;span class=&quot;hljs-attribute&quot;&gt;factory-method=&lt;span class=&quot;hljs-value&quot;&gt;&quot;getTaskService&quot; /&gt;
    &lt;span class=&quot;hljs-tag&quot;&gt;&lt;&lt;span class=&quot;hljs-title&quot;&gt;bean &lt;span class=&quot;hljs-attribute&quot;&gt;id=&lt;span class=&quot;hljs-value&quot;&gt;&quot;historyService&quot; &lt;span class=&quot;hljs-attribute&quot;&gt;factory-bean=&lt;span class=&quot;hljs-value&quot;&gt;&quot;processEngine&quot;
        &lt;span class=&quot;hljs-attribute&quot;&gt;factory-method=&lt;span class=&quot;hljs-value&quot;&gt;&quot;getHistoryService&quot; /&gt;
    &lt;span class=&quot;hljs-tag&quot;&gt;&lt;&lt;span class=&quot;hljs-title&quot;&gt;bean &lt;span class=&quot;hljs-attribute&quot;&gt;id=&lt;span class=&quot;hljs-value&quot;&gt;&quot;managementService&quot; &lt;span class=&quot;hljs-attribute&quot;&gt;factory-bean=&lt;span class=&quot;hljs-value&quot;&gt;&quot;processEngine&quot;
        &lt;span class=&quot;hljs-attribute&quot;&gt;factory-method=&lt;span class=&quot;hljs-value&quot;&gt;&quot;getManagementService&quot; /&gt;
&lt;span class=&quot;hljs-tag&quot;&gt;&lt;/&lt;span class=&quot;hljs-title&quot;&gt;beans&gt;  &lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">    ## 示例代码</span><br><span class="line"></span><br><span class="line">编写一个controller来调用接口</span><br><span class="line"></span><br><span class="line">    ### FirstController.java</span><br><span class="line"></span><br><span class="line">    &lt;pre class=&quot;prettyprint&quot;&gt;&lt;code class=&quot;language-java hljs  has-numbering&quot;&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;package com.pzr.demo2.web.controller;</span><br><span class="line"></span><br><span class="line">    &lt;span class=&quot;hljs-keyword&quot;&gt;import java.util.List;</span><br><span class="line"></span><br><span class="line">    &lt;span class=&quot;hljs-keyword&quot;&gt;import org.activiti.engine.ProcessEngine;</span><br><span class="line">    &lt;span class=&quot;hljs-keyword&quot;&gt;import org.activiti.engine.ProcessEngines;</span><br><span class="line">    &lt;span class=&quot;hljs-keyword&quot;&gt;import org.activiti.engine.RepositoryService;</span><br><span class="line">    &lt;span class=&quot;hljs-keyword&quot;&gt;import org.activiti.engine.RuntimeService;</span><br><span class="line">    &lt;span class=&quot;hljs-keyword&quot;&gt;import org.activiti.engine.TaskService;</span><br><span class="line">    &lt;span class=&quot;hljs-keyword&quot;&gt;import org.activiti.engine.task.Task;</span><br><span class="line">    &lt;span class=&quot;hljs-keyword&quot;&gt;import org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line">    &lt;span class=&quot;hljs-keyword&quot;&gt;import org.springframework.stereotype.Controller;</span><br><span class="line">    &lt;span class=&quot;hljs-keyword&quot;&gt;import org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line">    &lt;span class=&quot;hljs-keyword&quot;&gt;import org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"></span><br><span class="line">    &lt;span class=&quot;hljs-annotation&quot;&gt;@Controller</span><br><span class="line">    &lt;span class=&quot;hljs-annotation&quot;&gt;@RequestMapping(value = &lt;span class=&quot;hljs-string&quot;&gt;&quot;/first&quot;)</span><br><span class="line">    &lt;span class=&quot;hljs-keyword&quot;&gt;public &lt;span class=&quot;hljs-class&quot;&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;class &lt;span class=&quot;hljs-title&quot;&gt;FirstController &#123;</span><br><span class="line"></span><br><span class="line">        &lt;span class=&quot;hljs-annotation&quot;&gt;@RequestMapping(value = &lt;span class=&quot;hljs-string&quot;&gt;&quot;/test1&quot;)</span><br><span class="line">        &lt;span class=&quot;hljs-annotation&quot;&gt;@ResponseBody</span><br><span class="line">        &lt;span class=&quot;hljs-keyword&quot;&gt;public String &lt;span class=&quot;hljs-title&quot;&gt;test()&#123;</span><br><span class="line">            &lt;span class=&quot;hljs-comment&quot;&gt;// 加载配置文件activiti.cfg.xml，创建引擎，如果出现null，可能原因</span><br><span class="line">            &lt;span class=&quot;hljs-comment&quot;&gt;//1.加载路径不是根目录。</span><br><span class="line">            &lt;span class=&quot;hljs-comment&quot;&gt;//2.依赖包不完全</span><br><span class="line">            &lt;span class=&quot;hljs-comment&quot;&gt;// 获取配置文件后，引擎开始创建数据库。</span><br><span class="line">            ProcessEngine engine = ProcessEngines.getDefaultProcessEngine();</span><br><span class="line">            &lt;span class=&quot;hljs-comment&quot;&gt;// 获取流程储存服务组件</span><br><span class="line">            RepositoryService rs = engine.getRepositoryService();</span><br><span class="line">            &lt;span class=&quot;hljs-comment&quot;&gt;// 获取运行时服务组件</span><br><span class="line">            RuntimeService rse = engine.getRuntimeService();</span><br><span class="line">            &lt;span class=&quot;hljs-comment&quot;&gt;// 获取流程中的任务TASK组件</span><br><span class="line">            TaskService ts = engine.getTaskService();</span><br><span class="line">            &lt;span class=&quot;hljs-comment&quot;&gt;// 部署流程，只要是符合BPMN2规范的XML文件，理论上都可以被ACTIVITI部署</span><br><span class="line">            rs.createDeployment().addClasspathResource(&lt;span class=&quot;hljs-string&quot;&gt;&quot;com/pzr/demo2/diagrams/MyProcess.bpmn&quot;).deploy();</span><br><span class="line">            &lt;span class=&quot;hljs-comment&quot;&gt;// 开启流程，myprocess是流程的ID</span><br><span class="line">            rse.startProcessInstanceByKey(&lt;span class=&quot;hljs-string&quot;&gt;&quot;myProcess&quot;);</span><br><span class="line">            &lt;span class=&quot;hljs-comment&quot;&gt;// 查询历史表中的Task</span><br><span class="line">            List&lt;Task&gt; task = ts.createTaskQuery().list();</span><br><span class="line">            Task task1 = task.get(task.size()-&lt;span class=&quot;hljs-number&quot;&gt;1);</span><br><span class="line">            System.out.println(&lt;span class=&quot;hljs-string&quot;&gt;&quot;第一环节：&quot;+task1);</span><br><span class="line">            System.out.println(&lt;span class=&quot;hljs-string&quot;&gt;&quot;推动流程到下一环节：&quot;+task1);</span><br><span class="line">            ts.complete(task1.getId());</span><br><span class="line">            task1 = ts.createTaskQuery().executionId(task1.getExecutionId()).singleResult();</span><br><span class="line">            System.out.println(&lt;span class=&quot;hljs-string&quot;&gt;&quot;第二环节：&quot; + task1);</span><br><span class="line">            &lt;span class=&quot;hljs-keyword&quot;&gt;return &lt;span class=&quot;hljs-string&quot;&gt;&quot;测试成功&quot;;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        &lt;span class=&quot;hljs-annotation&quot;&gt;@Autowired</span><br><span class="line">        RepositoryService repositoryService;</span><br><span class="line">        &lt;span class=&quot;hljs-annotation&quot;&gt;@Autowired</span><br><span class="line">        RuntimeService runtimeService;</span><br><span class="line">        &lt;span class=&quot;hljs-annotation&quot;&gt;@Autowired</span><br><span class="line">        TaskService taskService;</span><br><span class="line"></span><br><span class="line">        &lt;span class=&quot;hljs-annotation&quot;&gt;@RequestMapping(value = &lt;span class=&quot;hljs-string&quot;&gt;&quot;/test2&quot;)</span><br><span class="line">        &lt;span class=&quot;hljs-annotation&quot;&gt;@ResponseBody</span><br><span class="line">        &lt;span class=&quot;hljs-keyword&quot;&gt;public String &lt;span class=&quot;hljs-title&quot;&gt;test2()&#123;</span><br><span class="line">            StringBuffer sb = &lt;span class=&quot;hljs-keyword&quot;&gt;new StringBuffer();</span><br><span class="line">            &lt;span class=&quot;hljs-comment&quot;&gt;// 部署流程，只要是符合BPMN2规范的XML文件，理论上都可以被ACTIVITI部署</span><br><span class="line">            repositoryService.createDeployment().addClasspathResource(&lt;span class=&quot;hljs-string&quot;&gt;&quot;com/pzr/demo2/diagrams/MyProcess.bpmn&quot;).deploy();</span><br><span class="line">            &lt;span class=&quot;hljs-comment&quot;&gt;// 开启流程，myprocess是流程的ID</span><br><span class="line">            runtimeService.startProcessInstanceByKey(&lt;span class=&quot;hljs-string&quot;&gt;&quot;myProcess&quot;);</span><br><span class="line">            &lt;span class=&quot;hljs-comment&quot;&gt;// 查询历史表中的Task</span><br><span class="line">            List&lt;Task&gt; task = taskService.createTaskQuery().list();</span><br><span class="line">            Task task1 = task.get(task.size()-&lt;span class=&quot;hljs-number&quot;&gt;1);</span><br><span class="line">            sb.append(&lt;span class=&quot;hljs-string&quot;&gt;&quot;第一环节：&quot;+task1 +&lt;span class=&quot;hljs-string&quot;&gt;&quot;&lt;br/&gt;&quot;);</span><br><span class="line">            sb.append(&lt;span class=&quot;hljs-string&quot;&gt;&quot;推动流程到下一环节：&quot;+task1+&lt;span class=&quot;hljs-string&quot;&gt;&quot;&lt;br/&gt;&quot;);</span><br><span class="line">            taskService.complete(task1.getId());</span><br><span class="line">            task1 = taskService.createTaskQuery().executionId(task1.getExecutionId()).singleResult();</span><br><span class="line">            sb.append(&lt;span class=&quot;hljs-string&quot;&gt;&quot;第二环节：&quot; + task1+&lt;span class=&quot;hljs-string&quot;&gt;&quot;&lt;br/&gt;&quot;);</span><br><span class="line">            &lt;span class=&quot;hljs-keyword&quot;&gt;return sb.toString();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    &lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;</span><br></pre></td></tr></table></figure>
</code></pre><p>其中test1()和test2()是作为对比的，test2()中接口全是用注入的方式使用的 </p>
<p>把项目部署到tomcat中<br>启动项目，会自动建表<br>在浏览器运行<a href="http://localhost:8080/ActivitiDemo2/first/test2" target="_blank" rel="noopener">http://localhost:8080/ActivitiDemo2/first/test2</a><br>结果如下图：<br><img src="http://i.imgur.com/sKeow7G.png" alt=""></p>
<pre><code>## 示例下载
</code></pre><p><a href="http://pan.baidu.com/s/1o8D3H5S" target="_blank" rel="noopener">点击下载</a></p>
<pre><code>## 出现问题

### Cannot create PoolableConnectionFactory (Unsupported character encoding ‘utf-8’.)
</code></pre><p>出现原因，将xml格式化化后，导致数据库配置部分出现换行<br>正常样子：<br><img src="http://i.imgur.com/QXiShq2.png" alt=""><br>格式化后（错误）样子：<br><img src="http://i.imgur.com/YQMBXcy.png" alt=""><br>还原成正常样子即可解决问题<br></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://pangguoming.com/post/b467331a.html">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="庞国明">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars0.githubusercontent.com/u/7269202?s=460&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="庞国明-博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/post/b467331a.html" itemprop="url">Quzrtz的使用</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-12-11T18:06:00+08:00">
                2017-12-11
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <div><br><div><br><br><strong>使用**</strong>SimpleTrigger*<em><br><br>SimpleTrigger拥有多个重载的构造函数，用以在不同场合下构造出对应的实例： 

</em>   SimpleTrigger(String name, String group)：通过该构造函数指定Trigger所属组和名称；<br><em>   SimpleTrigger(String name, String group, Date startTime)：除指定Trigger所属组和名称外，还可以指定触发的开发时间；
</em>   SimpleTrigger(String name, String group, Date startTime, Date endTime, int repeatCount, long repeatInterval)：除指定以上信息外，还可以指定结束时间、重复执行次数、时间间隔等参数；<br>*   SimpleTrigger(String name, String group, String jobName, String jobGroup, Date startTime, Date endTime, int repeatCount, long repeatInterval)：这是最复杂的一个构造函数，在指定触发参数的同时，还通过jobGroup和jobName，让该Trigger和 Scheduler中的某个任务关联起来。<br><br>通过实现 org.quartz.Job 接口，可以使 Java 类化身为可调度的任务。代码清单1提供了 Quartz 任务的一个示例：<br><br>代码清单1   SimpleJob：简单的Job实现类<br><br>&gt; <div><br>&gt; <div><br>&gt; <div>import java.util.Date;<br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div>import org.quartz.Job;<br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div>import org.quartz.JobExecutionContext;<br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div>import org.quartz.JobExecutionException;<br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div>public class SimpleJob implements Job {<br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div>①实例Job接口方法<br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div>public void  execute(JobExecutionContext jobCtx) throws JobExecutionException {<br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div>    System.out.println(jobCtx.getTrigger().getName()+ “ triggered. time is:” + (new Date()));<br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div>    }<br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div>}<br>&gt;<br>&gt; </div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div>

<div><br><div><br><div><br><br>这个类用一条非常简单的输出语句实现了Job接口的execute(JobExecutionContext context) 方法，这个方法可以包含想要执行的<br><br>任何代码。<br><br>下面，我们通过SimpleTrigger对SimpleJob进行调度：<br><br>代码清单2  <strong>SimpleTriggerRunner</strong>：使用SimpleTrigger进行调度<br><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt;<br>&gt; import java.util.Date;<br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt;<br>&gt; import org.quartz.JobDetail;<br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt;<br>&gt; import org.quartz.Scheduler;<br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt;<br>&gt; import org.quartz.SchedulerFactory;<br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt;<br>&gt; import org.quartz.SimpleTrigger;<br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt;<br>&gt; import org.quartz.impl.StdSchedulerFactory;<br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div>public class SimpleTriggerRunner {<br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div>    public static void main(String[] args) {<br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div>        try {<br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div>            // ① 创建一个JobDetail实例，指定SimpleJob<br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div>            JobDetail jobDetail = new JobDetail(“job1_1”, “jGroup1”, SimpleJob.class);<br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div>            // ② 通过SimpleTrigger定义调度规则：马上启动，每2秒运行一次，共运行100次<br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div>            SimpleTrigger simpleTrigger = new SimpleTrigger(“trigger1_1”, “tgroup1”);<br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div>            simpleTrigger.setStartTime(new Date());<br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div>            simpleTrigger.setRepeatInterval(2000);<br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div>            simpleTrigger.setRepeatCount(100);<br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div>            // ③ 通过SchedulerFactory获取一个调度器实例<br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div>            SchedulerFactory schedulerFactory = new StdSchedulerFactory();<br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div>            Scheduler scheduler = schedulerFactory.getScheduler();<br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div>            // ④ 注册并进行调度<br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div>            scheduler.scheduleJob(jobDetail, simpleTrigger);<br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div>            // ⑤ 调度启动<br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div>            scheduler.start();<br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div>        } catch (Exception e) {<br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div>            e.printStackTrace();<br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div>        }<br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div>    }<br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div>}<br>&gt;<br>&gt; </div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div>

<div><br><div><br><div><br><br>首先在①处通过JobDetail封装SimpleJob，同时指定Job在Scheduler中所属组及名称，这里，组名为jGroup1，而名称为job1_1。<br><br>在②处创建一个SimpleTrigger实例，指定该Trigger在Scheduler中所属组及名称。接着设置调度的时间规则。 最后，需要创建Scheduler实例，并将JobDetail和Trigger实例注册到Scheduler中。这里，我们通过 StdSchedulerFactory获取一个Scheduler实例，并通过scheduleJob(JobDetail jobDetail, Trigger trigger)完成两件事：<br><br>1.  将JobDetail和Trigger注册到Scheduler中；<br>2.  将Trigger指派给JobDetail，将两者关联起来。<br><br>当Scheduler启动后，Trigger将定期触发并执行SimpleJob的execute(JobExecutionContext jobCtx)方法，然后每 10 秒重复一次，直到任务被执行 100 次后停止。还可以通过<strong>SimpleTrigger</strong>的<strong>setStartTime</strong>(java.util.Date startTime)和<strong>setEndTime</strong>(java.util.Date endTime)指定运行的时间范围，当运行次数和时间范围冲突时，超过时间范围的任务运行不被执行。如可以通过impleTrigger.setStartTime(new Date(System.currentTimeMillis() + 60000L))指定60秒钟以后开始。除了通过scheduleJob(jobDetail, simpleTrigger)建立Trigger和JobDetail的关联，还有另外一种关联Trigger和JobDetail的方式：<br><br>&gt; <div><br>&gt; <div><br>&gt; <div>JobDetail jobDetail = new JobDetail(“job1_1”, “jGroup1”, SimpleJob.class);<br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div>            SimpleTrigger simpleTrigger = new SimpleTrigger(“trigger1_1”, “tgroup1”);<br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div>            simpleTrigger.setJobGroup(“jGroup1”); // ①-1：指定关联的Job组名<br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div>            simpleTrigger.setJobName(“job1_1”);// ①-2：指定关联的Job名称<br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div>            scheduler.addJob(jobDetail, true);// ② 注册JobDetail<br>&gt;<br>&gt; </div></div></div></div></div></div></div></div></div></div></div></div></div></div></div>

<blockquote>
<blockquote>  scheduler.scheduleJob(simpleTrigger);//③ 注册指定了关联JobDetail的Trigger</blockquote>
</blockquote>
<div><br><div><br><br>在这种方式中，Trigger通过指定Job所属组及Job名称，然后使用Scheduler的<strong>scheduleJob(Trigger trigger)</strong>方法注册Trigger。有两个值得注意的地方： 通过这种方式注册的Trigger实例必须已经指定Job组和Job名称，否则调用注册Trigger的方法将抛出异常；引用的JobDetail对象必须已经存在于Scheduler中。也即，代码中①、②和③的先后顺序不能互换。<br><br>在构造Trigger实例时，可以考虑使用<strong>org.quartz.TriggerUtils</strong>工具类，该工具类不但提供了众多获取特定时间的方法，还拥有众多获取常见Trigger的方法，如makeSecondlyTrigger(String trigName)方法将创建一个每秒执行一次的Trigger，而<br><br>makeWeeklyTrigger(String trigName, int dayOfWeek, int hour, int minute)将创建一个每星期某一特定时间点执行一次的<br><br>Trigger。而getEvenMinuteDate(Date date)方法将返回某一时间点一分钟以后的时间。<br><br><strong>使用CronTrigger </strong><br><br><strong>CronTrigger </strong>能够提供比 <strong>SimpleTrigger </strong>更有具体实际意义的调度方案，调度规则基于 Cron 表达式，CronTrigger 支持日历相关的重复时间间隔（比如每月第一个周一执行），而不是简单的周期时间间隔。因此，相对于SimpleTrigger而言，CronTrigger在使用上也要复杂一些。<br><br><strong>Cron表达式</strong><br><br>Quartz使用类似于Linux下的Cron表达式定义时间规则，Cron表达式由6或7个由空格分隔的时间字段组成，如下所示：<br><br><em>Cron表达式时间字段表</em><br><br><table border="1" cellspacing="0" cellpadding="2"><br><tbody><br><tr><br><td valign="top"><br><div>位置<br></div></td><br><td valign="top"><br><div>时间域名<br></div></td><br><td valign="top"><br><div>允许值<br></div></td><br><td valign="top"><br><div>允许的特殊字符<br></div></td><br></tr><br><tr><br><td valign="top"><br><div>1<br></div></td><br><td valign="top"><br><div>秒<br></div></td><br><td valign="top"><br><div>0-59<br></div></td><br><td valign="top"><br><div>,  -  <em>  /<br></em></div></td><br></tr><br><tr><br><td valign="top"><br><div>2<br></div></td><br><td valign="top"><br><div>分钟<br></div></td><br><td valign="top"><br><div>0-59<br></div></td><br><td valign="top"><br><div>,  -    /<br></div></td><br></tr><br><tr><br><td valign="top"><br><div>3<br></div></td><br><td valign="top"><br><div>小时<br></div></td><br><td valign="top"><br><div>0-23<br></div></td><br><td valign="top"><br><div>,  -  <em>  /<br></em></div></td><br></tr><br><tr><br><td valign="top"><br><div>4<br></div></td><br><td valign="top"><br><div>日期<br></div></td><br><td valign="top"><br><div>1-31<br></div></td><br><td valign="top"><br><div>,  -    ?  /  L  W  C<br></div></td><br></tr><br><tr><br><td valign="top"><br><div>5<br></div></td><br><td valign="top"><br><div>月份<br></div></td><br><td valign="top"><br><div>1-12<br></div></td><br><td valign="top"><br><div>,  -  <em>  /<br></em></div></td><br></tr><br><tr><br><td valign="top"><br><div>6<br></div></td><br><td valign="top"><br><div>星期<br></div></td><br><td valign="top"><br><div>1-7<br></div></td><br><td valign="top"><br><div>,  -    ?  /  L  C  #<br></div></td><br></tr><br><tr><br><td valign="top"><br><div>7<br></div></td><br><td valign="top"><br><div>年(可选)<br></div></td><br><td valign="top"><br><div>空值1970-2099<br></div></td><br><td valign="top"><br><div>,  -  <em> /<br></em></div></td><br></tr><br></tbody><br></table><br><br>Cron表达式的时间字段除允许设置数值外，还可使用一些特殊的字符，提供列表、范围、通配符等功能，细说如下： 

   星号( <em> )：可用在所有字段中，表示对应时间域的每一个时刻，例如，</em> 在分钟字段时，表示“每分钟”；<br><em>   问号（?）：该字符只在日期和星期字段中使用，它通常指定为“无意义的值”，相当于点位符；
</em>   减号( - )：表达一个范围，如在小时字段中使用“10-12”，则表示从10到12点，即10,11,12；<br><em>   逗号( , )：表达一个列表值，如在星期字段中使用“MON,WED,FRI”，则表示星期一，星期三和星期五；
</em>   斜杠( / )：x/y表达一个等步长序列，x为起始值，y为增量步长值。如在分钟字段中使用0/15，则表示为0,15,30和45秒，而5/15在分钟字段中表示5,20,35,50，你也可以使用<em>/y，它等同于0/y；
</em>   L：该字符只在日期和星期字段中使用，代表“Last”的意思，但它在两个字段中意思不同。L在日期字段中，表示这个月份的最后一天，如一月的 31号，非闰年二月的28号；如果L用在星期中，则表示星期六，等同于7。但是，如果L出现在星期字段里，而且在前面有一个数值X，则表示“这个月的最后 X天”，例如，6L表示该月的最后星期五；<br><em>   W：该字符只能出现在日期字段里，是对前导日期的修饰，表示离该日期最近的工作日。例如15W表示离该月15号最近的工作日，如果该月15号是星期六，则匹配14号星期五；如果15日是星期日，则匹配16号星期一；如果15号是星期二，那结果就是15号星期二。但必须注意关联的匹配日期不能够跨月，如你指定1W，如果1号是星期六，结果匹配的是3号星期一，而非上个月最后的那天。W字符串只能指定单一日期，而不能指定日期范围；
</em>   LW组合：在日期字段可以组合使用LW，它的意思是当月的最后一个工作日；<br><em>   井号( # )：该字符只能在星期字段中使用，表示当月某个工作日。如6#3表示当月的第三个星期五(6表示星期五，#3表示当前的第三个)，而4#5表示当月的第五个星期三，假设当月没有第五个星期三，忽略不触发；
</em>   C：该字符只在日期和星期字段中使用，代表“Calendar”的意思。它的意思是计划所关联的日期，如果日期没有被关联，则相当于日历中所有日期。例如5C在日期字段中就相当于日历5日以后的第一天。1C在星期字段中相当于星期日后的第一天。<br><div><br><br>Cron表达式对特殊字符的大小写不敏感，对代表星期的缩写英文大小写也不敏感。<br><br>下面给出一些完整的Cron表示式的实例：<br><br><em>Cron表示式示例表</em><br><br><table class="new_insert" border="1" cellspacing="0" cellpadding="2"><br><tbody><br><tr><br><td valign="top"><br><div>表示式<br></div></td><br><td valign="top"><br><div>说明<br></div></td><br></tr><br><tr><br><td valign="top"><br><div>“0 0 12 <em> </em> ? “<br></div></td><br><td valign="top"><br><div>每天12点运行<br></div></td><br></tr><br><tr><br><td valign="top"><br><div>“0 15 10 ? <em> </em>“<br></div></td><br><td valign="top"><br><div>每天10:15运行<br></div></td><br></tr><br><tr><br><td valign="top"><br><div>“0 15 10 <em> </em> ?”<br></div></td><br><td valign="top"><br><div>每天10:15运行<br></div></td><br></tr><br><tr><br><td valign="top"><br><div>“0 15 10 <em> </em> ? <em>“<br></em></div></td><br><td valign="top"><br><div>每天10:15运行<br></div></td><br></tr><br><tr><br><td valign="top"><br><div>“0 15 10  <em> ? 2008”<br></em></div></td><br><td valign="top"><br><div>在2008年的每天10：15运行<br></div></td><br></tr><br><tr><br><td valign="top"><br><div>“0  14 <em> </em> ?”<br></div></td><br><td valign="top"><br><div>每天14点到15点之间每分钟运行一次，开始于14:00，结束于14:59<br></div></td><br></tr><br><tr><br><td valign="top"><br><div>“0  0/5  14 <em> </em> ?”<br></div></td><br><td valign="top"><br><div>每天14点到15点每5分钟运行一次，开始于14:00，结束于14:55<br></div></td><br></tr><br><tr><br><td valign="top"><br><div>“0  0/5 14,18 <em> </em> ?”<br></div></td><br><td valign="top"><br><div>每天14点到15点每5分钟运行一次，此外每天18点到19点每5钟也运行一次<br></div></td><br></tr><br><tr><br><td valign="top"><br><div>“0  0-5  14  <em>  </em>  ?”<br></div></td><br><td valign="top"><br><div>每天14:00点到14:05，每分钟运行一次<br></div></td><br></tr><br><tr><br><td valign="top"><br><div>“0  10,44  14 ? 3 WED”<br></div></td><br><td valign="top"><br><div>3月每周三的14:10分到14:44，每分钟运行一次<br></div></td><br></tr><br><tr><br><td valign="top"><br><div>“0 15 10 ? <em> MON-FRI”<br></em></div></td><br><td valign="top"><br><div>每周一，二，三，四，五的10:15分运行<br></div></td><br></tr><br><tr><br><td valign="top"><br><div>“0 15 10 15  ?”<br></div></td><br><td valign="top"><br><div>每月15日10:15分运行<br></div></td><br></tr><br><tr><br><td valign="top"><br><div>“0 15 10 L <em> ?”<br></em></div></td><br><td valign="top"><br><div>每月最后一天10:15分运行<br></div></td><br></tr><br><tr><br><td valign="top"><br><div>“0 15 10 ?  6L”<br></div></td><br><td valign="top"><br><div>每月最后一个星期五10:15分运行<br></div></td><br></tr><br><tr><br><td valign="top"><br><div>“0 15 10 ? <em> 6L 2007-2009”<br></em></div></td><br><td valign="top"><br><div>在2007,2008,2009年每个月的最后一个星期五的10:15分运行<br></div></td><br></tr><br><tr><br><td valign="top"><br><div>“0 15 10 ?  6#3”<br></div></td><br><td valign="top"><br><div>每月第三个星期五的10:15分运行<br></div></td><br></tr><br></tbody><br></table><br><br><div><br><br><strong>CronTrigger实例</strong><br><br>下面，我们使用CronTrigger对SimpleJob进行调度，通过Cron表达式制定调度规则，让它每5秒钟运行一次：<br><br>代码清单3  CronTriggerRunner：使用CronTrigger进行调度<br><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div>import org.quartz.CronExpression;<br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div>import org.quartz.CronTrigger;<br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div>import org.quartz.JobDetail;<br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div>import org.quartz.Scheduler;<br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div>import org.quartz.SchedulerFactory;<br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div>import org.quartz.impl.StdSchedulerFactory;<br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div>public class CronTriggerRunner {<br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div>    public static void main(String args[]) {<br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div>        try {<br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div>            JobDetail jobDetail = new JobDetail(“job1_2”, “jGroup1”, SimpleJob.class); // ①-1：创建CronTrigger，指定组及名称<br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div>            CronTrigger cronTrigger = new CronTrigger(“trigger1_2”, “tgroup1”);<br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div>            CronExpression cexp = new CronExpression(“0/5 <em> </em> <em> </em> ?”);// ①-2：定义Cron表达式<br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div>            cronTrigger.setCronExpression(cexp);// ①-3：设置Cron表达式<br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div>            SchedulerFactory schedulerFactory = new StdSchedulerFactory();<br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div>            Scheduler scheduler = schedulerFactory.getScheduler();<br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div>            scheduler.scheduleJob(jobDetail, cronTrigger);<br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div>            scheduler.start(); // ②<br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div>        } catch (Exception e) {<br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div>            e.printStackTrace();<br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div>        }<br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div>    }<br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div>}<br>&gt;<br>&gt; </div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div>

<div><br><div><br><div><br><div><br><div><br><br>运行CronTriggerRunner，每5秒钟将触发运行SimpleJob一次。默认情况下Cron表达式对应当前的时区，可以通过<br><br> CronTriggerRunner的setTimeZone(java.util.TimeZone timeZone)方法显式指定时区。你还也可以通过<br><br>setStartTime(java.util.Date startTime)和setEndTime(java.util.Date endTime)指定开始和结束的时间。<br><br>在代码清单3的②处需要通过Thread.currentThread.sleep()的方式让主线程睡眠，以便调度器可以继续工作执行任务调度。否则在调度器启动后，因为主线程马上退出，也将同时引起调度器关闭，调度器中的任务都将相应销毁，这将导致看不到实际的运行效果。在单元测试的时候，让主线程睡眠经常使用的办法。对于某些长周期任务调度的测试，你可以简单地调整操作系统时间进行模拟。<br><br>使用Calendar<br><br>在实际任务调度中，我们不可能一成不变地按照某个周期性的调度规则运行任务，必须考虑到实现生活中日历上特定日期，就象习惯了大男人作风的人在2月14号也会有不同表现一样。 下面，我们安排一个任务，每小时运行一次，并将五一节和国际节排除在外，其<br><br>代码如代码清单4所示：<br><br>代码清单4  CalendarExample：使用Calendar<br><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div>import java.util.Calendar;<br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div>import java.util.Date;<br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div>import java.util.GregorianCalendar;<br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div>import org.quartz.impl.calendar.AnnualCalendar;import org.quartz.TriggerUtils;„<br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div>public class CalendarExample {<br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div>    public static void main(String[] args) throws Exception {<br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div>        SchedulerFactory sf = new StdSchedulerFactory();<br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div>        Scheduler scheduler = sf.getScheduler();<br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div>        // ①法定节日是以每年为周期的，所以使用AnnualCalendar<br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div>        AnnualCalendar holidays = new AnnualCalendar();<br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div>        // ②五一劳动节<br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div>        Calendar laborDay = new GregorianCalendar();<br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div>        laborDay.add(Calendar.MONTH, 5);<br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div>        laborDay.add(Calendar.DATE, 1);<br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div>        holidays.setDayExcluded(laborDay, true); // ②-1：排除的日期，如果设置为false则为包含<br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div>        // ③国庆节<br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div>        Calendar nationalDay = new GregorianCalendar();<br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div>        nationalDay.add(Calendar.MONTH, 10);<br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div>        nationalDay.add(Calendar.DATE, 1);<br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div>        holidays.setDayExcluded(nationalDay, true);// ③-1：排除该日期<br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div>        scheduler.addCalendar(“holidays”, holidays, false, false);// ④向Scheduler注册日历<br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div>        Date runDate = TriggerUtils.getDateOf(0, 0, 10, 1, 4);// ⑤4月1号上午10点<br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div>        JobDetail job = new JobDetail(“job1”, “group1”, SimpleJob.class);<br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div>        SimpleTrigger trigger = new SimpleTrigger(“trigger1”, “group1”, runDate, null,<br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div>                SimpleTrigger.REPEAT_INDEFINITELY, 60L <em> 60L </em> 1000L);<br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div>        trigger.setCalendarName(“holidays”);// ⑥让Trigger应用指定的日历规则<br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div>        scheduler.scheduleJob(job, trigger);<br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div>        scheduler.start(); // 实际应用中主线程不能停止，否则Scheduler得不到执行，此处从略<br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div>    }<br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div>}<br>&gt;<br>&gt; </div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div>

<div><br><div><br><div><br><div><br><div><br><div><br><br>由于节日是每年重复的，所以使用org.quartz.Calendar的AnnualCalendar实现类，通过②、③的代码，指定五一和国庆两个节日并通过AnnualCalendar#setDayExcluded(Calendar day, boolean exclude)方法添加这两个日期。exclude为true时表示排除指定的日期，如果为false时表示包含指定的日期。<br><br>在定制好org.quartz.Calendar后，还需要通过Scheduler#addCalendar(String calName, Calendar calendar, boolean replace, boolean updateTriggers)<br><br>进行注册，如果updateTriggers为true，Scheduler中已引用Calendar的Trigger将得到更新，如④所示在⑥处，我们让一个Trigger<br><br>指定使用Scheduler中代表节日的Calendar，这样Trigger就会避开五一和国庆这两个特殊日子了。<br><br><div><br><div><br><div><br><br><strong>任务调度信息存储</strong><br><br>在默认情况下Quartz将任务调度的运行信息保存在内存中，这种方法提供了最佳的性能，因为内存中数据访问最快。不足之处是缺乏数据的持久性，当程序路途停止或系统崩溃时，所有运行的信息都会丢失。比如我们希望安排一个执行100次的任务，如果执行到50<br><br><div><br><div><br><br>次时系统崩溃了，系统重启时任务的执行计数器将从0开始。在大多数实际的应用中，我们往往并不需要保存任务调度的现场数据，因为很少需要规划一个指定执行次数的任务。<br><br>对于仅执行一次的任务来说，其执行条件信息本身应该是已经持久化的业务数据（如锁定到期解锁任务，解锁的时间应该是业务数据）<br><br>，当执行完成后，条件信息也会相应改变。当然调度现场信息不仅仅是记录运行次数，还包括调度规则、JobDataMap中的数据等。<br><br>如果确实需要持久化任务调度信息，Quartz允许你通过调整其属性文件，将这些信息保存到数据库中。使用数据库保存任务调度信息后，即使系统崩溃后重新启动，任务的调度信息将得到恢复。如前面所说的例子，执行50次崩溃后重新运行，计数器将从51开始计数。使用了数据库保存信息的任务称为持久化任务。<br><br><strong>通过配置文件调整任务调度信息的保存策略</strong><br><br>其实Quartz JAR文件的org.quartz包下就包含了一个quartz.properties属性配置文件并提供了默认设置。如果需要调整默认配置，可以在类路径下建立一个新的quartz.properties，它将自动被Quartz加载并覆盖默认的设置。<br><br>先来了解一下Quartz的默认属性配置文件：<br><br>代码清单5 quartz.properties：默认配置<br><br>①集群的配置，这里不使用集群<br><br>org.quartz.scheduler.instanceName = DefaultQuartzScheduler<br><br>org.quartz.scheduler.rmi.export = false<br><br>org.quartz.scheduler.rmi.proxy = false<br><br>org.quartz.scheduler.wrapJobExecutionInUserTransaction = false<br><br>②配置调度器的线程池<br><br>org.quartz.threadPool.class = org.quartz.simpl.SimpleThreadPool<br><br>org.quartz.threadPool.threadCount = 10<br><br>org.quartz.threadPool.threadPriority = 5<br><br>org.quartz.threadPool.threadsInheritContextClassLoaderOfInitializingThread = true<br><br><div><br><div><br><br>③配置任务调度现场数据保存机制<br><br>org.quartz.jobStore.class = org.quartz.simpl.RAMJobStore<br><br>Quartz的属性配置文件主要包括三方面的信息：<br><br><em>   1) 集群信息； 
</em>   2) 调度器线程池；<br>*   3) 任务调度现场数据的保存。<br><br> 如果任务数目很大时，可以通过增大线程池的大小得到更好的性能。默认情况下，Quartz采用org.quartz.simpl.RAMJobStore<br><br>保存任务的现场数据，顾名思义，信息保存在RAM内存中，我们可以通过以下设置将任务调度现场数据保存到数据库中：<br><br>代码清单6 quartz.properties：使用数据库保存任务调度现场数据<br><br>„<br><br>org.quartz.jobStore.class = org.quartz.impl.jdbcjobstore.JobStoreTX<br><br>org.quartz.jobStore.tablePrefix = QRTZ_    ①数据表前缀<br><br>org.quartz.jobStore.dataSource = qzDS   ②数据源名称<br><br>③定义数据源的具体属性<br><br>org.quartz.dataSource.qzDS.driver = oracle.jdbc.driver.OracleDriver<br><br>org.quartz.dataSource.qzDS.URL = jdbc:oracle:thin:@localhost:1521:ora9i<br><br>org.quartz.dataSource.qzDS.user = stamen<br><br>org.quartz.dataSource.qzDS.password = abc<br><br>org.quartz.dataSource.qzDS.maxConnections = 10<br><br>要将任务调度数据保存到数据库中，就必须使用org.quartz.impl.jdbcjobstore.JobStoreTX代替原来的<br><br>org.quartz.simpl.RAMJobStore并提供相应的数据库配置信息。首先①处指定了Quartz数据库表的前缀，在②处定义了一个数据源，<br><br>在③处具体定义这个数据源的连接信息。你必须事先在相应的数据库中创建Quartz的数据表（共8张），在Quartz的完整发布包的<br><br><div><br><div><br><br>docs/dbTables目录下拥有对应不同数据库的SQL脚本。<br><br><strong>查询数据库中的运行信息</strong><br><br>任务的现场保存对于上层的Quartz程序来说是完全透明的，我们在src目录下编写一个如代码清单6所示的quartz.properties文件后，重新运行代码清单2或代码清单3的程序，在数据库表中将可以看到对应的持久化信息。当调度程序运行过程中途停止后，任务调度的现场数据将记录在数据表中，在系统重启时就可以在此基础上继续进行任务的调度。<br><br>代码清单7 <strong>JDBCJobStoreRunner</strong>：从数据库中恢复任务的调度<br><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div>import org.quartz.Scheduler;<br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div>import org.quartz.SchedulerFactory;<br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div>import org.quartz.SimpleTrigger;<br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div>import org.quartz.Trigger;<br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div>import org.quartz.impl.StdSchedulerFactory;<br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div>public class JDBCJobStoreRunner {<br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div>    public static void main(String args[]) {<br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div>        try {<br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div>            SchedulerFactory schedulerFactory = new StdSchedulerFactory();<br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div>            Scheduler scheduler = schedulerFactory.getScheduler();<br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div>            // ①获取调度器中所有的触发器组<br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div>            String[] triggerGroups = scheduler.getTriggerGroupNames();<br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div>            // ②重新恢复在tgroup1组中，名为trigger1_1触发器的运行<br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div>            for (int i = 0; i &lt; triggerGroups.length; i++) {<br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div>                String[] triggers = scheduler.getTriggerNames(triggerGroups[i]);<br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div>                for (int j = 0; j &lt; triggers.length; j++) {<br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div>                    Trigger tg = scheduler.getTrigger(triggers[j], triggerGroups[i]);<br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div>                    if (tg instanceof SimpleTrigger &amp;&amp; tg.getFullName().equals(“tgroup1.trigger1_1”)) {<br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div>                        // ②-1:根据名称判断<br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div>                        // ②-1:恢复运行<br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div>                        scheduler.rescheduleJob(triggers[j], triggerGroups[i], tg);<br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div>                    }<br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div>                }<br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div>            }<br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div>            scheduler.start();<br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div>        } catch (<br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div>        Exception e) {<br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div>            e.printStackTrace();<br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div>        }<br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div>    }<br>&gt;<br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div><br>&gt; <div>}<br>&gt;<br>&gt; </div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div>

<div><br><div><br><div><br><div><br><div><br><div><br><div><br><div><br><br>当代码清单2中的SimpleTriggerRunner执行到一段时间后非正常退出，我们就可以通过这个JDBCJobStoreRunner根据记录在数据库中的现场数据恢复任务的调度。Scheduler中的所有Trigger以及JobDetail的运行信息都会保存在数据库中，这里我们仅恢复tgroup1<br><br>组中名称为trigger1_1的触发器，这可以通过如②-1所示的代码进行过滤，触发器的采用GROUP.TRIGGER_NAME 的全名格式。通过<br><br>Scheduler#rescheduleJob(String triggerName,String groupName,Trigger newTrigger)即可重新调度关联某个Trigger的任务。<br><br>小结<br><br>Quartz提供了最为丰富的任务调度功能，不但可以制定周期性运行的任务调度方案，还可以让你按照日历相关的方式进行任务调度。<br><br>Quartz框架的重要组件包括Job、JobDetail、Trigger、Scheduler以及辅助性的JobDataMap和SchedulerContext。<br><br>Quartz拥有一个线程池，通过线程池为任务提供执行线程，你可以通过配置文件对线程池进行参数定制。Quartz的另一个重要功能是可将任务调度信息持久化到数据库中，以便系统重启时能够恢复已经安排的任务。此外，Quartz还拥有完善的事件体系，允许你注册各种事件的监听器。<br><br></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://pangguoming.com/post/1379fb7e.html">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="庞国明">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars0.githubusercontent.com/u/7269202?s=460&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="庞国明-博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/post/1379fb7e.html" itemprop="url">SpringBoot整合Quartz定时任务 的简单实例 2</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-12-11T10:51:00+08:00">
                2017-12-11
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>（1）什么是Quartz?<br>（2）Quartz的特点；<br>（3）Quartz专用词汇说明；<br>（4）Quartz任务调度基本实现原理；</p>
<pre><code>接下来看下具体的内容：
</code></pre><p><strong>（1）什么是Quartz?</strong></p>
<p>Quartz是一个完全由Java编写的开源作业调度框架，为在Java应用程序中进行作业调度提供了简单却强大的机制。Quartz允许开发人员根据时间间隔来调度作业。它实现了作业和触发器的多对多的关系，还能把多个作业与不同的触发器关联。简单地创建一个org.quarz.Job接口的Java类。</p>
<p><strong>（2）Quartz的特点；</strong></p>
<p>作为一个优秀的开源调度框架，Quartz 具有以下特点：</p>
<p>① 强大的调度功能，例如支持丰富多样的调度方法，可以满足各种常规及特殊需求；</p>
<p>②   灵活的应用方式，例如支持任务和调度的多种组合方式，支持调度数据的多种存储方式；</p>
<p>③ 分布式和集群能力，Terracotta 收购后在原来功能基础上作了进一步提升。</p>
<p>④ Quartz 很容易与 Spring 集成实现灵活可配置的调度功能。</p>
<p><strong>（3）Quartz专用词汇说明；</strong></p>
<p>下面是本文中用到的一些专用词汇，在此声明：</p>
<p><strong>scheduler**</strong>：**</p>
<p>任务调度器</p>
<p><strong>trigger**</strong>：**</p>
<p>触发器，用于定义任务调度时间规则</p>
<p><strong>job**</strong>：**</p>
<p>任务，即被调度的任务</p>
<p><strong>misfire**</strong>：**</p>
<p>错过的，指本来应该被执行但实际没有被执行的任务调度</p>
<p><strong>（4）Quartz任务调度基本实现原理；</strong></p>
<p>Quartz 任务调度的核心元素是 scheduler, trigger 和 job，其中 trigger 和 job 是任务调度的元数据，scheduler 是实际执行调度的控制器。</p>
<p>在 Quartz 中，trigger 是用于定义调度时间的元素，即按照什么时间规则去执行任务。Quartz 中主要提供了四种类型的 trigger：SimpleTrigger，CronTirgger，DateIntervalTrigger，和 NthIncludedDayTrigger。这四种 trigger 可以满足企业应用中的绝大部分需求。</p>
<p>在 Quartz 中，job 用于表示被调度的任务。主要有两种类型的 job：无状态的（stateless）和有状态的（stateful）。对于同一个 trigger 来说，有状态的 job 不能被并行执行，只有上一次触发的任务被执行完之后，才能触发下一次执行。Job 主要有两种属性：volatility 和 durability，其中 volatility 表示任务是否被持久化到数据库存储，而 durability 表示在没有 trigger 关联的时候任务是否被保留。两者都是在值为 true 的时候任务被持久化或保留。一个 job 可以被多个 trigger 关联，但是一个 trigger 只能关联一个 job。</p>
<pre><code>在 Quartz 中， scheduler 由 scheduler 工厂创建：DirectSchedulerFactory 或者 StdSchedulerFactory。 第二种工厂 StdSchedulerFactory 使用较多，因为 DirectSchedulerFactory 使用起来不够方便，需要作许多详细的手工编码设置。 Scheduler 主要有三种：RemoteMBeanScheduler， RemoteScheduler 和 StdScheduler。本文以最常用的 StdScheduler 为例讲解。这也是笔者在项目中所使用的 scheduler 类。
</code></pre><p>这一篇文章，我们紧接着上一篇的文章，讲讲在Quartz在java project的项目中如何进行使用，在这里我们使用maven进行构建项目。先看下本章的大纲：</p>
<div class="quote_div">（1）新建工程quartz-java;<br>（2）配置pom.xml文件；<br>（3）编码说明；<br>（4）编写Job类；<br>（5）编写启动类进行代码测试；<br>（6）quartz.properties配置文件说明；<br><br>       接下里一起看下具体的内容：<br><br><strong>（1）新建工程quartz-java;</strong><br><br>       新建一个java project取名为quartz-java。<br><br><strong>（2）配置pom.xml文件；</strong><br><br>       在pom.xml文件中添加quartz的依赖：<br><br><dependency><br><br>            <groupid>org.quartz-scheduler</groupid><br><br>            <artifactid>quartz</artifactid><br><br>            <version>2.2.3</version><br><br></dependency><br><br><strong>（3）编码说明；</strong><br><br>（一）首先我们需要定义一个任务类，比如为HelloJob ，该类需要继承Job类，然后添加execute(JobExecutionContext context)方法，在这个方法中就是我们具体的任务执行的地方。<br><br>（二）在哪里定义“在什么时候执行什么任务呢？”：那么我们需要Scheduler，此类的创建方式使用Quartz提供的工厂类StdSchedulerFactory.getDefaultScheduler()进行创建。<br><br>（三）如何触发呢：scheduler.scheduleJob(jobDetail,trigger);进行触发定时任务，在这里需要两个参数。jobDetail可以通过JobBuilder.newJob进行创建，在这里就需要制定一个Job类了，也就是我们第一步创建的HelloJob；trigger类的话，可以通过TriggerBuilder.newTrigger进行创建。<br><br><strong>（4）编写Job类；</strong><br><br>编写HelloJob任务类：<br><br><strong>package</strong> com.kfit.job;<br><br><strong>import</strong> java.util.Date;<br><br><strong>import</strong> org.quartz.Job;<br><br><strong>import</strong> org.quartz.JobExecutionContext;<br><br><strong>import</strong> org.quartz.JobExecutionException;<br><br>/<strong><br><br> <em> 任务类.

 </em> </strong>@author<strong> Angel –守护天使<br><br> * </strong>@version<strong> v.0.1<br><br> * </strong>@date<strong> 2017年4月21日<br><br> */

</strong>public <strong>**class</strong> HelloJob <strong>implements</strong> Job{<br><br>    <strong>public **</strong>void<strong> execute(JobExecutionContext context) </strong>throws<strong> JobExecutionException {<br><br>        // 执行响应的任务.<br><br>       System.*</strong>out<strong>*.println(“HelloJob.execute,”+</strong>new<strong> Date());<br><br>    }<br><br>}

</strong>（5）编写启动类进行代码测试；<strong><br><br>在Main方法中进行编码测试：

</strong>package<strong> com.kfit;

</strong>import<strong> java.util.concurrent.TimeUnit;

</strong>import<strong> org.quartz.JobBuilder;

</strong>import<strong> org.quartz.JobDetail;

</strong>import<strong> org.quartz.Scheduler;

</strong>import<strong> org.quartz.SchedulerException;

</strong>import<strong> org.quartz.SimpleScheduleBuilder;

</strong>import<strong> org.quartz.Trigger;

</strong>import<strong> org.quartz.TriggerBuilder;

</strong>import<strong> org.quartz.impl.StdSchedulerFactory;

</strong>import<strong> com.kfit.job.HelloJob;<br><br>/</strong><br><br> <em> 直接在Main方法中进行启动测试.

 </em> <strong>@author</strong> Angel –守护天使<br><br> <em> <strong>@version</strong> v.0.1

 </em> <strong>@date</strong> 2017年4月21日<br><br> <em>/<br><br><strong>public **</strong>class<strong> App {

    </strong>public <strong><strong>static </strong></strong>void<strong> main(String[] args) </strong>throws** SchedulerException, InterruptedException {<br><br>       /</em><br><br>        <em>在 Quartz 中， scheduler 由 scheduler 工厂创建：DirectSchedulerFactory 或者StdSchedulerFactory。第二种工厂 StdSchedulerFactory 使用较多，

        </em>因为 DirectSchedulerFactory 使用起来不够方便，需要作许多详细的手工编码设置。<br><br>        <em>/<br><br>       // 获取Scheduler实例<br><br>       Scheduler scheduler = StdSchedulerFactory.</em>getDefaultScheduler<em>();<br><br>       scheduler.start();<br><br>       System.**</em>out<strong><em>.println(“scheduler.start”);<br><br>       //具体任务.<br><br>       JobDetail jobDetail = JobBuilder.</em>newJob*(HelloJob.</strong>class<strong>).withIdentity(“job1”,”group1”).build();<br><br>       //触发时间点. (每5秒执行1次.)<br><br>       SimpleScheduleBuilder simpleScheduleBuilder = SimpleScheduleBuilder.<em>simpleSchedule</em>().withIntervalInSeconds(5).repeatForever();<br><br>       Trigger trigger = TriggerBuilder.<em>newTrigger</em>().withIdentity(“trigger1”,”group1”).startNow().withSchedule(simpleScheduleBuilder).build();<br><br>       // 交由Scheduler安排触发<br><br>       scheduler.scheduleJob(jobDetail,trigger);<br><br>       //睡眠20秒.<br><br>       TimeUnit.*</strong>SECONDS<strong><em>.sleep(20);<br><br>       scheduler.shutdown();//关闭定时任务调度器.<br><br>       System.</em></strong>out***.println(“scheduler.shutdown”);<br><br>    }<br><br>}<br><br>执行代码查看控制台的打印信息：<br><br>———————————————————–<br><br>scheduler.start<br><br>HelloJob.execute,Fri Apr 21 19:50:01 CST 2017<br><br>HelloJob.execute,Fri Apr 21 19:50:06 CST 2017<br><br>HelloJob.execute,Fri Apr 21 19:50:11 CST 2017<br><br>HelloJob.execute,Fri Apr 21 19:50:16 CST 2017<br><br>HelloJob.execute,Fri Apr 21 19:50:21 CST 2017<br><br>scheduler.shutdown<br><br></div>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://pangguoming.com/post/dce60112.html">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="庞国明">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars0.githubusercontent.com/u/7269202?s=460&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="庞国明-博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/post/dce60112.html" itemprop="url">SpringBoot整合Quartz定时任务 的简单实例</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-12-11T10:39:00+08:00">
                2017-12-11
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>POM.XML文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- 定时器任务 quartz需要导入的坐标 --&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.quartz-scheduler&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;quartz&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;1.8.5&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br></pre></td></tr></table></figure>
<p>类似于控制器代码:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">package com.xiaowu.quartz.demo;</span><br><span class="line"></span><br><span class="line">import java.util.Date;</span><br><span class="line"></span><br><span class="line">import org.springframework.scheduling.annotation.Scheduled;</span><br><span class="line">import org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line">/***</span><br><span class="line"> * </span><br><span class="line"> * Quartz设置项目全局的定时任务</span><br><span class="line"> * </span><br><span class="line"> * @Component注解的意义        泛指组件，当组件不好归类的时候，我们可以使用这个注解进行标注。一般公共的方法我会用上这个注解</span><br><span class="line"> * </span><br><span class="line"> * </span><br><span class="line"> * @author WQ</span><br><span class="line"> *</span><br><span class="line"> */</span><br><span class="line">@Component</span><br><span class="line">public class QuartzDemo &#123;</span><br><span class="line"></span><br><span class="line">    @Scheduled(cron = &quot;0 0/1 * * * ?&quot;) // 每分钟执行一次</span><br><span class="line">    public void work() throws Exception &#123;</span><br><span class="line">        System.out.println(&quot;执行调度任务：&quot;+new Date());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Scheduled(fixedRate = 5000)//每5秒执行一次</span><br><span class="line">    public void play() throws Exception &#123;</span><br><span class="line">        System.out.println(&quot;执行Quartz定时器任务：&quot;+new Date());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Scheduled(cron = &quot;0/2 * * * * ?&quot;) //每2秒执行一次</span><br><span class="line">    public void doSomething() throws Exception &#123;</span><br><span class="line">        System.out.println(&quot;每2秒执行一个的定时任务：&quot;+new Date());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Scheduled(cron = &quot;0 0 0/1 * * ? &quot;) // 每一小时执行一次</span><br><span class="line">    public void goWork() throws Exception &#123;</span><br><span class="line">        System.out.println(&quot;每一小时执行一次的定时任务：&quot;+new Date());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>启动SpringBoot项目，即可。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public static void main(String[] args) &#123;</span><br><span class="line">        SpringApplication.run(Chapter1Application.class, args);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>，截图如下：</p>
<p><img src="http://pangguoming.com/blog/images/b589aa6c-e707-4151-b103-964b09f25563.png" alt=""></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://pangguoming.com/post/3ebd6ee4.html">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="庞国明">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars0.githubusercontent.com/u/7269202?s=460&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="庞国明-博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/post/3ebd6ee4.html" itemprop="url">SpringBoot学习：整合shiro（身份认证和权限认证）,使用EhCache缓存</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-12-08T14:36:00+08:00">
                2017-12-08
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>项目下载地址：<a href="http://download.csdn.NET/detail/aqsunkai/9805821" target="_blank" rel="noopener">http://download.csdn.NET/detail/aqsunkai/9805821</a></p>
<p>（一）在pom.xml中添加依赖：</p>
<div class="dp-highlighter bg_html"><br><div class="bar"><br><div class="tools"><strong>[html]</strong> <a href="http://blog.csdn.net/aqsunkai/article/details/69757017#" title="view plain" target="_blank" rel="noopener">view plain</a><span class="tracking-ad" data-mod="popu_168"><span class="tracking-ad" data-mod="popu_168"> <a href="http://blog.csdn.net/aqsunkai/article/details/69757017#" title="copy" target="_blank" rel="noopener">copy</a></span></span><br><div><br><br>1.  <span class="tag">&lt;<span class="tag-name">properties<span class="tag">&gt;  </span></span></span><br>2.      <span class="tag">&lt;<span class="tag-name">shiro.version<span class="tag">&gt;1.3.2<span class="tag">&lt;/<span class="tag-name">shiro.version<span class="tag">&gt;  </span></span></span></span></span></span><br>3.  <span class="tag">&lt;/<span class="tag-name">properties<span class="tag">&gt;  </span></span></span><br><div class="dp-highlighter bg_html"><br><div class="bar"><br><div class="tools"><strong>[html]</strong> <a href="http://blog.csdn.net/aqsunkai/article/details/69757017#" title="view plain" target="_blank" rel="noopener">view plain</a><span class="tracking-ad" data-mod="popu_168"><span class="tracking-ad" data-mod="popu_168"> <a href="http://blog.csdn.net/aqsunkai/article/details/69757017#" title="copy" target="_blank" rel="noopener">copy</a></span></span><br><div><br><br>1.  <span class="comments"><!--shiro start-->  </span><br>2.      <span class="tag">&lt;<span class="tag-name">dependency<span class="tag">&gt;  </span></span></span><br>3.        <span class="tag">&lt;<span class="tag-name">groupId<span class="tag">&gt;org.apache.shiro<span class="tag">&lt;/<span class="tag-name">groupId<span class="tag">&gt;  </span></span></span></span></span></span><br>4.        <span class="tag">&lt;<span class="tag-name">artifactId<span class="tag">&gt;shiro-core<span class="tag">&lt;/<span class="tag-name">artifactId<span class="tag">&gt;  </span></span></span></span></span></span><br>5.        <span class="tag">&lt;<span class="tag-name">version<span class="tag">&gt;${shiro.version}<span class="tag">&lt;/<span class="tag-name">version<span class="tag">&gt;  </span></span></span></span></span></span><br>6.      <span class="tag">&lt;/<span class="tag-name">dependency<span class="tag">&gt;  </span></span></span><br>7.      <span class="tag">&lt;<span class="tag-name">dependency<span class="tag">&gt;  </span></span></span><br>8.        <span class="tag">&lt;<span class="tag-name">groupId<span class="tag">&gt;org.apache.shiro<span class="tag">&lt;/<span class="tag-name">groupId<span class="tag">&gt;  </span></span></span></span></span></span><br>9.        <span class="tag">&lt;<span class="tag-name">artifactId<span class="tag">&gt;shiro-web<span class="tag">&lt;/<span class="tag-name">artifactId<span class="tag">&gt;  </span></span></span></span></span></span><br>10.        <span class="tag">&lt;<span class="tag-name">version<span class="tag">&gt;${shiro.version}<span class="tag">&lt;/<span class="tag-name">version<span class="tag">&gt;  </span></span></span></span></span></span><br>11.      <span class="tag">&lt;/<span class="tag-name">dependency<span class="tag">&gt;  </span></span></span><br>12.      <span class="tag">&lt;<span class="tag-name">dependency<span class="tag">&gt;  </span></span></span><br>13.        <span class="tag">&lt;<span class="tag-name">groupId<span class="tag">&gt;org.apache.shiro<span class="tag">&lt;/<span class="tag-name">groupId<span class="tag">&gt;  </span></span></span></span></span></span><br>14.        <span class="tag">&lt;<span class="tag-name">artifactId<span class="tag">&gt;shiro-ehcache<span class="tag">&lt;/<span class="tag-name">artifactId<span class="tag">&gt;  </span></span></span></span></span></span><br>15.        <span class="tag">&lt;<span class="tag-name">version<span class="tag">&gt;${shiro.version}<span class="tag">&lt;/<span class="tag-name">version<span class="tag">&gt;  </span></span></span></span></span></span><br>16.      <span class="tag">&lt;/<span class="tag-name">dependency<span class="tag">&gt;  </span></span></span><br>17.      <span class="tag">&lt;<span class="tag-name">dependency<span class="tag">&gt;  </span></span></span><br>18.        <span class="tag">&lt;<span class="tag-name">groupId<span class="tag">&gt;org.apache.shiro<span class="tag">&lt;/<span class="tag-name">groupId<span class="tag">&gt;  </span></span></span></span></span></span><br>19.        <span class="tag">&lt;<span class="tag-name">artifactId<span class="tag">&gt;shiro-spring<span class="tag">&lt;/<span class="tag-name">artifactId<span class="tag">&gt;  </span></span></span></span></span></span><br>20.        <span class="tag">&lt;<span class="tag-name">version<span class="tag">&gt;${shiro.version}<span class="tag">&lt;/<span class="tag-name">version<span class="tag">&gt;  </span></span></span></span></span></span><br>21.      <span class="tag">&lt;/<span class="tag-name">dependency<span class="tag">&gt;  </span></span></span><br>22.  <span class="comments"><!--shiro end-->  </span><br><br>下面是数据库的表，这里主要涉及到五张表：用户表，角色表(用户所拥有的角色)，权限表(角色所涉及到的权限)，用户-角色表(用户和角色是多对多的)，角色-权限表(角色和权限是多对多的)。sql语句如下：<br><br><div class="dp-highlighter bg_html"><br><div class="bar"><br><div class="tools"><strong>[html]</strong> <a href="http://blog.csdn.net/aqsunkai/article/details/69757017#" title="view plain" target="_blank" rel="noopener">view plain</a><span class="tracking-ad" data-mod="popu_168"><span class="tracking-ad" data-mod="popu_168"> <a href="http://blog.csdn.net/aqsunkai/article/details/69757017#" title="copy" target="_blank" rel="noopener">copy</a></span></span><br><div><br><br>1.  – —————————-<br>2.  – Table structure for sys_permission<br>3.  – —————————-<br>4.  DROP TABLE IF EXISTS <code>sys_permission</code>;<br>5.  CREATE TABLE <code>sys_permission</code> (<br>6.    <code>id</code> int(11) NOT NULL AUTO_INCREMENT COMMENT ‘主键ID’,<br>7.    <code>url</code> varchar(256) DEFAULT NULL COMMENT ‘url地址’,<br>8.    <code>name</code> varchar(64) DEFAULT NULL COMMENT ‘url描述/名称’,<br>9.     parent_id int(11) DEFAULT NULL COMMENT ‘父节点权限ID’,<br>10.    PRIMARY KEY (<code>id</code>)<br>11.  ) <span class="attribute">ENGINE=<span class="attribute-value">InnoDB <span class="attribute">AUTO_INCREMENT=<span class="attribute-value">1 DEFAULT <span class="attribute">CHARSET=<span class="attribute-value">utf8;  </span></span></span></span></span></span><br>12.<br>13.  – —————————-<br>14.  – Records of sys_permission<br>15.  – —————————-<br>16.  INSERT INTO <code>sys_permission</code> VALUES (‘10’, ‘/member/changeSessionStatus.shtml’, ‘用户Session踢出’,null);<br>17.  INSERT INTO <code>sys_permission</code> VALUES (‘11’, ‘/member/forbidUserById.shtml’, ‘用户激活&amp;禁止’,null);<br>18.  INSERT INTO <code>sys_permission</code> VALUES (‘12’, ‘/member/deleteUserById.shtml’, ‘用户删除’,null);<br>19.  INSERT INTO <code>sys_permission</code> VALUES (‘13’, ‘/permission/addPermission2Role.shtml’, ‘权限分配’,null);<br>20.  INSERT INTO <code>sys_permission</code> VALUES (‘14’, ‘/role/clearRoleByUserIds.shtml’, ‘用户角色分配清空’,null);<br>21.  INSERT INTO <code>sys_permission</code> VALUES (‘15’, ‘/role/addRole2User.shtml’, ‘角色分配保存’,null);<br>22.  INSERT INTO <code>sys_permission</code> VALUES (‘16’, ‘/role/deleteRoleById.shtml’, ‘角色列表删除’,null);<br>23.  INSERT INTO <code>sys_permission</code> VALUES (‘17’, ‘/role/addRole.shtml’, ‘角色列表添加’,null);<br>24.  INSERT INTO <code>sys_permission</code> VALUES (‘18’, ‘/role/index.shtml’, ‘角色列表’,null);<br>25.  INSERT INTO <code>sys_permission</code> VALUES (‘19’, ‘/permission/allocation.shtml’, ‘权限分配’,null);<br>26.  INSERT INTO <code>sys_permission</code> VALUES (‘20’, ‘/role/allocation.shtml’, ‘角色分配’,null);<br>27.  INSERT INTO <code>sys_permission</code> VALUES (‘4’, ‘/permission/index.shtml’, ‘权限列表’,null);<br>28.  INSERT INTO <code>sys_permission</code> VALUES (‘6’, ‘/permission/addPermission.shtml’, ‘权限添加’,null);<br>29.  INSERT INTO <code>sys_permission</code> VALUES (‘7’, ‘/permission/deletePermissionById.shtml’, ‘权限删除’,null);<br>30.  INSERT INTO <code>sys_permission</code> VALUES (‘8’, ‘/member/list.shtml’, ‘用户列表’,null);<br>31.  INSERT INTO <code>sys_permission</code> VALUES (‘9’, ‘/member/online.shtml’, ‘在线用户’,null);<br>32.<br>33.  – —————————-<br>34.  – Table structure for sys_role<br>35.  – —————————-<br>36.  DROP TABLE IF EXISTS <code>sys_role</code>;<br>37.  CREATE TABLE <code>sys_role</code> (<br>38.    <code>id</code> int(11) NOT NULL AUTO_INCREMENT COMMENT ‘主键ID’,<br>39.    <code>name</code> varchar(32) DEFAULT NULL COMMENT ‘角色名称’,<br>40.    <code>type</code> varchar(10) DEFAULT NULL COMMENT ‘角色类型’,<br>41.     PRIMARY KEY (<code>id</code>)<br>42.  ) <span class="attribute">ENGINE=<span class="attribute-value">InnoDB <span class="attribute">AUTO_INCREMENT=<span class="attribute-value">1 DEFAULT <span class="attribute">CHARSET=<span class="attribute-value">utf8;  </span></span></span></span></span></span><br>43.<br>44.  – —————————-<br>45.  – Records of sys_role<br>46.  – —————————-<br>47.  INSERT INTO <code>sys_role</code> VALUES (‘1’, ‘系统管理员’, ‘100004’);<br>48.  INSERT INTO <code>sys_role</code> VALUES (‘3’, ‘权限角色’, ‘100001’);<br>49.  INSERT INTO <code>sys_role</code> VALUES (‘4’, ‘用户中心’, ‘100002’);<br>50.  INSERT INTO <code>sys_role</code> VALUES (‘0’, ‘角色管理’, ‘100003’);<br>51.<br>52.  – —————————-<br>53.  – Table structure for sys_role_permission<br>54.  – —————————-<br>55.  DROP TABLE IF EXISTS <code>sys_role_permission</code>;<br>56.  CREATE TABLE <code>sys_role_permission</code> (<br>57.    <code>id</code> int(11) NOT NULL AUTO_INCREMENT COMMENT ‘主键ID’,<br>58.    <code>rid</code> varchar(64) DEFAULT NULL COMMENT ‘角色ID’,<br>59.    <code>pid</code> varchar(64) DEFAULT NULL COMMENT ‘权限ID’,<br>60.    PRIMARY KEY (<code>id</code>)<br>61.  ) <span class="attribute">ENGINE=<span class="attribute-value">InnoDB <span class="attribute">AUTO_INCREMENT=<span class="attribute-value">1 DEFAULT <span class="attribute">CHARSET=<span class="attribute-value">utf8;  </span></span></span></span></span></span><br>62.<br>63.  – —————————-<br>64.  – Records of sys_role_permission<br>65.  – —————————-<br>66.  INSERT INTO <code>sys_role_permission</code> VALUES (‘1’, ‘4’, ‘8’);<br>67.  INSERT INTO <code>sys_role_permission</code> VALUES (‘10’, ‘3’, ‘14’);<br>68.  INSERT INTO <code>sys_role_permission</code> VALUES (‘11’, ‘3’, ‘15’);<br>69.  INSERT INTO <code>sys_role_permission</code> VALUES (‘12’, ‘3’, ‘16’);<br>70.  INSERT INTO <code>sys_role_permission</code> VALUES (‘13’, ‘3’, ‘17’);<br>71.  INSERT INTO <code>sys_role_permission</code> VALUES (‘14’, ‘3’, ‘18’);<br>72.  INSERT INTO <code>sys_role_permission</code> VALUES (‘15’, ‘3’, ‘19’);<br>73.  INSERT INTO <code>sys_role_permission</code> VALUES (‘16’, ‘3’, ‘20’);<br>74.  INSERT INTO <code>sys_role_permission</code> VALUES (‘17’, ‘1’, ‘4’);<br>75.  INSERT INTO <code>sys_role_permission</code> VALUES (‘18’, ‘1’, ‘6’);<br>76.  INSERT INTO <code>sys_role_permission</code> VALUES (‘19’, ‘1’, ‘7’);<br>77.  INSERT INTO <code>sys_role_permission</code> VALUES (‘2’, ‘4’, ‘9’);<br>78.  INSERT INTO <code>sys_role_permission</code> VALUES (‘20’, ‘1’, ‘8’);<br>79.  INSERT INTO <code>sys_role_permission</code> VALUES (‘21’, ‘1’, ‘9’);<br>80.  INSERT INTO <code>sys_role_permission</code> VALUES (‘22’, ‘1’, ‘10’);<br>81.  INSERT INTO <code>sys_role_permission</code> VALUES (‘23’, ‘1’, ‘11’);<br>82.  INSERT INTO <code>sys_role_permission</code> VALUES (‘24’, ‘1’, ‘12’);<br>83.  INSERT INTO <code>sys_role_permission</code> VALUES (‘25’, ‘1’, ‘13’);<br>84.  INSERT INTO <code>sys_role_permission</code> VALUES (‘26’, ‘1’, ‘14’);<br>85.  INSERT INTO <code>sys_role_permission</code> VALUES (‘27’, ‘1’, ‘15’);<br>86.  INSERT INTO <code>sys_role_permission</code> VALUES (‘28’, ‘1’, ‘16’);<br>87.  INSERT INTO <code>sys_role_permission</code> VALUES (‘29’, ‘1’, ‘17’);<br>88.  INSERT INTO <code>sys_role_permission</code> VALUES (‘3’, ‘4’, ‘10’);<br>89.  INSERT INTO <code>sys_role_permission</code> VALUES (‘30’, ‘1’, ‘18’);<br>90.  INSERT INTO <code>sys_role_permission</code> VALUES (‘31’, ‘1’, ‘19’);<br>91.  INSERT INTO <code>sys_role_permission</code> VALUES (‘32’, ‘1’, ‘20’);<br>92.  INSERT INTO <code>sys_role_permission</code> VALUES (‘4’, ‘4’, ‘11’);<br>93.  INSERT INTO <code>sys_role_permission</code> VALUES (‘5’, ‘4’, ‘12’);<br>94.  INSERT INTO <code>sys_role_permission</code> VALUES (‘6’, ‘3’, ‘4’);<br>95.  INSERT INTO <code>sys_role_permission</code> VALUES (‘7’, ‘3’, ‘6’);<br>96.  INSERT INTO <code>sys_role_permission</code> VALUES (‘8’, ‘3’, ‘7’);<br>97.  INSERT INTO <code>sys_role_permission</code> VALUES (‘9’, ‘3’, ‘13’);<br>98.<br>99.  – —————————-<br>100.  – Table structure for sys_user<br>101.  – —————————-<br>102.  DROP TABLE IF EXISTS <code>sys_user</code>;<br>103.  CREATE TABLE <code>sys_user</code> (<br>104.    <code>id</code> int(11) NOT NULL AUTO_INCREMENT COMMENT ‘主键ID’,<br>105.    <code>nickname</code> varchar(20) DEFAULT NULL COMMENT ‘用户昵称’,<br>106.    <code>email</code> varchar(128) DEFAULT NULL COMMENT ‘邮箱|登录帐号’,<br>107.    <code>pswd</code> varchar(255) DEFAULT NULL COMMENT ‘密码’,<br>108.    <code>create_time</code> datetime DEFAULT NULL COMMENT ‘创建时间’,<br>109.    <code>last_login_time</code> datetime DEFAULT NULL COMMENT ‘最后登录时间’,<br>110.    <code>status</code> TINYINT DEFAULT ‘1’ COMMENT ‘1:有效，0:禁止登录’,<br>111.    PRIMARY KEY (<code>id</code>)<br>112.  ) <span class="attribute">ENGINE=<span class="attribute-value">InnoDB <span class="attribute">AUTO_INCREMENT=<span class="attribute-value">1 DEFAULT <span class="attribute">CHARSET=<span class="attribute-value">utf8;  </span></span></span></span></span></span><br>113.<br>114.  – —————————-<br>115.  – Records of sys_user<br>116.  – —————————-<br>117.  INSERT INTO <code>sys_user</code> VALUES (‘1’, ‘admin’, <a href="mailto:&#39;admin@qq.com" target="_blank" rel="noopener">&#39;admin@qq.com</a>‘, ‘123456’, NOW(), NOW(), ‘1’);<br>118.  INSERT INTO <code>sys_user</code> VALUES (‘11’, ‘root’, <a href="mailto:&#39;8446666@qq.com" target="_blank" rel="noopener">&#39;8446666@qq.com</a>‘, ‘123456’, ‘2016-05-26 20:50:54’, ‘2017-02-13 15:49:04’, ‘1’);<br>119.  INSERT INTO <code>sys_user</code> VALUES (‘12’, ‘8446666’, ‘8446666’, ‘CpievEp3tWpuK7exnZldGFzkQJDBPimEt+zG1EbUth6pmRt2pMLwSxtNJEhBRJRU’, ‘2016-05-27 22:34:19’, ‘2016-06-15 17:03:16’, ‘1’);<br>120.  INSERT INTO <code>sys_user</code> VALUES (‘13’, ‘123’, ‘123’, ‘CpievEp3tWpuK7exnZldGFzkQJDBPimEt+zG1EbUth6pmRt2pMLwSxtNJEhBRJRU’, ‘2016-05-27 22:34:19’, ‘2016-06-15 17:03:16’, ‘0’);<br>121.  INSERT INTO <code>sys_user</code> VALUES (‘14’, ‘haiqin’, <a href="mailto:&#39;123123@qq.com" target="_blank" rel="noopener">&#39;123123@qq.com</a>‘, ‘CpievEp3tWpuK7exnZldGFzkQJDBPimEt+zG1EbUth6pmRt2pMLwSxtNJEhBRJRU’, ‘2016-05-27 22:34:19’, ‘2017-03-23 21:39:44’, ‘1’);<br>122.  – —————————-<br>123.  – Table structure for sys_user_role<br>124.  – —————————-<br>125.  DROP TABLE IF EXISTS <code>sys_user_role</code>;<br>126.  CREATE TABLE <code>sys_user_role</code> (<br>127.    <code>id</code>  int(11) NOT NULL AUTO_INCREMENT COMMENT ‘主键ID’,<br>128.    <code>uid</code> varchar(64) DEFAULT NULL COMMENT ‘用户ID’,<br>129.    <code>rid</code> varchar(64) DEFAULT NULL COMMENT ‘角色ID’,<br>130.    PRIMARY KEY (<code>id</code>)<br>131.  ) <span class="attribute">ENGINE=<span class="attribute-value">InnoDB <span class="attribute">AUTO_INCREMENT=<span class="attribute-value">1 DEFAULT <span class="attribute">CHARSET=<span class="attribute-value">utf8;  </span></span></span></span></span></span><br>132.<br>133.  – —————————-<br>134.  – Records of sys_user_role<br>135.  – —————————-<br>136.  INSERT INTO <code>sys_user_role</code> VALUES (‘1’, ‘12’, ‘4’);<br>137.  INSERT INTO <code>sys_user_role</code> VALUES (‘2’, ‘11’, ‘3’);<br>138.  INSERT INTO <code>sys_user_role</code> VALUES (‘3’, ‘11’, ‘4’);<br>139.  INSERT INTO <code>sys_user_role</code> VALUES (‘4’, ‘1’, ‘1’);<br><br>（二）shiro配置类：<br><br><div class="dp-highlighter bg_html"><br><div class="bar"><br><div class="tools"><strong>[html]</strong> <a href="http://blog.csdn.net/aqsunkai/article/details/69757017#" title="view plain" target="_blank" rel="noopener">view plain</a><span class="tracking-ad" data-mod="popu_168"><span class="tracking-ad" data-mod="popu_168"> <a href="http://blog.csdn.net/aqsunkai/article/details/69757017#" title="copy" target="_blank" rel="noopener">copy</a></span></span><br><div><br><br>1.  package com.sun.configuration;<br>2.<br>3.  import org.apache.log4j.Logger;<br>4.  import org.apache.shiro.cache.ehcache.EhCacheManager;<br>5.  import org.apache.shiro.spring.LifecycleBeanPostProcessor;<br>6.  import org.apache.shiro.spring.security.interceptor.AuthorizationAttributeSourceAdvisor;<br>7.  import org.apache.shiro.spring.web.ShiroFilterFactoryBean;<br>8.  import org.apache.shiro.web.mgt.DefaultWebSecurityManager;<br>9.  import org.springframework.aop.framework.autoproxy.DefaultAdvisorAutoProxyCreator;<br>10.  import org.springframework.context.annotation.Bean;<br>11.  import org.springframework.context.annotation.Configuration;<br>12.  import org.springframework.transaction.annotation.EnableTransactionManagement;<br>13.<br>14.  import java.util.LinkedHashMap;<br>15.  import java.util.Map;<br>16.<br>17.  /<strong><br>18.   <em> Shiro 配置<br>19.   </em> Apache Shiro 核心通过 Filter 来实现，就好像SpringMvc 通过DispachServlet 来主控制一样。<br>20.   <em> 既然是使用 Filter 一般也就能猜到，是通过URL规则来进行过滤和权限校验，所以我们需要定义一系列关于URL的规则和访问权限。<br>21.   </em> Created by sun on 2017-4-2.<br>22.   */<br>23.  @Configuration<br>24.  @EnableTransactionManagement<br>25.  public class ShiroConfiguration{<br>26.<br>27.      private final Logger <span class="attribute">logger = <span class="attribute-value">Logger.getLogger(ShiroConfiguration.class);  </span></span><br>28.<br>29.      /</strong><br>30.       <em> ShiroFilterFactoryBean 处理拦截资源文件问题。<br>31.       </em> 注意：单独一个ShiroFilterFactoryBean配置是或报错的，因为在<br>32.       <em> 初始化ShiroFilterFactoryBean的时候需要注入：SecurityManager<br>33.       </em><br>34.       Filter Chain定义说明<br>35.       1、一个URL可以配置多个Filter，使用逗号分隔<br>36.       2、当设置多个过滤器时，全部验证通过，才视为通过<br>37.       3、部分过滤器可指定参数，如perms，roles<br>38.       <em><br>39.       </em>/<br>40.      @Bean<br>41.      public EhCacheManager getEhCacheManager(){<br>42.          EhCacheManager <span class="attribute">ehcacheManager = <span class="attribute-value">new EhCacheManager();  </span></span><br>43.          ehcacheManager.setCacheManagerConfigFile(“classpath:config/ehcache-shiro.xml”);<br>44.          return ehcacheManager;<br>45.      }<br>46.<br>47.      @Bean(<span class="attribute">name = <span class="attribute-value">“myShiroRealm”)  </span></span><br>48.      public MyShiroRealm myShiroRealm(EhCacheManager ehCacheManager){<br>49.          MyShiroRealm <span class="attribute">realm = <span class="attribute-value">new MyShiroRealm();  </span></span><br>50.          realm.setCacheManager(ehCacheManager);<br>51.          return realm;<br>52.      }<br>53.<br>54.      @Bean(<span class="attribute">name = <span class="attribute-value">“lifecycleBeanPostProcessor”)  </span></span><br>55.      public LifecycleBeanPostProcessor lifecycleBeanPostProcessor(){<br>56.          return new LifecycleBeanPostProcessor();<br>57.      }<br>58.<br>59.      @Bean<br>60.      public DefaultAdvisorAutoProxyCreator defaultAdvisorAutoProxyCreator(){<br>61.          DefaultAdvisorAutoProxyCreator <span class="attribute">creator = <span class="attribute-value">new DefaultAdvisorAutoProxyCreator();  </span></span><br>62.          creator.setProxyTargetClass(true);<br>63.          return creator;<br>64.      }<br>65.<br>66.      @Bean(<span class="attribute">name = <span class="attribute-value">“securityManager”)  </span></span><br>67.      public DefaultWebSecurityManager defaultWebSecurityManager(MyShiroRealm realm){<br>68.          DefaultWebSecurityManager <span class="attribute">securityManager = <span class="attribute-value">new DefaultWebSecurityManager();  </span></span><br>69.          //设置realm<br>70.          securityManager.setRealm(realm);<br>71.          securityManager.setCacheManager(getEhCacheManager());<br>72.          return securityManager;<br>73.      }<br>74.<br>75.      @Bean<br>76.      public AuthorizationAttributeSourceAdvisor authorizationAttributeSourceAdvisor(DefaultWebSecurityManager securityManager){<br>77.          AuthorizationAttributeSourceAdvisor <span class="attribute">advisor = <span class="attribute-value">new AuthorizationAttributeSourceAdvisor();  </span></span><br>78.          advisor.setSecurityManager(securityManager);<br>79.          return advisor;<br>80.      }<br>81.<br>82.      @Bean(<span class="attribute">name = <span class="attribute-value">“shiroFilter”)  </span></span><br>83.      public ShiroFilterFactoryBean shiroFilterFactoryBean(DefaultWebSecurityManager securityManager){<br>84.          ShiroFilterFactoryBean <span class="attribute">factoryBean = <span class="attribute-value">new MyShiroFilterFactoryBean();  </span></span><br>85.          factoryBean.setSecurityManager(securityManager);<br>86.          // 如果不设置默认会自动寻找Web工程根目录下的”/login.jsp”页面<br>87.          factoryBean.setLoginUrl(“/login”);<br>88.          // 登录成功后要跳转的连接<br>89.          factoryBean.setSuccessUrl(“/welcome”);<br>90.          factoryBean.setUnauthorizedUrl(“/403”);<br>91.          loadShiroFilterChain(factoryBean);<br>92.          logger.info(“shiro拦截器工厂类注入成功”);<br>93.          return factoryBean;<br>94.      }<br>95.<br>96.      /<strong><br>97.       <em> 加载ShiroFilter权限控制规则<br>98.       </em>/<br>99.      private void loadShiroFilterChain(ShiroFilterFactoryBean factoryBean) {<br>100.          /</strong>下面这些规则配置最好配置到配置文件中<em>/<br>101.          Map<span class="tag">&lt;<span class="tag-name">String, String<span class="tag">&gt; <span class="attribute">filterChainMap = <span class="attribute-value">new LinkedHashMap<span class="tag">&lt;<span class="tag-name">String, String<span class="tag">&gt;();  </span></span></span></span></span></span></span></span><br>102.          /** authc：该过滤器下的页面必须验证后才能访问，它是Shiro内置的一个拦截器<br>103.           </em> org.apache.shiro.web.filter.authc.FormAuthenticationFilter <em>/<br>104.          // anon：它对应的过滤器里面是空的,什么都没做,可以理解为不拦截<br>105.          //authc:所有url都必须认证通过才可以访问; anon:所有url都都可以匿名访问<br>106.          filterChainMap.put(“/permission/userInsert”, “anon”);<br>107.          filterChainMap.put(“/error”, “anon”);<br>108.          filterChainMap.put(“/tUser/insert”,”anon”);<br>109.          filterChainMap.put(“/**”, “authc”);<br>110.<br>111.          factoryBean.setFilterChainDefinitionMap(filterChainMap);<br>112.      }<br>113.<br>114.      /</em>1.LifecycleBeanPostProcessor，这是个DestructionAwareBeanPostProcessor的子类，负责org.apache.shiro.util.Initializable类型bean的生命周期的，初始化和销毁。主要是AuthorizingRealm类的子类，以及EhCacheManager类。<br>115.      2.HashedCredentialsMatcher，这个类是为了对密码进行编码的，防止密码在数据库里明码保存，当然在登陆认证的生活，这个类也负责对form里输入的密码进行编码。<br>116.      3.ShiroRealm，这是个自定义的认证类，继承自AuthorizingRealm，负责用户的认证和权限的处理，可以参考JdbcRealm的实现。<br>117.      4.EhCacheManager，缓存管理，用户登陆成功后，把用户信息和权限信息缓存起来，然后每次用户请求时，放入用户的session中，如果不设置这个bean，每个请求都会查询一次数据库。<br>118.      5.SecurityManager，权限管理，这个类组合了登陆，登出，权限，session的处理，是个比较重要的类。<br>119.      6.ShiroFilterFactoryBean，是个factorybean，为了生成ShiroFilter。它主要保持了三项数据，securityManager，filters，filterChainDefinitionManager。<br>120.      7.DefaultAdvisorAutoProxyCreator，Spring的一个bean，由Advisor决定对哪些类的方法进行AOP代理。<br>121.      8.AuthorizationAttributeSourceAdvisor，shiro里实现的Advisor类，内部使用AopAllianceAnnotationsAuthorizingMethodInterceptor来拦截用以下注解的方法。<em>/<br>122.<br>123.  }<br><br><div class="dp-highlighter bg_html"><br><div class="bar"><br><div class="tools"><strong>[html]</strong> <a href="http://blog.csdn.net/aqsunkai/article/details/69757017#" title="view plain" target="_blank" rel="noopener">view plain</a><span class="tracking-ad" data-mod="popu_168"><span class="tracking-ad" data-mod="popu_168"> <a href="http://blog.csdn.net/aqsunkai/article/details/69757017#" title="copy" target="_blank" rel="noopener">copy</a></span></span><br><div><br><br>1.  package com.sun.configuration;<br>2.<br>3.  import org.apache.shiro.mgt.SecurityManager;<br>4.  import org.apache.shiro.spring.web.ShiroFilterFactoryBean;<br>5.  import org.apache.shiro.web.filter.mgt.FilterChainManager;<br>6.  import org.apache.shiro.web.filter.mgt.PathMatchingFilterChainResolver;<br>7.  import org.apache.shiro.web.mgt.WebSecurityManager;<br>8.  import org.apache.shiro.web.servlet.AbstractShiroFilter;<br>9.  import org.springframework.beans.factory.BeanInitializationException;<br>10.<br>11.  import javax.servlet.FilterChain;<br>12.  import javax.servlet.ServletException;<br>13.  import javax.servlet.ServletRequest;<br>14.  import javax.servlet.ServletResponse;<br>15.  import javax.servlet.http.HttpServletRequest;<br>16.  import java.io.IOException;<br>17.  import java.util.HashSet;<br>18.  import java.util.Set;<br>19.<br>20.  /**<br>21.   </div></div></div></div></em> Created by sun on 2017-4-2.<br>22.   <em>/<br>23.  public class MyShiroFilterFactoryBean extends ShiroFilterFactoryBean {<br>24.      // ShiroFilter将直接忽略的请求<br>25.      private Set<span class="tag">&lt;<span class="tag-name">String<span class="tag">&gt; ignoreExt;  </span></span></span><br>26.<br>27.      public MyShiroFilterFactoryBean(){<br>28.          super();<br>29.          <span class="attribute">ignoreExt = <span class="attribute-value">new HashSet<span class="tag">&lt;<span class="tag-name">String<span class="tag">&gt;();  </span></span></span></span></span><br>30.          ignoreExt.add(“.jpg”);<br>31.          ignoreExt.add(“.png”);<br>32.          ignoreExt.add(“.gif”);<br>33.          ignoreExt.add(“.bmp”);<br>34.          ignoreExt.add(“.js”);<br>35.          ignoreExt.add(“.css”);<br>36.      }<br>37.      /**<br>38.       </em> 启动时加载<br>39.       <em>/<br>40.      @Override<br>41.      protected AbstractShiroFilter createInstance() throws Exception {<br>42.          SecurityManager <span class="attribute">securityManager = <span class="attribute-value">getSecurityManager();  </span></span><br>43.          if (<span class="attribute">securityManager == null){  </span><br>44.              throw new BeanInitializationException(“SecurityManager property must be set.”);<br>45.          }<br>46.<br>47.          if (!(securityManager instanceof WebSecurityManager)){<br>48.              throw new BeanInitializationException(“The security manager does not implement the WebSecurityManager interface.”);<br>49.          }<br>50.<br>51.          PathMatchingFilterChainResolver <span class="attribute">chainResolver = <span class="attribute-value">new PathMatchingFilterChainResolver();  </span></span><br>52.          FilterChainManager <span class="attribute">chainManager = <span class="attribute-value">createFilterChainManager();  </span></span><br>53.          chainResolver.setFilterChainManager(chainManager);<br>54.          return new MySpringShiroFilter((WebSecurityManager)securityManager, chainResolver);<br>55.      }<br>56.<br>57.      /**<br>58.       </em> 启动时加载<br>59.       <em>/<br>60.      private class MySpringShiroFilter extends AbstractShiroFilter {<br>61.          public MySpringShiroFilter(<br>62.                  WebSecurityManager securityManager, PathMatchingFilterChainResolver chainResolver) {<br>63.              super();<br>64.              if (<span class="attribute">securityManager == null){  </span><br>65.                  throw new IllegalArgumentException(“WebSecurityManager property cannot be null.”);<br>66.              }<br>67.              setSecurityManager(securityManager);<br>68.              if (chainResolver != null){<br>69.                  setFilterChainResolver(chainResolver);<br>70.              }<br>71.          }<br>72.          /**<br>73.           </em> 页面上传输的url先进入此方法验证<br>74.           <em>/<br>75.          @Override<br>76.          protected void doFilterInternal(ServletRequest servletRequest, ServletResponse servletResponse,<br>77.                                          FilterChain chain)<br>78.                  throws ServletException, IOException {<br>79.              HttpServletRequest <span class="attribute">request = (HttpServletRequest)servletRequest;  </span><br>80.              String <span class="attribute">str = <span class="attribute-value">request.getRequestURI().toLowerCase();  </span></span><br>81.              boolean <span class="attribute">flag = <span class="attribute-value">true;  </span></span><br>82.              int <span class="attribute">idx = <span class="attribute-value">0;  </span></span><br>83.              if ((<span class="attribute">idx = <span class="attribute-value">str.lastIndexOf(“.”)) <span class="tag">&gt; 0){  </span></span></span><br>84.                  <span class="attribute">str = <span class="attribute-value">str.substring(idx);  </span></span><br>85.                  if (ignoreExt.contains(str.toLowerCase())){<br>86.                      <span class="attribute">flag = <span class="attribute-value">false;  </span></span><br>87.                  }<br>88.              }<br>89.              if (flag){<br>90.                  super.doFilterInternal(servletRequest, servletResponse, chain);<br>91.              } else {<br>92.                  chain.doFilter(servletRequest, servletResponse);<br>93.              }<br>94.          }<br>95.      }<br>96.  }<br><br><div class="dp-highlighter bg_html"><br><div class="bar"><br><div class="tools"><strong>[html]</strong> <a href="http://blog.csdn.net/aqsunkai/article/details/69757017#" title="view plain" target="_blank" rel="noopener">view plain</a><span class="tracking-ad" data-mod="popu_168"><span class="tracking-ad" data-mod="popu_168"> <a href="http://blog.csdn.net/aqsunkai/article/details/69757017#" title="copy" target="_blank" rel="noopener">copy</a></span></span><br><div><br><br>1.  package com.sun.configuration;<br>2.<br>3.  import com.sun.permission.model.Role;<br>4.  import com.sun.permission.model.User;<br>5.  import com.sun.permission.service.PermissionService;<br>6.  import org.apache.commons.lang3.builder.ReflectionToStringBuilder;<br>7.  import org.apache.commons.lang3.builder.ToStringStyle;<br>8.  import org.apache.log4j.Logger;<br>9.  import org.apache.shiro.authc.</div></div></div></div></em>;<br>10.  import org.apache.shiro.authz.AuthorizationInfo;<br>11.  import org.apache.shiro.authz.SimpleAuthorizationInfo;<br>12.  import org.apache.shiro.realm.AuthorizingRealm;<br>13.  import org.apache.shiro.subject.PrincipalCollection;<br>14.  import org.springframework.beans.factory.annotation.Autowired;<br>15.<br>16.  import java.util.List;<br>17.<br>18.  /<strong><br>19.   <em> shiro的认证最终是交给了Realm进行执行<br>20.   </em> 所以我们需要自己重新实现一个Realm，此Realm继承AuthorizingRealm<br>21.   <em> Created by sun on 2017-4-2.<br>22.   </em>/<br>23.  public class MyShiroRealm extends AuthorizingRealm {<br>24.<br>25.      private static final Logger <span class="attribute">logger = <span class="attribute-value">Logger.getLogger(MyShiroRealm.class);  </span></span><br>26.      @Autowired<br>27.      private PermissionService permissionService;<br>28.      /</strong><br>29.       <em> 登录认证<br>30.       </em>/<br>31.      @Override<br>32.      protected AuthenticationInfo doGetAuthenticationInfo(AuthenticationToken authenticationToken) throws AuthenticationException {<br>33.          //UsernamePasswordToken用于存放提交的登录信息<br>34.          UsernamePasswordToken <span class="attribute">token = (UsernamePasswordToken)authenticationToken;  </span><br>35.          logger.info(“登录认证!”);<br>36.          logger.info(“验证当前Subject时获取到token为：” + ReflectionToStringBuilder.toString(token, ToStringStyle.MULTI_LINE_STYLE));<br>37.          User <span class="attribute">user = <span class="attribute-value">permissionService.findByUserEmail(token.getUsername());  </span></span><br>38.          if (user != null){<br>39.              logger.info(“用户: “ + user.getEmail());<br>40.              if(user.getStatus() == 0){<br>41.                  throw new DisabledAccountException();<br>42.              }<br>43.              // 若存在，将此用户存放到登录认证info中，无需自己做密码对比，Shiro会为我们进行密码对比校验<br>44.              return new SimpleAuthenticationInfo(user.getEmail(), user.getPswd(), getName());<br>45.          }<br>46.          return null;<br>47.      }<br>48.<br>49.      /<strong><br>50.       <em> 权限认证（为当前登录的Subject授予角色和权限）<br>51.       </em><br>52.       <em> 该方法的调用时机为需授权资源被访问时，并且每次访问需授权资源都会执行该方法中的逻辑，这表明本例中并未启用AuthorizationCache，<br>53.       </em> 如果连续访问同一个URL（比如刷新），该方法不会被重复调用，Shiro有一个时间间隔（也就是cache时间，在ehcache-shiro.xml中配置），<br>54.       <em> 超过这个时间间隔再刷新页面，该方法会被执行<br>55.       </em><br>56.       <em> doGetAuthorizationInfo()是权限控制，<br>57.       </em> 当访问到页面的时候，使用了相应的注解或者shiro标签才会执行此方法否则不会执行，<br>58.       <em> 所以如果只是简单的身份认证没有权限的控制的话，那么这个方法可以不进行实现，直接返回null即可<br>59.       </em>/<br>60.      @Override<br>61.      protected AuthorizationInfo doGetAuthorizationInfo(PrincipalCollection principals) {<br>62.          String <span class="attribute">loginName = (String) super.getAvailablePrincipal(principals);  </span><br>63.          User <span class="attribute">user = <span class="attribute-value">permissionService.findByUserEmail(loginName);  </span></span><br>64.          logger.info(“权限认证!”);<br>65.          if (user != null){<br>66.              // 权限信息对象info，用来存放查出的用户的所有的角色及权限<br>67.              SimpleAuthorizationInfo <span class="attribute">info = <span class="attribute-value">new SimpleAuthorizationInfo();  </span></span><br>68.              //用户的角色集合<br>69.              info.setRoles(permissionService.getRolesName(user.getId()));<br>70.              List<span class="tag">&lt;<span class="tag-name">Role<span class="tag">&gt; <span class="attribute">roleList = <span class="attribute-value">permissionService.getRoleList(user.getId());  </span></span></span></span></span><br>71.              for (Role role : roleList){<br>72.                  //用户的角色对应的所有权限<br>73.                  logger.info(“角色: “+role.getName());<br>74.                  info.addStringPermissions(permissionService.getPermissionsName(role.getId()));<br>75.              }<br>76.              return info;<br>77.          }<br>78.          // 返回null将会导致用户访问任何被拦截的请求时都会自动跳转到unauthorizedUrl指定的地址<br>79.          return null;<br>80.      }<br>81.  }<br><br>ehcache-shiro.xml内容：<br><br><div class="dp-highlighter bg_html"><br><div class="bar"><br><div class="tools"></div></div></div></strong>[html]<strong> <a href="http://blog.csdn.net/aqsunkai/article/details/69757017#" title="view plain" target="_blank" rel="noopener">view plain</a><span class="tracking-ad" data-mod="popu_168"><span class="tracking-ad" data-mod="popu_168"> <a href="http://blog.csdn.net/aqsunkai/article/details/69757017#" title="copy" target="_blank" rel="noopener">copy</a></span></span><br><div><br><br>1.  <span class="tag">&lt;?<span class="tag-name">xml <span class="attribute">version=<span class="attribute-value">“1.0” <span class="attribute">encoding=<span class="attribute-value">“UTF-8”<span class="tag">?&gt;  </span></span></span></span></span></span></span><br>2.  <span class="tag">&lt;<span class="tag-name">ehcache <span class="attribute">updateCheck=<span class="attribute-value">“false” <span class="attribute">name=<span class="attribute-value">“shiroCache”<span class="tag">&gt;  </span></span></span></span></span></span></span><br>3.      <!--  
4.         name:缓存名称。  
5.         maxElementsInMemory:缓存最大数目  
6.         maxElementsOnDisk：硬盘最大缓存个数。  
7.         eternal:对象是否永久有效，一但设置了，timeout将不起作用。  
8.         overflowToDisk:是否保存到磁盘，当系统当机时  
9.         timeToIdleSeconds:设置对象在失效前的允许闲置时间（单位：秒）。仅当<span class="attribute">eternal=<span class="attribute-value">false对象不是永久有效时使用，可选属性，默认值是0，也就是可闲置时间无穷大。  </span></span>
10.         timeToLiveSeconds:设置对象在失效前允许存活时间（单位：秒）。最大时间介于创建时间和失效时间之间。仅当<span class="attribute">eternal=<span class="attribute-value">false对象不是永久有效时使用，默认是0.，也就是对象存活时间无穷大。  </span></span>
11.         diskPersistent：是否缓存虚拟机重启期数据 Whether the disk store persists between restarts of the Virtual Machine. The default value is false.  
12.         diskSpoolBufferSizeMB：这个参数设置DiskStore（磁盘缓存）的缓存区大小。默认是30MB。每个Cache都应该有自己的一个缓冲区。  
13.         diskExpiryThreadIntervalSeconds：磁盘失效线程运行时间间隔，默认是120秒。  
14.         memoryStoreEvictionPolicy：当达到maxElementsInMemory限制时，Ehcache将会根据指定的策略去清理内存。默认策略是LRU（最近最少使用）。你可以设置为FIFO（先进先出）或是LFU（较少使用）。  
15.          clearOnFlush：内存数量最大时是否清除。  
16.           memoryStoreEvictionPolicy:  
17.              Ehcache的三种清空策略;  
18.              FIFO，first in first out，这个是大家最熟的，先进先出。  
19.              LFU， Less Frequently Used，就是上面例子中使用的策略，直白一点就是讲一直以来最少被使用的。如上面所讲，缓存的元素有一个hit属性，hit值最小的将会被清出缓存。  
20.              LRU，Least Recently Used，最近最少使用的，缓存的元素有一个时间戳，当缓存容量满了，而又需要腾出地方来缓存新的元素的时候，那么现有缓存元素中时间戳离当前时间最远的元素将被清出缓存。  
21.      --<span class="tag">>  </span>
22.      <span class="tag"><<span class="tag-name">defaultCache  </span></span>
23.              <span class="attribute">maxElementsInMemory=<span class="attribute-value">"10000"  </span></span>
24.              <span class="attribute">eternal=<span class="attribute-value">"false"  </span></span>
25.              <span class="attribute">timeToIdleSeconds=<span class="attribute-value">"120"  </span></span>
26.              <span class="attribute">timeToLiveSeconds=<span class="attribute-value">"120"  </span></span>
27.              <span class="attribute">overflowToDisk=<span class="attribute-value">"false"  </span></span>
28.              <span class="attribute">diskPersistent=<span class="attribute-value">"false"  </span></span>
29.              <span class="attribute">diskExpiryThreadIntervalSeconds=<span class="attribute-value">"120"  </span></span>
30.      <span class="tag">/>  </span>
31.      <span class="comments"><!-- 登录记录缓存锁定10分钟 -->  <br>32.      <span class="tag">&lt;<span class="tag-name">cache <span class="attribute">name=<span class="attribute-value">“passwordRetryCache”  </span></span></span></span><br>33.             <span class="attribute">maxEntriesLocalHeap=<span class="attribute-value">“2000”  </span></span><br>34.             <span class="attribute">eternal=<span class="attribute-value">“false”  </span></span><br>35.             <span class="attribute">timeToIdleSeconds=<span class="attribute-value">“3600”  </span></span><br>36.             <span class="attribute">timeToLiveSeconds=<span class="attribute-value">“0”  </span></span><br>37.             <span class="attribute">overflowToDisk=<span class="attribute-value">“false”  </span></span><br>38.             <span class="attribute">statistics=<span class="attribute-value">“true”<span class="tag">&gt;  </span></span></span><br>39.      <span class="tag">&lt;/<span class="tag-name">cache<span class="tag">&gt;  </span></span></span><br>40.  <span class="tag">&lt;/<span class="tag-name">ehcache<span class="tag">&gt;  </span></span></span><br><br> 登录的controller类如下：<br><br><div class="dp-highlighter bg_html"><br><div class="bar"><br><div class="tools"></div></div></div></div></strong>[html]<strong> <a href="http://blog.csdn.net/aqsunkai/article/details/69757017#" title="view plain" target="_blank" rel="noopener">view plain</a><span class="tracking-ad" data-mod="popu_168"><span class="tracking-ad" data-mod="popu_168"> <a href="http://blog.csdn.net/aqsunkai/article/details/69757017#" title="copy" target="_blank" rel="noopener">copy</a></span></span><br><div><br><br>1.  package com.sun.permission.controller;<br>2.<br>3.  import com.sun.permission.model.User;<br>4.  import com.sun.permission.service.PermissionService;<br>5.  import com.sun.util.CommonUtils;<br>6.  import org.apache.commons.lang3.StringUtils;<br>7.  import org.apache.log4j.Logger;<br>8.  import org.apache.shiro.SecurityUtils;<br>9.  import org.apache.shiro.authc.*;<br>10.  import org.apache.shiro.session.Session;<br>11.  import org.apache.shiro.subject.Subject;<br>12.  import org.springframework.beans.factory.annotation.Autowired;<br>13.  import org.springframework.stereotype.Controller;<br>14.  import org.springframework.validation.BindingResult;<br>15.  import org.springframework.web.bind.annotation.RequestMapping;<br>16.  import org.springframework.web.bind.annotation.RequestMethod;<br>17.  import org.springframework.web.servlet.ModelAndView;<br>18.  import org.springframework.web.servlet.mvc.support.RedirectAttributes;<br>19.<br>20.  import javax.validation.Valid;<br>21.<br>22.  /</div></strong><br>23.   <em> Created by sun on 2017-4-2.<br>24.   </em>/<br>25.  @Controller<br>26.  public class LoginController {<br>27.      private static final Logger <span class="attribute">logger = <span class="attribute-value">Logger.getLogger(LoginController.class);  </span></span><br>28.      @Autowired<br>29.      private PermissionService permissionService;<br>30.<br>31.      @RequestMapping(<span class="attribute">value=<span class="attribute-value">“/login”,<span class="attribute">method= <span class="attribute-value">RequestMethod.GET)  </span></span></span></span><br>32.      public ModelAndView loginForm(){<br>33.          ModelAndView <span class="attribute">model = <span class="attribute-value">new ModelAndView();  </span></span><br>34.          model.addObject(“user”, new User());<br>35.          model.setViewName(“login”);<br>36.          return model;<br>37.      }<br>38.<br>39.      @RequestMapping(<span class="attribute">value=<span class="attribute-value">“/login”,<span class="attribute">method=<span class="attribute-value">RequestMethod.POST)  </span></span></span></span><br>40.      public String login(@Valid User user, BindingResult bindingResult, RedirectAttributes redirectAttributes){<br>41.          if(bindingResult.hasErrors()){<br>42.              return “redirect:login”;<br>43.          }<br>44.          String <span class="attribute">email = <span class="attribute-value">user.getEmail();  </span></span><br>45.          if(StringUtils.isBlank(user.getEmail()) || StringUtils.isBlank(user.getPswd())){<br>46.              logger.info(“用户名或密码为空! “);<br>47.              redirectAttributes.addFlashAttribute(“message”, “用户名或密码为空!”);<br>48.              return “redirect:login”;<br>49.          }<br>50.          //验证<br>51.          UsernamePasswordToken <span class="attribute">token = <span class="attribute-value">new UsernamePasswordToken(user.getEmail(), user.getPswd());  </span></span><br>52.          //获取当前的Subject<br>53.          Subject <span class="attribute">currentUser = <span class="attribute-value">SecurityUtils.getSubject();  </span></span><br>54.          try {<br>55.              //在调用了login方法后,SecurityManager会收到AuthenticationToken,并将其发送给已配置的Realm执行必须的认证检查<br>56.              //每个Realm都能在必要时对提交的AuthenticationTokens作出反应<br>57.              //所以这一步在调用login(token)方法时,它会走到MyRealm.doGetAuthenticationInfo()方法中,具体验证方式详见此方法<br>58.              logger.info(“对用户[“ + email + “]进行登录验证..验证开始”);<br>59.              currentUser.login(token);<br>60.              logger.info(“对用户[“ + email + “]进行登录验证..验证通过”);<br>61.          }catch(UnknownAccountException uae){<br>62.              logger.info(“对用户[“ + email + “]进行登录验证..验证未通过,未知账户”);<br>63.              redirectAttributes.addFlashAttribute(“message”, “未知账户”);<br>64.          }catch(IncorrectCredentialsException ice){<br>65.              logger.info(“对用户[“ + email + “]进行登录验证..验证未通过,错误的凭证”);<br>66.              redirectAttributes.addFlashAttribute(“message”, “密码不正确”);<br>67.          }catch(LockedAccountException lae){<br>68.              logger.info(“对用户[“ + email + “]进行登录验证..验证未通过,账户已锁定”);<br>69.              redirectAttributes.addFlashAttribute(“message”, “账户已锁定”);<br>70.          }catch(ExcessiveAttemptsException eae){<br>71.              logger.info(“对用户[“ + email + “]进行登录验证..验证未通过,错误次数大于5次,账户已锁定”);<br>72.              redirectAttributes.addFlashAttribute(“message”, “用户名或密码错误次数大于5次,账户已锁定”);<br>73.          }catch (DisabledAccountException sae){<br>74.              logger.info(“对用户[“ + email + “]进行登录验证..验证未通过,帐号已经禁止登录”);<br>75.              redirectAttributes.addFlashAttribute(“message”, “帐号已经禁止登录”);<br>76.          }catch(AuthenticationException ae){<br>77.              //通过处理Shiro的运行时AuthenticationException就可以控制用户登录失败或密码错误时的情景<br>78.              logger.info(“对用户[“ + email + “]进行登录验证..验证未通过,堆栈轨迹如下”);<br>79.              ae.printStackTrace();<br>80.              redirectAttributes.addFlashAttribute(“message”, “用户名或密码不正确”);<br>81.          }<br>82.          //验证是否登录成功<br>83.          if(currentUser.isAuthenticated()){<br>84.              logger.info(“用户[“ + email + “]登录认证通过(这里可以进行一些认证通过后的一些系统参数初始化操作)”);<br>85.              //把当前用户放入session<br>86.              Session <span class="attribute">session = <span class="attribute-value">currentUser.getSession();  </span></span><br>87.              User <span class="attribute">tUser = <span class="attribute-value">permissionService.findByUserEmail(email);  </span></span><br>88.              session.setAttribute(“currentUser”,tUser);<br>89.              return “/welcome”;<br>90.          }else{<br>91.              token.clear();<br>92.              return “redirect:login”;<br>93.          }<br>94.      }<br>95.<br>96.      @RequestMapping(<span class="attribute">value=<span class="attribute-value">“/logout”,<span class="attribute">method=<span class="attribute-value">RequestMethod.GET)  </span></span></span></span><br>97.      public String logout(RedirectAttributes redirectAttributes ){<br>98.          //使用权限管理工具进行用户的退出，跳出登录，给出提示信息<br>99.          SecurityUtils.getSubject().logout();<br>100.          redirectAttributes.addFlashAttribute(“message”, “您已安全退出”);<br>101.          return “redirect:login”;<br>102.      }<br>103.<br>104.      @RequestMapping(“/403”)<br>105.      public String unauthorizedRole(){<br>106.          logger.info(“——没有权限——-“);<br>107.          return “errorPermission”;<br>108.      }<br>109.<br>110.  }<br><br>login.jsp如下：<br><br><div class="dp-highlighter bg_html"><br><div class="bar"><br><div class="tools"><strong>[html]</strong> <a href="http://blog.csdn.net/aqsunkai/article/details/69757017#" title="view plain" target="_blank" rel="noopener">view plain</a><span class="tracking-ad" data-mod="popu_168"><span class="tracking-ad" data-mod="popu_168"> <a href="http://blog.csdn.net/aqsunkai/article/details/69757017#" title="copy" target="_blank" rel="noopener">copy</a></span></span><br><div><br><br>1.  <span class="tag">&lt;%@ page <span class="attribute">language=<span class="attribute-value">“java” <span class="attribute">import=<span class="attribute-value">“java.util.*” <span class="attribute">pageEncoding=<span class="attribute-value">“UTF-8”%<span class="tag">&gt;  </span></span></span></span></span></span></span></span><br>2.  <span class="tag">&lt;%  </span><br>3.  String <span class="attribute">path = <span class="attribute-value">request.getContextPath();  </span></span><br>4.  String <span class="attribute">basePath = <span class="attribute-value">request.getScheme()+”://“+request.getServerName()+”:”+request.getServerPort()+path+”/“;  </span></span><br>5.  %<span class="tag">&gt;  </span><br>6.<br>7.  &lt;!DOCTYPE HTML PUBLIC “-//W3C//DTD HTML 4.01 Transitional//EN”<span class="tag">&gt;  </span><br>8.  <span class="tag">&lt;<span class="tag-name">html<span class="tag">&gt;  </span></span></span><br>9.    <span class="tag">&lt;<span class="tag-name">head<span class="tag">&gt;  </span></span></span><br>10.      <span class="tag">&lt;<span class="tag-name">base <span class="attribute">href=<span class="attribute-value">“&lt;%=basePath%&gt;”<span class="tag">&gt;  </span></span></span></span></span><br>11.<br>12.      <span class="tag">&lt;<span class="tag-name">title<span class="tag">&gt;Login<span class="tag">&lt;/<span class="tag-name">title<span class="tag">&gt;  </span></span></span></span></span></span><br>13.      <span class="tag">&lt;<span class="tag-name">meta <span class="attribute">http-equiv=<span class="attribute-value">“pragma” <span class="attribute">content=<span class="attribute-value">“no-cache”<span class="tag">&gt;  </span></span></span></span></span></span></span><br>14.      <span class="tag">&lt;<span class="tag-name">meta <span class="attribute">http-equiv=<span class="attribute-value">“cache-control” <span class="attribute">content=<span class="attribute-value">“no-cache”<span class="tag">&gt;  </span></span></span></span></span></span></span><br>15.      <span class="tag">&lt;<span class="tag-name">meta <span class="attribute">http-equiv=<span class="attribute-value">“expires” <span class="attribute">content=<span class="attribute-value">“0”<span class="tag">&gt;      </span></span></span></span></span></span></span><br>16.      <span class="tag">&lt;<span class="tag-name">meta <span class="attribute">http-equiv=<span class="attribute-value">“keywords” <span class="attribute">content=<span class="attribute-value">“keyword1,keyword2,keyword3”<span class="tag">&gt;  </span></span></span></span></span></span></span><br>17.      <span class="tag">&lt;<span class="tag-name">meta <span class="attribute">http-equiv=<span class="attribute-value">“description” <span class="attribute">content=<span class="attribute-value">“This is my page”<span class="tag">&gt;  </span></span></span></span></span></span></span><br>18.      <span class="comments"><!-- </span>
19.  <span class="comments">    <link rel="stylesheet" type="text/css" href="styles.css"> </span>
20.  <span class="comments">    -->  </span><br>21.      <span class="tag">&lt;<span class="tag-name">script <span class="attribute">src=<span class="attribute-value">“&lt;%=basePath%&gt;js/jquery-2.1.4/jquery.min.js”<span class="tag">&gt;<span class="tag">&lt;/<span class="tag-name">script<span class="tag">&gt;  </span></span></span></span></span></span></span></span><br>22.    <span class="tag">&lt;/<span class="tag-name">head<span class="tag">&gt;  </span></span></span><br>23.<br>24.    <span class="tag">&lt;<span class="tag-name">body <span class="attribute">style=<span class="attribute-value">“margin-left: 500px”<span class="tag">&gt;  </span></span></span></span></span><br>25.       <span class="tag">&lt;<span class="tag-name">h1 <span class="attribute">style=<span class="attribute-value">“margin-left: 30px”<span class="tag">&gt;登录页面—-<span class="tag">&lt;/<span class="tag-name">h1<span class="tag">&gt;  </span></span></span></span></span></span></span></span><br>26.       <span class="tag">&lt;<span class="tag-name">form <span class="attribute">action=<span class="attribute-value">“&lt;%=basePath%&gt;/login” <span class="attribute">method=<span class="attribute-value">“post”<span class="tag">&gt;  </span></span></span></span></span></span></span><br>27.           用户名 : <span class="tag">&lt;<span class="tag-name">input <span class="attribute">type=<span class="attribute-value">“text” <span class="attribute">name=<span class="attribute-value">“email” <span class="attribute">id=<span class="attribute-value">“email”<span class="tag">/&gt;<span class="tag">&lt;<span class="tag-name">br<span class="tag">&gt;  </span></span></span></span></span></span></span></span></span></span></span></span><br>28.           密码: <span class="tag">&lt;<span class="tag-name">input <span class="attribute">type=<span class="attribute-value">“password” <span class="attribute">name=<span class="attribute-value">“pswd” <span class="attribute">id=<span class="attribute-value">“pswd”<span class="tag">/&gt;<span class="tag">&lt;<span class="tag-name">br<span class="tag">&gt;  </span></span></span></span></span></span></span></span></span></span></span></span><br>29.           <span class="tag">&lt;<span class="tag-name">input <span class="attribute">style=<span class="attribute-value">“margin-left: 100px” <span class="attribute">type=<span class="attribute-value">“submit” <span class="attribute">value=<span class="attribute-value">“登录”<span class="tag">/&gt;<span class="tag">&lt;<span class="tag-name">input <span class="attribute">style=<span class="attribute-value">“left: 50px” <span class="attribute">onclick=<span class="attribute-value">“register()” <span class="attribute">type=<span class="attribute-value">“button” <span class="attribute">value=<span class="attribute-value">“注册”<span class="tag">/&gt;  </span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><br>30.       <span class="tag">&lt;/<span class="tag-name">form<span class="tag">&gt;  </span></span></span><br>31.       <span class="tag">&lt;<span class="tag-name">h1 <span class="attribute">style=<span class="attribute-value">“color: red”<span class="tag">&gt;${message }<span class="tag">&lt;/<span class="tag-name">h1<span class="tag">&gt;  </span></span></span></span></span></span></span></span><br>32.    <span class="tag">&lt;/<span class="tag-name">body<span class="tag">&gt;  </span></span></span><br>33.    <span class="tag">&lt;<span class="tag-name">script <span class="attribute">type=<span class="attribute-value">“text/javascript”<span class="tag">&gt;  </span></span></span></span></span><br>34.<br>35.        function register(){<br>36.            <span class="attribute">location.href=<span class="attribute-value">“&lt;%=basePath%&gt;permission/userInsert”;  </span></span><br>37.        }<br>38.<br>39.    <span class="tag">&lt;/<span class="tag-name">script<span class="tag">&gt;  </span></span></span><br>40.  <span class="tag">&lt;/<span class="tag-name">html<span class="tag">&gt;  </span></span></span><br><br> welcome.jsp如下：<br><br><div class="dp-highlighter bg_html"><br><div class="bar"><br><div class="tools"><strong>[html]</strong> <a href="http://blog.csdn.net/aqsunkai/article/details/69757017#" title="view plain" target="_blank" rel="noopener">view plain</a><span class="tracking-ad" data-mod="popu_168"><span class="tracking-ad" data-mod="popu_168"> <a href="http://blog.csdn.net/aqsunkai/article/details/69757017#" title="copy" target="_blank" rel="noopener">copy</a></span></span><br><div><br><br>1.  <span class="tag">&lt;%–  </span><br>2.    Created by IntelliJ IDEA.<br>3.    User: sun<br>4.    Date: 2017-4-2<br>5.    Time: 20:17<br>6.    To change this template use File | Settings | File Templates.<br>7.  –%<span class="tag">&gt;  </span><br>8.  <span class="tag">&lt;%@ page <span class="attribute">contentType=<span class="attribute-value">“text/html;charset=UTF-8” <span class="attribute">language=<span class="attribute-value">“java” %<span class="tag">&gt;  </span></span></span></span></span></span><br>9.  <span class="tag">&lt;%–<span class="tag">&lt;%@ taglib <span class="attribute">prefix=<span class="attribute-value">“c” <span class="attribute">uri=<span class="attribute-value">“<a href="http://java.sun.com/jsp/jstl/core&quot;" target="_blank" rel="noopener">http://java.sun.com/jsp/jstl/core&quot;</a> %<span class="tag">&gt;–%<span class="tag">&gt;  </span></span></span></span></span></span></span></span><br>10.  <span class="tag">&lt;%@ taglib <span class="attribute">prefix=<span class="attribute-value">“shiro” <span class="attribute">uri=<span class="attribute-value">“<a href="http://shiro.apache.org/tags&quot;" target="_blank" rel="noopener">http://shiro.apache.org/tags&quot;</a> %<span class="tag">&gt;  </span></span></span></span></span></span><br>11.  <span class="tag">&lt;<span class="tag-name">html<span class="tag">&gt;  </span></span></span><br>12.  <span class="tag">&lt;<span class="tag-name">head<span class="tag">&gt;  </span></span></span><br>13.      <span class="tag">&lt;<span class="tag-name">title<span class="tag">&gt;欢迎!<span class="tag">&lt;/<span class="tag-name">title<span class="tag">&gt;  </span></span></span></span></span></span><br>14.  <span class="tag">&lt;/<span class="tag-name">head<span class="tag">&gt;  </span></span></span><br>15.  <span class="tag">&lt;<span class="tag-name">body <span class="attribute">style=<span class="attribute-value">“text-align: center”<span class="tag">&gt;  </span></span></span></span></span><br>16.      <span class="tag">&lt;<span class="tag-name">h1<span class="tag">&gt;${message }<span class="tag">&lt;/<span class="tag-name">h1<span class="tag">&gt;  </span></span></span></span></span></span><br>17.      <span class="tag">&lt;<span class="tag-name">h1<span class="tag">&gt;用户列表–<span class="tag">&lt;<span class="tag-name">a <span class="attribute">href=<span class="attribute-value">“${pageContext.request.contextPath }/logout”<span class="tag">&gt;退出登录<span class="tag">&lt;/<span class="tag-name">a<span class="tag">&gt;<span class="tag">&lt;/<span class="tag-name">h1<span class="tag">&gt;  </span></span></span></span></span></span></span></span></span></span></span></span></span></span><br>18.      当前登录用户: <span class="tag">&lt;<span class="tag-name">shiro:principal<span class="tag">/&gt;<span class="tag">&lt;<span class="tag-name">br<span class="tag">/&gt;  </span></span></span></span></span></span><br>19.      <span class="tag">&lt;<span class="tag-name">shiro:authenticated<span class="tag">&gt;我已登录,但未记住<span class="tag">&lt;<span class="tag-name">br<span class="tag">/&gt;<span class="tag">&lt;/<span class="tag-name">shiro:authenticated<span class="tag">&gt;  </span></span></span></span></span></span></span></span></span><br>20.      <span class="tag">&lt;<span class="tag-name">shiro:user<span class="tag">&gt;我已登录,或已记住<span class="tag">&lt;<span class="tag-name">br<span class="tag">/&gt;<span class="tag">&lt;/<span class="tag-name">shiro:user<span class="tag">&gt;  </span></span></span></span></span></span></span></span></span><br>21.      <span class="tag">&lt;<span class="tag-name">shiro:guest<span class="tag">&gt;我是访客<span class="tag">&lt;<span class="tag-name">br<span class="tag">/&gt;<span class="tag">&lt;/<span class="tag-name">shiro:guest<span class="tag">&gt;  </span></span></span></span></span></span></span></span></span><br>22.      <span class="tag">&lt;<span class="tag-name">shiro:hasAnyRoles <span class="attribute">name=<span class="attribute-value">“manager,admin”<span class="tag">&gt;manager or admin 角色用户登录显示此内容<span class="tag">&lt;<span class="tag-name">br<span class="tag">/&gt;<span class="tag">&lt;/<span class="tag-name">shiro:hasAnyRoles<span class="tag">&gt;  </span></span></span></span></span></span></span></span></span></span></span><br>23.      <span class="tag">&lt;<span class="tag-name">shiro:hasRole <span class="attribute">name=<span class="attribute-value">“系统管理员”<span class="tag">&gt;我是系统管理员<span class="tag">&lt;<span class="tag-name">br<span class="tag">/&gt;<span class="tag">&lt;/<span class="tag-name">shiro:hasRole<span class="tag">&gt;  </span></span></span></span></span></span></span></span></span></span></span><br>24.      <span class="tag">&lt;<span class="tag-name">shiro:hasRole <span class="attribute">name=<span class="attribute-value">“会员”<span class="tag">&gt;我是会员<span class="tag">&lt;<span class="tag-name">br<span class="tag">/&gt;<span class="tag">&lt;/<span class="tag-name">shiro:hasRole<span class="tag">&gt;  </span></span></span></span></span></span></span></span></span></span></span><br>25.      <span class="tag">&lt;<span class="tag-name">h2<span class="tag">&gt;权限列表<span class="tag">&lt;/<span class="tag-name">h2<span class="tag">&gt;  </span></span></span></span></span></span><br>26.      <span class="tag">&lt;<span class="tag-name">shiro:hasPermission <span class="attribute">name=<span class="attribute-value">“权限列表”<span class="tag">&gt;具有权限列表权限用户显示此内容<span class="tag">&lt;<span class="tag-name">br<span class="tag">/&gt;<span class="tag">&lt;/<span class="tag-name">shiro:hasPermission<span class="tag">&gt;  </span></span></span></span></span></span></span></span></span></span></span><br>27.      <span class="tag">&lt;<span class="tag-name">shiro:hasPermission <span class="attribute">name=<span class="attribute-value">“用户列表”<span class="tag">&gt;具有用户列表权限用户显示此内容<span class="tag">&lt;<span class="tag-name">br<span class="tag">/&gt;<span class="tag">&lt;/<span class="tag-name">shiro:hasPermission<span class="tag">&gt;  </span></span></span></span></span></span></span></span></span></span></span><br>28.      <span class="tag">&lt;<span class="tag-name">shiro:hasPermission <span class="attribute">name=<span class="attribute-value">“在线用户”<span class="tag">&gt;具有在线用户权限用户显示此内容<span class="tag">&lt;<span class="tag-name">br<span class="tag">/&gt;<span class="tag">&lt;/<span class="tag-name">shiro:hasPermission<span class="tag">&gt;  </span></span></span></span></span></span></span></span></span></span></span><br>29.      <span class="tag">&lt;<span class="tag-name">shiro:lacksPermission <span class="attribute">name=<span class="attribute-value">“角色分配保存”<span class="tag">&gt;不具有角色分配保存权限的用户显示此内容 <span class="tag">&lt;<span class="tag-name">br<span class="tag">/&gt;<span class="tag">&lt;/<span class="tag-name">shiro:lacksPermission<span class="tag">&gt;  </span></span></span></span></span></span></span></span></span></span></span><br>30.<br>31.  <span class="tag">&lt;/<span class="tag-name">body<span class="tag">&gt;  </span></span></span><br>32.  <span class="tag">&lt;/<span class="tag-name">html<span class="tag">&gt;  </span></span></span><br><br>启动后在页面上输入：<a href="http://localhost:8080/boot/会跳转到login登录页面：" target="_blank" rel="noopener">http://localhost:8080/boot/会跳转到login登录页面：</a><br><img src="http://pangguoming.com/blog/images/0ad58d0b-2994-41f6-acbd-ffc0f06453d2.jpg" alt=""><br><br>登录后会跳转到welcome页面，该页面使用了shiro标签，会进行权限认证：<br><br> <img src="http://pangguoming.com/blog/images/73877d60-a478-43cf-98bf-4a194242bee3.jpg" alt=""><br></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://pangguoming.com/post/5860b93c.html">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="庞国明">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars0.githubusercontent.com/u/7269202?s=460&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="庞国明-博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/post/5860b93c.html" itemprop="url">帝国备份王出错</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-12-06T20:38:00+08:00">
                2017-12-06
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <div class="content-head clearfix"><br><br>## Parse error: syntaxerror, unexpected $end in解决方法<br><br><div id="content" class="content mod-cs-content text-content clearfix"><br><br>我在本地wamp环境下面使用<strong>帝国备份王</strong>时，报错信息如下：<br><br><strong>Parse </strong>error<strong>: </strong>syntaxerror<strong>, unexpected $end in D:wampwwwhuifuclassfunctions.php on line 1246</strong><br><br>在网上搜索了大量文章都说是php短标签的问题，但是我在公司电脑上面的wamp环境下采取同样的操作并没有出现这样的报错信息，最后我想到了在公 司电脑上面的wamp环境下设置了php.ini里面的short_open_tag为on，随后在自己电脑上面开启short_open_tag后果然 解决了问题。<br><br>现在总结一下设置short_open_tag为on的方法：<br><br>方法一：<br><br>打开D:wampphp目录下面的php.ini，找到short_open_tag，把后面的off改为on<br><br>方法二：<br><br>左键点击电脑右下角wamp图标—php设置—选中short_open_tag，现在看到的short_open_tag前面带上而来三角形符号<br><br></div></div>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://pangguoming.com/post/afa1319d.html">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="庞国明">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars0.githubusercontent.com/u/7269202?s=460&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="庞国明-博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/post/afa1319d.html" itemprop="url">spring boot整合mybatis+mybatis-plus</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-12-05T10:21:00+08:00">
                2017-12-05
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Spring boot对于我来说是一个刚接触的新东西，学习过程中，发现这东西还是很容易上手的，Spring boot没配置时会默认使用Spring data jpa，这东西可以说一个极简洁的工具，可是我还是比较喜欢用mybatis,工具是没有最好的，只有这合适自己的。</p>
<p>说到mybatis，最近有一个很好用的工具——–mybatis-Plus（<a href="http://baomidou.oschina.io/mybatis-plus-doc/#/" target="_blank" rel="noopener">官网</a>）,现在更新的版本是2.1.2，这里使用的也是这个版本。我比较喜欢的功能是代码生成器，条件构造器，这样就可以更容易的去开发了。</p>
<p>mybatisPlus官网上是有Spring boot整个的例子的，我也跟着它走了一篇，结果，程序没跑起来，后来才知道demo用的H2 database，和mysql根本不是同一样东西，所以各位想要整合mybatisPlus，可以不看官网的，可以少走弯路。</p>
<p><strong>下面就是整合的过程</strong></p>
<p>1、首先要把需要的jar文件都弄过来，pom.xml需要的东西如下</p>
<p>pom.xml(不完整)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- mybatis-plus begin --&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;com.baomidou&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;mybatisplus-spring-boot-starter&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;1.0.4&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;com.baomidou&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;mybatis-plus&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;2.1.2&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-boot-starter-jdbc&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;!-- mybatis-plus end --&gt;  </span><br><span class="line"></span><br><span class="line">&lt;!-- druid阿里巴巴数据库连接池 --&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;com.alibaba&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;druid&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;1.1.3&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>
<p>2、添加mybatis相关的配置，如账号、密码等。这里我使用了application.yml来配。</p>
<p>application.yml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">server:</span><br><span class="line">    port: 8080</span><br><span class="line"></span><br><span class="line">#spring</span><br><span class="line">spring:</span><br><span class="line">  devtools:</span><br><span class="line">    restart:</span><br><span class="line">      enabled: true     #这里是为了热部署的，与mybatis是无关的</span><br><span class="line"></span><br><span class="line">  #DATABASE CONFIG</span><br><span class="line">  datasource:</span><br><span class="line">    driver-class-name: com.mysql.jdbc.Driver</span><br><span class="line">    username: root</span><br><span class="line">    password: root</span><br><span class="line">    url: jdbc:mysql://mysqldb:3306/tdx_shop?useUnicode=true&amp;characterEncoding=utf-8</span><br><span class="line">    type: com.alibaba.druid.pool.DruidDataSource   #这里是配置druid连接池，以下都是druid的配置信息</span><br><span class="line">    filters: stat,wall,log4j</span><br><span class="line">    maxActive: 20</span><br><span class="line">    initialSize: 1</span><br><span class="line">    maxWait: 60000</span><br><span class="line">    minIdle: 1</span><br><span class="line">    timeBetweenEvictionRunsMillis: 60000</span><br><span class="line">    minEvictableIdleTimeMillis: 300000</span><br><span class="line">    validationQuery: select &apos;x&apos;</span><br><span class="line">    testWhileIdle: true</span><br><span class="line">    testOnBorrow: false</span><br><span class="line">    testOnReturn: false</span><br><span class="line">    poolPreparedStatements: true</span><br><span class="line">    maxOpenPreparedStatements: 20</span><br><span class="line">    connection-properties: druid.stat.merggSql=ture;druid.stat.slowSqlMillis=5000</span><br><span class="line"></span><br><span class="line">#mybatis</span><br><span class="line">mybatis:</span><br><span class="line">  mapper-locations: classpath*:/mapper/**Mapper.xml   #把xml文件放在com.XX.mapper.*中可能会出现找到的问题，这里把他放在resource下的mapper中</span><br><span class="line">  #实体扫描，多个package用逗号或者分号分隔</span><br><span class="line">  typeAliasesPackage: com.tdx.account_service.entity  #这里是实体类的位置</span><br><span class="line">  configuration:</span><br><span class="line">    map-underscore-to-camel-case: true</span><br><span class="line">    cache-enabled: false</span><br><span class="line">#logging</span><br><span class="line">logging:</span><br><span class="line">  level: warn</span><br></pre></td></tr></table></figure>
<p>配置的东西和我们以前用mybatis配置可以说差不多，但spring boot是没有xml配置文件的。注意一下红字的内容，基本没问题了。</p>
<p>3、mybatis-Plus配置文件——MybatisPlusConfig，首先上图说明一下文件路径。其中MybatisPlusConfig是放在config文件夹内，而xml文件是放在resouces下mapper中。</p>
<p><img src="http://pangguoming.com/blog/images/d140a441-06bd-4d70-be2f-33e330c924c5.png" alt=""></p>
<p>接着就是MybatisPlusConfig内容部分了</p>
<div><br><div id="highlighter_162249" class="syntaxhighlighter  java"><br><table border="0" cellspacing="0" cellpadding="0"><br><tbody><br><tr><br><td class="gutter"><br><div class="line number1 index0 alt2">1<br></div></td><br><td class="code"><br><div class="container"><br><div class="line number1 index0 alt2"><code class="java plain">MybatisProperties.java</code><br><br></div></div></td><br></tr><br></tbody><br></table><br><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br></pre></td><td class="code"><pre><span class="line">package com.tdx.account_service.config;</span><br><span class="line"></span><br><span class="line">import com.alibaba.druid.pool.DruidDataSource;</span><br><span class="line">import com.alibaba.druid.support.http.StatViewServlet;</span><br><span class="line">import com.alibaba.druid.support.http.WebStatFilter;</span><br><span class="line">import com.baomidou.mybatisplus.MybatisConfiguration;</span><br><span class="line">import com.baomidou.mybatisplus.MybatisXMLLanguageDriver;</span><br><span class="line">import com.baomidou.mybatisplus.entity.GlobalConfiguration;</span><br><span class="line">import com.baomidou.mybatisplus.enums.DBType;</span><br><span class="line">import com.baomidou.mybatisplus.plugins.PaginationInterceptor;</span><br><span class="line">import com.baomidou.mybatisplus.plugins.PerformanceInterceptor;</span><br><span class="line">import com.baomidou.mybatisplus.plugins.parser.ISqlParser;</span><br><span class="line">import com.baomidou.mybatisplus.plugins.parser.ISqlParserFilter;</span><br><span class="line">import com.baomidou.mybatisplus.plugins.parser.tenant.TenantHandler;</span><br><span class="line">import com.baomidou.mybatisplus.plugins.parser.tenant.TenantSqlParser;</span><br><span class="line">import com.baomidou.mybatisplus.spring.MybatisSqlSessionFactoryBean;</span><br><span class="line">import com.baomidou.mybatisplus.spring.boot.starter.SpringBootVFS;</span><br><span class="line">import com.baomidou.mybatisplus.toolkit.PluginUtils;</span><br><span class="line">import net.sf.jsqlparser.expression.Expression;</span><br><span class="line">import net.sf.jsqlparser.expression.LongValue;</span><br><span class="line">import org.apache.ibatis.mapping.DatabaseIdProvider;</span><br><span class="line">import org.apache.ibatis.mapping.MappedStatement;</span><br><span class="line">import org.apache.ibatis.plugin.Interceptor;</span><br><span class="line">import org.apache.ibatis.reflection.MetaObject;</span><br><span class="line">import org.mybatis.spring.annotation.MapperScan;</span><br><span class="line">import org.mybatis.spring.boot.autoconfigure.MybatisProperties;</span><br><span class="line">import org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line">import org.springframework.boot.bind.RelaxedPropertyResolver;</span><br><span class="line">import org.springframework.boot.context.properties.EnableConfigurationProperties;</span><br><span class="line">import org.springframework.boot.web.servlet.FilterRegistrationBean;</span><br><span class="line">import org.springframework.boot.web.servlet.ServletRegistrationBean;</span><br><span class="line">import org.springframework.context.annotation.Bean;</span><br><span class="line">import org.springframework.context.annotation.Configuration;</span><br><span class="line">import org.springframework.core.env.Environment;</span><br><span class="line">import org.springframework.core.io.DefaultResourceLoader;</span><br><span class="line">import org.springframework.core.io.ResourceLoader;</span><br><span class="line">import org.springframework.util.ObjectUtils;</span><br><span class="line">import org.springframework.util.StringUtils;</span><br><span class="line"></span><br><span class="line">import javax.sql.DataSource;</span><br><span class="line">import java.sql.SQLException;</span><br><span class="line">import java.util.ArrayList;</span><br><span class="line">import java.util.List;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * code is far away from bug with the animal protecting</span><br><span class="line"> * ┏┓　　　┏┓</span><br><span class="line"> * ┏┛┻━━━┛┻┓</span><br><span class="line"> * ┃　　　　　　　┃</span><br><span class="line"> * ┃　　　━　　　┃</span><br><span class="line"> * ┃　┳┛　┗┳　┃</span><br><span class="line"> * ┃　　　　　　　┃</span><br><span class="line"> * ┃　　　┻　　　┃</span><br><span class="line"> * ┃　　　　　　　┃</span><br><span class="line"> * ┗━┓　　　┏━┛</span><br><span class="line"> * 　　┃　　　┃神兽保佑</span><br><span class="line"> * 　　┃　　　┃代码无BUG！</span><br><span class="line"> * 　　┃　　　┗━━━┓</span><br><span class="line"> * 　　┃　　　　　　　┣┓</span><br><span class="line"> * 　　┃　　　　　　　┏┛</span><br><span class="line"> * 　　┗┓┓┏━┳┓┏┛</span><br><span class="line"> * 　　　┃┫┫　┃┫┫</span><br><span class="line"> * 　　　┗┻┛　┗┻┛</span><br><span class="line"> *</span><br><span class="line"> *</span><br><span class="line"> * @Description : MybatisPlus配置</span><br><span class="line"> * ---------------------------------</span><br><span class="line"> * @Author : Liang.Guangqing</span><br><span class="line"> * @Date : Create in 2017/9/19 13:54</span><br><span class="line"> */</span><br><span class="line">@Configuration</span><br><span class="line">@EnableConfigurationProperties(MybatisProperties.class)</span><br><span class="line">public class MybatisPlusConfig &#123;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private Environment environment;</span><br><span class="line">    private RelaxedPropertyResolver propertyResolver;</span><br><span class="line">    @Autowired</span><br><span class="line">    private DataSource dataSource;</span><br><span class="line">    @Autowired</span><br><span class="line">    private MybatisProperties properties;</span><br><span class="line">    @Autowired</span><br><span class="line">    private ResourceLoader resourceLoader = new DefaultResourceLoader();</span><br><span class="line">    @Autowired(required = false)</span><br><span class="line">    private Interceptor[] interceptors;</span><br><span class="line">    @Autowired(required = false)</span><br><span class="line">    private DatabaseIdProvider databaseIdProvider;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * @Description : mybatis-plus SQL执行效率插件【生产环境可以关闭】</span><br><span class="line">     * ---------------------------------</span><br><span class="line">     * @Author : Liang.Guangqing</span><br><span class="line">     * @Date : Create in 2017/9/19 13:57</span><br><span class="line">     */</span><br><span class="line">    @Bean</span><br><span class="line">    public PerformanceInterceptor performanceInterceptor() &#123;</span><br><span class="line">        return new PerformanceInterceptor();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 配置DataSource</span><br><span class="line">     * @return</span><br><span class="line">     * @throws SQLException</span><br><span class="line">     */</span><br><span class="line">    @Bean</span><br><span class="line">    public DataSource druidDataSource() throws SQLException &#123;</span><br><span class="line">        this.propertyResolver = new RelaxedPropertyResolver(environment, &quot;spring.datasource.&quot;);</span><br><span class="line"></span><br><span class="line">        System.out.println(&quot;====================注入druid!====================&quot;);</span><br><span class="line">        DruidDataSource datasource = new DruidDataSource();</span><br><span class="line">        datasource.setUrl(propertyResolver.getProperty(&quot;url&quot;));</span><br><span class="line">        datasource.setDriverClassName(propertyResolver.getProperty(&quot;driver-class-name&quot;));</span><br><span class="line">        datasource.setUsername(propertyResolver.getProperty(&quot;username&quot;));</span><br><span class="line">        datasource.setPassword(propertyResolver.getProperty(&quot;password&quot;));</span><br><span class="line">        datasource.setInitialSize(Integer.valueOf(propertyResolver.getProperty(&quot;initial-size&quot;)));</span><br><span class="line">        datasource.setMinIdle(Integer.valueOf(propertyResolver.getProperty(&quot;min-idle&quot;)));</span><br><span class="line">        datasource.setMaxWait(Long.valueOf(propertyResolver.getProperty(&quot;max-wait&quot;)));</span><br><span class="line">        datasource.setMaxActive(Integer.valueOf(propertyResolver.getProperty(&quot;max-active&quot;)));</span><br><span class="line">        datasource.setMinEvictableIdleTimeMillis(Long.valueOf(propertyResolver.getProperty(&quot;min-evictable-idle-time-millis&quot;)));</span><br><span class="line">        try &#123;</span><br><span class="line">            datasource.setFilters(propertyResolver.getProperty(&quot;filters&quot;));</span><br><span class="line">        &#125; catch (SQLException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        return datasource;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * @Description : mybatis-plus分页插件</span><br><span class="line">     * ---------------------------------</span><br><span class="line">     * @Author : Liang.Guangqing</span><br><span class="line">     * @Date : Create in 2017/9/19 13:59</span><br><span class="line">     */</span><br><span class="line">    @Bean</span><br><span class="line">    public PaginationInterceptor paginationInterceptor() &#123;</span><br><span class="line">        PaginationInterceptor page = new PaginationInterceptor();</span><br><span class="line">        page.setDialectType(&quot;mysql&quot;);</span><br><span class="line">        return page;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 这里全部使用mybatis-autoconfigure 已经自动加载的资源。不手动指定</span><br><span class="line">     * 配置文件和mybatis-boot的配置文件同步</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    @Bean</span><br><span class="line">    public MybatisSqlSessionFactoryBean mybatisSqlSessionFactoryBean() &#123;</span><br><span class="line">        MybatisSqlSessionFactoryBean mybatisPlus = new MybatisSqlSessionFactoryBean();</span><br><span class="line">        mybatisPlus.setDataSource(dataSource);</span><br><span class="line">        mybatisPlus.setVfs(SpringBootVFS.class);</span><br><span class="line">        if (StringUtils.hasText(this.properties.getConfigLocation())) &#123;</span><br><span class="line">            mybatisPlus.setConfigLocation(this.resourceLoader.getResource(this.properties.getConfigLocation()));</span><br><span class="line">        &#125;</span><br><span class="line">        mybatisPlus.setConfiguration(properties.getConfiguration());</span><br><span class="line">        if (!ObjectUtils.isEmpty(this.interceptors)) &#123;</span><br><span class="line">            mybatisPlus.setPlugins(this.interceptors);</span><br><span class="line">        &#125;</span><br><span class="line">        // MP 全局配置，更多内容进入类看注释</span><br><span class="line">        GlobalConfiguration globalConfig = new GlobalConfiguration();</span><br><span class="line">        globalConfig.setDbType(DBType.MYSQL.name());</span><br><span class="line">        // ID 策略 AUTO-&gt;`0`(&quot;数据库ID自增&quot;) INPUT-&gt;`1`(用户输入ID&quot;) ID_WORKER-&gt;`2`(&quot;全局唯一ID&quot;) UUID-&gt;`3`(&quot;全局唯一ID&quot;)</span><br><span class="line">        globalConfig.setIdType(2);</span><br><span class="line">        mybatisPlus.setGlobalConfig(globalConfig);</span><br><span class="line">        MybatisConfiguration mc = new MybatisConfiguration();</span><br><span class="line">        mc.setDefaultScriptingLanguage(MybatisXMLLanguageDriver.class);</span><br><span class="line">        mybatisPlus.setConfiguration(mc);</span><br><span class="line">        if (this.databaseIdProvider != null) &#123;</span><br><span class="line">            mybatisPlus.setDatabaseIdProvider(this.databaseIdProvider);</span><br><span class="line">        &#125;</span><br><span class="line">        if (StringUtils.hasLength(this.properties.getTypeAliasesPackage())) &#123;</span><br><span class="line">            mybatisPlus.setTypeAliasesPackage(this.properties.getTypeAliasesPackage());</span><br><span class="line">        &#125;</span><br><span class="line">        if (StringUtils.hasLength(this.properties.getTypeHandlersPackage())) &#123;</span><br><span class="line">            mybatisPlus.setTypeHandlersPackage(this.properties.getTypeHandlersPackage());</span><br><span class="line">        &#125;</span><br><span class="line">        if (!ObjectUtils.isEmpty(this.properties.resolveMapperLocations())) &#123;</span><br><span class="line">            mybatisPlus.setMapperLocations(this.properties.resolveMapperLocations());</span><br><span class="line">        &#125;</span><br><span class="line">        return mybatisPlus;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 注册一个StatViewServlet</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    @Bean</span><br><span class="line">    public ServletRegistrationBean DruidStatViewServle()&#123;</span><br><span class="line">        //org.springframework.boot.context.embedded.ServletRegistrationBean提供类的进行注册.</span><br><span class="line">        ServletRegistrationBean servletRegistrationBean = new ServletRegistrationBean(new StatViewServlet(),&quot;/druid/*&quot;);</span><br><span class="line">        //添加初始化参数：initParams</span><br><span class="line">        //白名单：</span><br><span class="line">        // servletRegistrationBean.addInitParameter(&quot;allow&quot;,&quot;127.0.0.1&quot;);</span><br><span class="line">        //IP黑名单 (存在共同时，deny优先于allow) : 如果满足deny的话提示:Sorry, you are not permitted to view this page.</span><br><span class="line">        // servletRegistrationBean.addInitParameter(&quot;deny&quot;,&quot;192.168.1.73&quot;);</span><br><span class="line">        //登录查看信息的账号密码.</span><br><span class="line">        servletRegistrationBean.addInitParameter(&quot;loginUsername&quot;,&quot;root&quot;);</span><br><span class="line">        servletRegistrationBean.addInitParameter(&quot;loginPassword&quot;,&quot;root&quot;);</span><br><span class="line">        //是否能够重置数据.</span><br><span class="line">        servletRegistrationBean.addInitParameter(&quot;resetEnable&quot;,&quot;false&quot;);</span><br><span class="line">        return servletRegistrationBean;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 注册一个：filterRegistrationBean</span><br><span class="line">     *</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    @Bean</span><br><span class="line">    public FilterRegistrationBean druidStatFilter()&#123;</span><br><span class="line">        FilterRegistrationBean filterRegistrationBean = new FilterRegistrationBean(new WebStatFilter());</span><br><span class="line">        //添加过滤规则.</span><br><span class="line">        filterRegistrationBean.addUrlPatterns(&quot;/*&quot;);</span><br><span class="line">        //添加不需要忽略的格式信息.</span><br><span class="line">        filterRegistrationBean.addInitParameter(&quot;exclusions&quot;,&quot;*.js,*.gif,*.jpg,*.png,*.css,*.ico,/druid/*&quot;);</span><br><span class="line">        return filterRegistrationBean;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br><br>这里是完整的配置文件，需要注意的是引入的包，别引错了！<br><br>4、还要开启dao的扫描，很简单，就是在启动文件中添加@MapperScan(“com.tdx.account_service.dao<em>“)，如下是完整的<br><br><img src="http://pangguoming.com/blog/images/7505a141-84e4-47eb-abea-412dd8f59efd.png" alt=""><br><br>到这里，配置算是完成了，运行一下项目是可以运行起来的。<br><br>我觉得Mybatis-Plus最好玩得应该是代码生成器这部分内容，下面是<strong>代码生成器的使用过程</strong><br><br>pom.xml上要加点东西<br><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.apache.velocity&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;velocity-engine-core&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;2.0&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure><br><br>1、代码生成器的配置文件<br><br>MybatisPlusConfig.java<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><br><br>    /**
     </em> Copyright (c) 2011-2016, hubin (<a href="mailto:jobob@qq.com" target="_blank" rel="noopener">jobob@qq.com</a>).<br>     <em> <p>
     </p></em> Licensed under the Apache License, Version 2.0 (the “License”); you may not<br>     <em> use this file except in compliance with the License. You may obtain a copy of
     </em> the License at<br>     <em> <p>
     </p></em> <a href="http://www.apache.org/licenses/LICENSE-2.0" target="_blank" rel="noopener">http://www.apache.org/licenses/LICENSE-2.0</a><br>     <em> <p>
     </p></em> Unless required by applicable law or agreed to in writing, software<br>     <em> distributed under the License is distributed on an “AS IS” BASIS, WITHOUT
     </em> WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the<br>     <em> License for the specific language governing permissions and limitations under
     </em> the License.<br>     <em>/<br>    package com.tdx.account_service.generator;<br><br>    import java.io.File;<br>    import java.util.ArrayList;<br>    import java.util.Collections;<br>    import java.util.HashMap;<br>    import java.util.List;<br>    import java.util.Map;<br><br>    import com.baomidou.mybatisplus.enums.FieldFill;<br>    import com.baomidou.mybatisplus.generator.AutoGenerator;<br>    import com.baomidou.mybatisplus.generator.InjectionConfig;<br>    import com.baomidou.mybatisplus.generator.config.DataSourceConfig;<br>    import com.baomidou.mybatisplus.generator.config.FileOutConfig;<br>    import com.baomidou.mybatisplus.generator.config.GlobalConfig;<br>    import com.baomidou.mybatisplus.generator.config.PackageConfig;<br>    import com.baomidou.mybatisplus.generator.config.StrategyConfig;<br>    import com.baomidou.mybatisplus.generator.config.TemplateConfig;<br>    import com.baomidou.mybatisplus.generator.config.converts.MySqlTypeConvert;<br>    import com.baomidou.mybatisplus.generator.config.po.TableFill;<br>    import com.baomidou.mybatisplus.generator.config.po.TableInfo;<br>    import com.baomidou.mybatisplus.generator.config.rules.DbColumnType;<br>    import com.baomidou.mybatisplus.generator.config.rules.DbType;<br>    import com.baomidou.mybatisplus.generator.config.rules.NamingStrategy;<br><br>    /**
     </em>code is far away from bug with the animal protecting<br>     <em>  ┏┓　　　┏┓
     </em>┏┛┻━━━┛┻┓<br>     <em>┃　　　　　　　┃ 　
     </em>┃　　　━　　　┃<br>     <em>┃　┳┛　┗┳　┃
     </em>┃　　　　　　　┃<br>     <em>┃　　　┻　　　┃
     </em>┃　　　　　　　┃<br>     <em>┗━┓　　　┏━┛
     </em>　　┃　　　┃神兽保佑<br>     <em>　　┃　　　┃代码无BUG！
     </em>　　┃　　　┗━━━┓<br>     <em>　　┃　　　　　　　┣┓
     </em>　　┃　　　　　　　┏┛<br>     <em>　　┗┓┓┏━┳┓┏┛
     </em>　　　┃┫┫　┃┫┫<br>     <em>　　　┗┻┛　┗┻┛
     </em>　　<br>     <em>   @Description : MybatisPlus代码生成器
     </em>   ———————————<br>     <em>   @Author : Liang.Guangqing
     </em>   @Date : Create in 2017/9/19 14:48　<br>     <em>/<br>    public class MysqlGenerator {<br><br>        private static String packageName=”account_service”;    //文件路径<br>        private static String authorName=”Liang.Guangqing”;     //作者<br>        private static String table=”sc_user”;                  //table名字<br>        private static String prefix=”sc_”;                     //table前缀<br>        private static File file = new File(packageName);<br>        private static String path = file.getAbsolutePath();<br><br>        public static void main(String[] args) {<br>            // 自定义需要填充的字段<br>            List<tablefill> tableFillList = new ArrayList&lt;&gt;();<br>            tableFillList.add(new TableFill(“ASDD_SS”, FieldFill.INSERT_UPDATE));<br>            // 代码生成器<br>            AutoGenerator mpg = new AutoGenerator().setGlobalConfig(<br>                    // 全局配置<br>                    new GlobalConfig()<br>                            .setOutputDir(path+”/src/main/java”)//输出目录<br>                            .setFileOverride(true)// 是否覆盖文件<br>                            .setActiveRecord(true)// 开启 activeRecord 模式<br>                            .setEnableCache(false)// XML 二级缓存<br>                            .setBaseResultMap(true)// XML ResultMap<br>                            .setBaseColumnList(true)// XML columList<br>                            .setOpen(false)//生成后打开文件夹<br>                            .setAuthor(authorName)<br>                    // 自定义文件命名，注意 %s 会自动填充表实体属性！<br>                     .setMapperName(“%sMapper”)<br>                     .setXmlName(“%sMapper”)<br>                     .setServiceName(“%sService”)<br>                     .setServiceImplName(“%sServiceImpl”)<br>                     .setControllerName(“%sController”)<br>            ).setDataSource(<br>                    // 数据源配置<br>                    new DataSourceConfig()<br>                            .setDbType(DbType.MYSQL)// 数据库类型<br>                            .setTypeConvert(new MySqlTypeConvert() {<br>                                // 自定义数据库表字段类型转换【可选】<br>                                @Override<br>                                public DbColumnType processTypeConvert(String fieldType) {<br>                                    System.out.println(“转换类型：” + fieldType);<br>                                    // if ( fieldType.toLowerCase().contains( “tinyint” ) ) {<br>                                    //    return DbColumnType.BOOLEAN;<br>                                    // }<br>                                    return super.processTypeConvert(fieldType);<br>                                }<br>                            })<br>                            .setDriverName(“com.mysql.jdbc.Driver”)<br>                            .setUsername(“root”)<br>                            .setPassword(“root”)<br>                            .setUrl(“jdbc:mysql://127.0.0.1:3306/tdx_shop?characterEncoding=utf8”)<br>            ).setStrategy(<br>                    // 策略配置<br>                    new StrategyConfig()<br>                            // .setCapitalMode(true)// 全局大写命名<br>                            //.setDbColumnUnderline(true)//全局下划线命名<br>                            .setTablePrefix(new String[]{prefix})// 此处可以修改为您的表前缀<br>                            .setNaming(NamingStrategy.underline_to_camel)// 表名生成策略<br>                            .setInclude(new String[] { table }) // 需要生成的表<br>                            .setRestControllerStyle(true)<br>                            //.setExclude(new String[]{“test”}) // 排除生成的表<br>                            // 自定义实体父类<br>                            // .setSuperEntityClass(“com.baomidou.demo.TestEntity”)<br>                            // 自定义实体，公共字段<br>                            //.setSuperEntityColumns(new String[]{“test_id”})<br>                            .setTableFillList(tableFillList)<br>                    // 自定义 mapper 父类<br>                    // .setSuperMapperClass(“com.baomidou.demo.TestMapper”)<br>                    // 自定义 service 父类<br>                    // .setSuperServiceClass(“com.baomidou.demo.TestService”)<br>                    // 自定义 service 实现类父类<br>                    // .setSuperServiceImplClass(“com.baomidou.demo.TestServiceImpl”)<br>                    // 自定义 controller 父类<br>                    .setSuperControllerClass(“com.tdx.”+packageName+”.controller.AbstractController”)<br>                    // 【实体】是否生成字段常量（默认 false）<br>                    // public static final String ID = “test_id”;<br>                    // .setEntityColumnConstant(true)<br>                    // 【实体】是否为构建者模型（默认 false）<br>                    // public User setName(String name) {this.name = name; return this;}<br>                    // .setEntityBuilderModel(true)<br>                    // 【实体】是否为lombok模型（默认 false）<a href="https://projectlombok.org/" target="_blank" rel="noopener">document</a><br>                    // .setEntityLombokModel(true)<br>                    // Boolean类型字段是否移除is前缀处理<br>                    // .setEntityBooleanColumnRemoveIsPrefix(true)<br>                    // .setRestControllerStyle(true)<br>                    // .setControllerMappingHyphenStyle(true)<br>            ).setPackageInfo(<br>                    // 包配置<br>                    new PackageConfig()<br>                            //.setModuleName(“User”)<br>                            .setParent(“com.tdx.”+packageName)// 自定义包路径<br>                            .setController(“controller”)// 这里是控制器包名，默认 web<br>                            .setEntity(“entity”)<br>                            .setMapper(“dao”)<br>                            .setService(“service”)<br>                            .setServiceImpl(“service.impl”)<br>                            //.setXml(“mapper”)<br>            ).setCfg(<br>                    // 注入自定义配置，可以在 VM 中使用 cfg.abc 设置的值<br>                    new InjectionConfig() {<br>                        @Override<br>                        public void initMap() {<br>                            Map&lt;String, Object&gt; map = new HashMap&lt;&gt;();<br>                            map.put(“abc”, this.getConfig().getGlobalConfig().getAuthor() + “-mp”);<br>                            this.setMap(map);<br>                        }<br>                    }.setFileOutConfigList(Collections.<fileoutconfig>singletonList(new FileOutConfig(“/templates/mapper.xml.vm”) {<br>                        // 自定义输出文件目录<br>                        @Override<br>                        public String outputFile(TableInfo tableInfo) {<br>                            return path+”/src/main/resources/mapper/“ + tableInfo.getEntityName() + “Mapper.xml”;<br>                        }<br>                    }))<br>            ).setTemplate(<br>                    // 关闭默认 xml 生成，调整生成 至 根目录<br>                    new TemplateConfig().setXml(null)<br>                    // 自定义模板配置，模板可以参考源码 /mybatis-plus/src/main/resources/template 使用 copy<br>                    // 至您项目 src/main/resources/template 目录下，模板名称也可自定义如下配置：<br>                    // .setController(“…”);<br>                    // .setEntity(“…”);<br>                    // .setMapper(“…”);<br>                    // .setXml(“…”);<br>                    // .setService(“…”);<br>                    // .setServiceImpl(“…”);<br>            );<br><br>            // 执行生成<br>            mpg.execute();<br><br>            // 打印注入设置，这里演示模板里面怎么获取注入内容【可无】<br>            System.err.println(mpg.getCfg().getMap().get(“abc”));<br>        }<br><br>    }<br>    <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">文件中修改的内容还是很多的，最主要的还是mysql的连接信息，没理由你账号，密码都错了还能连得上吧，其次设置一下你生成的模板文件路径，我这里生成的路径在上面图可以看得到，是在com.tdx.account_service下的，注意，xml文件要放在resources下，不然是识别的，说找不到这个方法</span><br><span class="line"></span><br><span class="line">按照官网的代码模板生成的文件基本是白白的，主要是mybatis-Plus集成了公共方法，很多常用的工具都可以引用了。在这里我提供一下我修改后Controller.java.vm文件，主要还是按照我自己的习惯去弄的</span><br><span class="line"></span><br><span class="line">controller.java.vm</span><br></pre></td></tr></table></figure><br><br>    package ${package.Controller};<br><br>    import org.springframework.web.bind.annotation.RequestMapping;<br>    import org.springframework.web.bind.annotation.RequestParam;<br><br>    #if(${restControllerStyle})<br>    import org.springframework.web.bind.annotation.RequestMethod;<br>    import org.springframework.web.bind.annotation.RestController;<br>    #else<br>    import org.springframework.stereotype.Controller;<br>    #end<br>    #if(${superControllerClassPackage})<br>    import ${superControllerClassPackage};<br>    #end<br>    import org.springframework.beans.factory.annotation.Autowired;<br>    import com.baomidou.mybatisplus.mapper.EntityWrapper;<br>    import com.baomidou.mybatisplus.plugins.Page;<br>    import ${package.Service}.${table.serviceName};<br>    import ${package.Entity}.common.DatatablesJSON;<br>    import ${package.Entity}.common.JSONResult;<br>    import ${package.Entity}.${entity};<br>    import org.slf4j.Logger;<br>    import org.slf4j.LoggerFactory;<br><br>    /**
     </fileoutconfig></tablefill></em>code is far away from bug with the animal protecting<br>     <em>  ┏┓　　　┏┓
     </em>┏┛┻━━━┛┻┓<br>     <em>┃　　　　　　　┃ 　
     </em>┃　　　━　　　┃<br>     <em>┃　┳┛　┗┳　┃
     </em>┃　　　　　　　┃<br>     <em>┃　　　┻　　　┃
     </em>┃　　　　　　　┃<br>     <em>┗━┓　　　┏━┛
     </em>　　┃　　　┃神兽保佑<br>     <em>　　┃　　　┃代码无BUG！
     </em>　　┃　　　┗━━━┓<br>     <em>　　┃　　　　　　　┣┓
     </em>　　┃　　　　　　　┏┛<br>     <em>　　┗┓┓┏━┳┓┏┛
     </em>　　　┃┫┫　┃┫┫<br>     <em>　　　┗┻┛　┗┻┛
     </em>　　<br>     <em>   @description : ${entity} 控制器
     </em>   ———————————<br>     <em>      @author ${author}
     </em>   @since ${date}<br>     <em>/<br>    #if(${restControllerStyle})<br>    @RestController<br>    #else<br>    @Controller<br>    #end<br>    @RequestMapping(“#if(${package.ModuleName})/${package.ModuleName}#end/#if(${controllerMappingHyphenStyle})${controllerMappingHyphen}#else${table.entityPath}#end”)<br>    #if(${superControllerClass})<br>    public class ${table.controllerName} extends ${superControllerClass} {<br>    #else<br>    public class ${table.controllerName} {<br>    #end<br>        private final Logger logger = LoggerFactory.getLogger(${table.controllerName}.class);<br><br>        @Autowired<br>        public ${table.serviceName} ${table.entityPath}Service;<br><br>        /**
         </em> @description : 获取分页列表<br>         <em> ———————————
         </em> @author : ${author}<br>         <em> @since : Create in ${date}
         </em>/<br>        @RequestMapping(value = “/get${entity}List”,method = RequestMethod.POST)<br>        public Object get${entity}List(${entity} param , @RequestParam(value = “draw”,defaultValue = “0”) Integer draw,<br>                                            @RequestParam(value = “length”) Integer length,<br>                                            @RequestParam(value = “start”) Integer start) {<br>                DatatablesJSON&lt;${entity}&gt; resJson=new DatatablesJSON&lt;&gt;();<br>                try {<br>                    Integer pageNo=getPageNo(start,length);<br>                    Page&lt;${entity}&gt; page=new Page&lt;${entity}&gt;(pageNo,length);<br>                    ${table.entityPath}Service.selectPage(page,new EntityWrapper&lt;${entity}&gt;(param));<br>                    resJson.setDraw(draw++);<br>                    resJson.setRecordsTotal(page.getTotal());<br>                    resJson.setRecordsFiltered(page.getTotal());<br>                    resJson.setData(page.getRecords());<br>                    resJson.setSuccess(true);<br>                }catch (Exception e){<br>                    resJson.setSuccess(false);<br>                    resJson.setError(“异常信息:{“+e.getClass().getName()+”}”);<br>                    logger.info(“异常信息:{}”+e.getMessage());<br>                }<br>                return resJson;<br>        }<br><br>        /<strong><br>         <em> @description : 通过id获取${entity}
         </em> ———————————<br>         <em> @author : ${author}
         </em> @since : Create in ${date}<br>         */<br>        @RequestMapping(value = “/get${entity}ById”,method = RequestMethod.GET)<br>        public Object get${entity}ById(String id) {<br>                JSONResult&lt;${entity}&gt; resJson = new JSONResult&lt;&gt;();<br>                try {<br>                    ${entity} param= ${table.entityPath}Service.selectById(id);<br>                    resJson.setData(param);<br>                    resJson.setSuccess(true);<br>                }catch (Exception e) {<br>                    resJson.setSuccess(false);<br>                    resJson.setMessage(“异常信息:{“+e.getClass().getName()+”}”);<br>                    logger.info(“异常信息:{}”+e.getMessage());<br>                }<br>                return resJson;<br>        }<br><br>        /</strong><br>         <em> @description : 通过id删除${entity}
         </em> ———————————<br>         <em> @author : ${author}
         </em> @since : Create in ${date}<br>         <em>/<br>        @RequestMapping(value = “/delete${entity}ById”,method = RequestMethod.GET)<br>        public Object delete${entity}ById(String id) {<br>                JSONResult&lt;${entity}&gt; resJson = new JSONResult&lt;&gt;();<br>                try{<br>                    resJson.setSuccess(${table.entityPath}Service.deleteById(id));<br>                }catch (Exception e) {<br>                    resJson.setSuccess(false);<br>                    resJson.setMessage(“异常信息:{“+e.getClass().getName()+”}”);<br>                    logger.info(“异常信息:{}”+e.getMessage());<br>                }<br>                return resJson;<br>        }<br><br>        /**
         </em> @description : 通过id更新${entity}<br>         <em> ———————————
         </em> @author : ${author}<br>         <em> @since : Create in ${date}
         </em>/<br>        @RequestMapping(value = “/update${entity}ById”,method = RequestMethod.POST)<br>        public Object update${entity}ById(${entity} param) {<br>                JSONResult&lt;${entity}&gt; resJson = new JSONResult&lt;&gt;();<br>                try{<br>                    resJson.setSuccess(${table.entityPath}Service.updateById(param));<br>                }catch (Exception e) {<br>                    resJson.setSuccess(false);<br>                    resJson.setMessage(“异常信息:{“+e.getClass().getName()+”}”);<br>                    logger.info(“异常信息:{}”+e.getMessage());<br>                }<br>                return resJson;<br>        }<br><br>        /<strong><br>         <em> @description : 添加${entity}
         </em> ———————————<br>         <em> @author : ${author}
         </em> @since : Create in ${date}<br>         */<br>        @RequestMapping(value = “/add${entity}”,method = RequestMethod.POST)<br>        public Object add${entity}(${entity} param) {<br>                JSONResult&lt;${entity}&gt; resJson = new JSONResult&lt;&gt;();<br>                try{<br>                    resJson.setSuccess(${table.entityPath}Service.insert(param));<br>                }catch (Exception e) {<br>                    resJson.setSuccess(false);<br>                    resJson.setMessage(“异常信息:{“+e.getClass().getName()+”}”);<br>                    logger.info(“异常信息:{}”+e.getMessage());<br>                }<br>                return resJson;<br>        }<br>    }<br>    <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">除了这个文件，其他代码模板我都是按照官网那样的，这里引用3个外部的文件，有AbstractController.java（控制器基类）、DatatablesJSON.java和JSONResult.java，然后这些文件又引用了其他文件，我懵逼了，怎么文件这么多啊，看来如果全部都贴上来得多占地方啊，所以我选择相信码云，如果需要请在码云上按照少的文件下载，[码云地址](https://gitee.com/lgqBlog/common)。需要注意的是，我的模板是直接代替了mybatis-plus.jar中的templates目录。</span><br><span class="line"></span><br><span class="line">**最后就到了测试过程**</span><br><span class="line"></span><br><span class="line">下面的代码段都是放在Controller文件里面，然后启动程序，对应端口，请求方法。测试的话是需要按照自己的实体类操作的，所以仅供参考。</span><br></pre></td></tr></table></figure><br><br>        /</strong><br>         <em> 分页 PAGE
         </em>/<br>        @GetMapping(“/test”)<br>        public Page<user> test() {<br>            return userService.selectPage(new Page<user>(0, 12));<br>        }<br><br>        /<strong><br>         <em> AR 部分测试
         </em>/<br>        @GetMapping(“/test1”)<br>        public Page<user> test1() {<br>            User user = new User();<br>            System.err.println(“删除所有：” + user.delete(null));<br>            //user.setId(2017091801L);<br>            user.setAccout(“test”+num++);<br>            user.setType(“test”);<br>            user.setCreateTime(new Date());<br>            user.setPhone(“13111110000”);<br>            user.setPassword(“123456”);<br>            user.setNickname(“guangqing”+2*num++);<br>            user.insert();<br>            System.err.println(“查询插入结果：” + user.selectById().toString());<br>            //user.setNickname(“mybatis-plus-ar”);<br>            System.err.println(“更新：” + user.updateById());<br>            return user.selectPage(new Page<user>(0, 12), null);<br>        }<br><br>        /</user></user></strong><br>         <em> 增删改查 CRUD
         </em>/<br>        @GetMapping(“/test2”)<br>        public User test2() {<br>            User user = new User();<br>            user.setId(123456L);<br>            user.setAccout(“test”);<br>            user.setType(“test”);<br>            user.setCreateTime(new Date());<br>            user.setPhone(“13111110000”);<br>            user.setPassword(“123456”);<br>            user.setNickname(“guangqing”);<br>            System.err.println(“删除一条数据：” + userService.deleteById(1L));<br>            System.err.println(“插入一条数据：” + userService.insert(user));<br>            User user2 = new User();<br>            user.setId(223456L);<br>            user.setAccout(“test2”);<br>            user.setType(“test”);<br>            user.setCreateTime(new Date());<br>            user.setPhone(“13111110000”);<br>            user.setPassword(“123456”);<br>            user.setNickname(“guangqing”);<br>            boolean result = userService.insert(user);<br>            // 自动回写的ID<br>            Long id = user.getId();<br>            System.err.println(“插入一条数据：” + result + “, 插入信息：” + user.toString());<br>            System.err.println(“查询：” + userService.selectById(id).toString());<br>            Page<user> userListPage = userService.selectPage(new Page<user>(1, 5), new EntityWrapper&lt;&gt;(new User()));<br>            System.err.println(“total=” + userListPage.getTotal() + “, current list size=” + userListPage.getRecords().size());<br>            return userService.selectById(1L);<br>        }<br><br>        @GetMapping(“testSelect”)<br>        public Object testSelect() {<br>            Integer start = 0;<br>            Integer length =10;<br>            User param = new User();<br>            //param.setNickname(“guangqing2”);<br>            Integer pageNo=getPageNo(start,length);<br>            Page<user> page =new Page<user>(pageNo,length);<br>            EntityWrapper<user> ew = new EntityWrapper<user>();<br>            ew.setEntity(param);<br>            ew.where(“password={0}”,”123456”)<br>                    .like(“nickname”,”guangqing”)<br>                    .ge(“create_time”,”2017-09-21 15:50:00”);<br>            userService.selectPage(page, ew);<br>            DatatablesJSON<user> resJson= new DatatablesJSON&lt;&gt;();<br>            //resJson.setDraw(draw++);<br>            resJson.setRecordsTotal(page.getTotal());<br>            resJson.setRecordsFiltered(page.getTotal());<br>            resJson.setData(page.getRecords());<br>            return resJson;<br>        }<br><br>        @GetMapping(“/selectsql”)<br>        public Object getUserBySql() {<br>            JSONObject result = new JSONObject();<br>            result.put(“records”, userService.selectListBySQL());<br>            return result;<br>        }<br><br>        /<strong><br>         <em> 7、分页 size 一页显示数量  current 当前页码
         </em> 方式一：<a href="http://localhost:8080/user/page?size=1&amp;current=1" target="_blank" rel="noopener">http://localhost:8080/user/page?size=1&amp;current=1</a><br><br>         <em> 方式二：<a href="http://localhost:8080/user/pagehelper?size=1&amp;current=1" target="_blank" rel="noopener">http://localhost:8080/user/pagehelper?size=1&amp;current=1</a><br>
         </em>/<br><br>        // 参数模式分页<br>        @GetMapping(“/page”)<br>        public Object page(Page page) {<br>            return userService.selectPage(page);<br>        }<br><br>        // ThreadLocal 模式分页<br>        @GetMapping(“/pagehelper”)<br>        public Object pagehelper(Page page) {<br>            PageHelper.setPagination(page);<br>            page.setRecords(userService.selectList(null));<br>            page.setTotal(PageHelper.freeTotal());//获取总数并释放资源 也可以 PageHelper.getTotal()<br>            return page;<br>        }<br><br>        /</strong><br>         <em> 测试事物
         </em> <a href="http://localhost:8080/user/test_transactional" target="_blank" rel="noopener">http://localhost:8080/user/test_transactional</a><br><br>         <em> 访问如下并未发现插入数据说明事物可靠！！<br>
         </em> <a href="http://localhost:8080/user/test" target="_blank" rel="noopener">http://localhost:8080/user/test</a><br><br>         <em> <br>
         </em> 启动  Application 加上 @EnableTransactionManagement 注解其实可无默认貌似就开启了<br><br>         <em> 需要事物的方法加上 @Transactional 必须的哦！！
         </em>/<br>        @Transactional<br>        @GetMapping(“/test_transactional”)<br>        public void testTransactional() {<br>            //userService.insert(new User(1000L, “测试事物”, 16, 3));<br>            System.out.println(“ 这里手动抛出异常，自动回滚数据”);<br>            throw new RuntimeException();<br>        }<br>    <code>`</code><br><br>这么多的测试，我觉得最有趣的是条件构造器，在官网上有更齐全的，而我这里是按照我自己的需求写的。<br><br>最后谢谢大家的观看，写博客经验不足，写得不好请见谅，如果能给你带来帮助请点个赞，若遇到不明白的，或者我有写错的地方请提出，谢谢！<br><br>引自<a href="https://www.cnblogs.com/lianggp/p/7573653.html" target="_blank" rel="noopener">https://www.cnblogs.com/lianggp/p/7573653.html</a><br><br></user></user></user></user></user></user></user></user></user></div></div>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://pangguoming.com/post/368d0714.html">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="庞国明">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars0.githubusercontent.com/u/7269202?s=460&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="庞国明-博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/post/368d0714.html" itemprop="url">Druid连接池简介和配置</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-12-04T15:25:00+08:00">
                2017-12-04
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Druid是什么？有什么作用？"><a href="#Druid是什么？有什么作用？" class="headerlink" title="Druid是什么？有什么作用？ "></a>Druid是什么？有什么作用？ <span class="actions"><a href="http://www.iteye.com/magazines/90#top" target="_blank" rel="noopener"><img src="http://pangguoming.com/blog/images/965d293c-1d26-4c1b-8286-e63b3101fbe2.jpg" alt="Top"></a></span></h2><div class="news_content">Druid首先是一个数据库连接池，但它不仅仅是一个数据库连接池，它还包含一个ProxyDriver，一系列内置的JDBC组件库，一个SQL Parser。<br><br>## Druid的项目背景？目前的项目团队情况？开源目的？ <span class="actions"><a href="http://www.iteye.com/magazines/90#top" target="_blank" rel="noopener"><img src="http://pangguoming.com/blog/images/965d293c-1d26-4c1b-8286-e63b3101fbe2.jpg" alt="Top"></a></span><br><br><div class="news_content">2010年开始，我负责设计一个叫做Dragoon的监控系统，需要一些监控组件，监控应用程序的运行情况，包括Web URI、Spring、JDBC等。为了监控SQL执行情况，我做了一个Filter-Chain模式的ProxyDriver，缺省提供StatFilter。当时我还做了一个SQL Parser。老板说，不如我们来一个更大的计划，把连接池、SQL Parser、Proxy Driver合起来做一个项目，命名为Druid，于是Druid就诞生了。<br><br>2011年2月春节期间，我完成了连接池（DruidDataSource）的第一个版本，4月开始在生产环境测试，2012年第一季度开始大规模实施。<br><br>提交过代码的开发者有5个人，主要代码是我维护，有一人专门负责内部实施。<br><br>通过开源，希望有更多使用场景，更多的反馈，更多人参与其中，共同打造最好的数据库连接池。<br><br>## Druid支持哪些数据库？ <span class="actions"><a href="http://www.iteye.com/magazines/90#top" target="_blank" rel="noopener"><img src="http://pangguoming.com/blog/images/965d293c-1d26-4c1b-8286-e63b3101fbe2.jpg" alt="Top"></a></span><br><br><div class="news_content">Druid支持所有JDBC兼容的数据库，包括Oracle、MySql、Derby、Postgresql、SQL Server、H2等等。<br><br>Druid针对Oracle和MySql做了特别优化，比如Oracle的PS Cache内存占用优化，MySql的ping检测优化。<br><br>## Druid是如何扩展JDBC的? <span class="actions"><a href="http://www.iteye.com/magazines/90#top" target="_blank" rel="noopener"><img src="http://pangguoming.com/blog/images/965d293c-1d26-4c1b-8286-e63b3101fbe2.jpg" alt="Top"></a></span><br><br><div class="news_content">Druid在DruidDataSourc和ProxyDriver上提供了Filter-Chain模式的扩展API，类似Serlvet的Filter，配置Filter拦截JDBC的方法调用。<br><br>## 为什么说Druid是“最好的数据库连接池”?体现在哪些方面？这是如何实现的？ <span class="actions"><a href="http://www.iteye.com/magazines/90#top" target="_blank" rel="noopener"><img src="http://pangguoming.com/blog/images/965d293c-1d26-4c1b-8286-e63b3101fbe2.jpg" alt="Top"></a></span><br><br><div class="news_content">阿里巴巴是一个重度使用关系数据库的公司，我们在生产环境中大量的使用Druid，通过长期在极高负载的生产环境中实际使用、修改和完善，让Druid逐步发展成最好的数据库连接池。Druid在监控、可扩展性、稳定性和性能方面都有明显的优势。<br><br>首先，强大的监控特性，通过Druid提供的监控功能，可以清楚知道连接池和SQL的工作情况。<br><br><em>   监控SQL的执行时间、ResultSet持有时间、返回行数、更新行数、错误次数、错误堆栈信息。
</em>   SQL执行的耗时区间分布。什么是耗时区间分布呢？比如说，某个SQL执行了1000次，其中0~1毫秒区间50次，1~10毫秒800次，10~100毫秒100次，100~1000毫秒30次，1~10秒15次，10秒以上5次。通过耗时区间分布，能够非常清楚知道SQL的执行耗时情况。<br><em>   监控连接池的物理连接创建和销毁次数、逻辑连接的申请和关闭次数、非空等待次数、PSCache命中率等。<br><div><img src="http://dl.iteye.com/upload/attachment/0070/8056/775a7a10-fd54-35ab-8728-23f8049025d1.jpg" alt="" title="点击查看原始大小图片"><br><br>其次，方便扩展。Druid提供了Filter-Chain模式的扩展API，可以自己编写Filter拦截JDBC中的任何方法，可以在上面做任何事情，比如说性能监控、SQL审计、用户名密码加密、日志等等。<br><br>Druid内置提供了用于监控的StatFilter、日志输出的Log系列Filter、防御SQL注入攻击的WallFilter。<br><br>阿里巴巴内部实现了用于数据库密码加密的CirceFilter，以及和Web、Spring关联监控的DragoonStatFilter。<br><br><div><img src="http://dl.iteye.com/upload/attachment/0070/8058/8a350468-05d3-3e8c-a2d8-2f1fcc7a7fe9.jpg" alt="" title="点击查看原始大小图片"><br><br>第三，Druid集合了开源和商业数据库连接池的优秀特性，并结合阿里巴巴大规模苛刻生产环境的使用经验进行优化。  

</div></div></em>   ExceptionSorter。当一个连接产生不可恢复的异常时，例如Oracle error_code_28 session has been killed，必须立刻从连接池中逐出，否则会产生大量错误。目前只有Druid和JBoss DataSource实现了ExceptionSorter。<br><em>   PSCache内存占用优化对于支持游标的数据库（Oracle、SQL Server、DB2等，不包括MySql），PSCache可以大幅度提升SQL执行性能。一个PreparedStatement对应服务器一个游标，如果PreparedStatement被缓存起来重复执行，PreparedStatement没有被关闭，服务器端的游标就不会被关闭，性能提高非常显著。在类似“SELECT </em> FROM T WHERE ID = ?”这样的场景，性能可能是一个数量级的提升。但在Oracle JDBC Driver中，其他的数据库连接池（DBCP、JBossDataSource）会占用内存过多，极端情况可能大于1G。Druid调用OracleDriver提供管理PSCache内部API。<br><em>   LRU是一个性能关键指标，特别Oracle，每个Connection对应数据库端的一个进程，如果数据库连接池遵从LRU，有助于数据库服务器优化，这是重要的指标。Druid、DBCP、Proxool、JBoss是遵守LRU的。BoneCP、C3P0则不是。BoneCP在mock环境下性能可能还好，但在真实环境中则就不好了。<br><br>## Druid的性能如何？能否给出一些测试对比数据？ <span class="actions"><a href="http://www.iteye.com/magazines/90#top" target="_blank" rel="noopener"><img src="http://pangguoming.com/blog/images/965d293c-1d26-4c1b-8286-e63b3101fbe2.jpg" alt="Top"></a></span><br><br><div class="news_content">性能不是Druid的设计目标，但是测试数据表明，Druid性能比DBCP、C3P0、Proxool、JBoss都好。<br><br>这里有一些测试数据：<a href="http://code.alibabatech.com/wiki/pages/viewpage.action?pageId=2916539" target="_blank" rel="noopener">http://code.alibabatech.com/wiki/pages/viewpage.action?pageId=2916539</a><br><br>## 谈谈Druid的SQL解析功能？效率如何？ <span class="actions"><a href="http://www.iteye.com/magazines/90#top" target="_blank" rel="noopener"><img src="http://pangguoming.com/blog/images/965d293c-1d26-4c1b-8286-e63b3101fbe2.jpg" alt="Top"></a></span><br><br><div class="news_content">Druid提供了MySql、Oracle、Postgresql、SQL-92的SQL的完整支持，这是一个手写的高性能SQL Parser，支持Visitor模式，使得分析SQL的抽象语法树很方便。<br><br>简单SQL语句用时10微秒以内，复杂SQL用时30微秒。<br><br>通过Druid提供的SQL Parser可以在JDBC层拦截SQL做相应处理，比如说分库分表、审计等。Druid防御SQL注入攻击的WallFilter就是通过Druid的SQL Parser分析语义实现的。<br><br>## Druid的扩展性如何？ <span class="actions"><a href="http://www.iteye.com/magazines/90#top" target="_blank" rel="noopener"><img src="http://pangguoming.com/blog/images/965d293c-1d26-4c1b-8286-e63b3101fbe2.jpg" alt="Top"></a></span><br><br><div class="news_content">Druid提供Filter-Chain模式的插件框架，通过编写Filter配置到DruidDataSource中就可以拦截JDBC的各种API，从而实现扩展。Druid提供了一系列内置Filter。<br><br>## 在SQL注入防御方面，Druid的优势是什么？实现原理是什么？ <span class="actions"><a href="http://www.iteye.com/magazines/90#top" target="_blank" rel="noopener"><img src="http://pangguoming.com/blog/images/965d293c-1d26-4c1b-8286-e63b3101fbe2.jpg" alt="Top"></a></span><br><br><div class="news_content">Druid的优势是在JDBC最低层进行拦截做判断，不会遗漏。<br><br>Druid实现了Oracle、MySql、Postgresql、SQL-92的Parser，基于SQL语法分析实现，理解其中的SQL语义，智能、准确、误报率低。<br><br>具体细节参考这里：<a href="http://code.alibabatech.com/wiki/display/Druid/WallFilter" target="_blank" rel="noopener">http://code.alibabatech.com/wiki/display/Druid/WallFilter</a><br><br>## 目前Druid的应用（部署）情况？ <span class="actions"><a href="http://www.iteye.com/magazines/90#top" target="_blank" rel="noopener"><img src="http://pangguoming.com/blog/images/965d293c-1d26-4c1b-8286-e63b3101fbe2.jpg" alt="Top"></a></span><br><br><div class="news_content">Druid是阿里巴巴监控系统Dragoon的副产品，从Dragoon监控系统的数据来看，在阿里巴巴已经部署了600多个应用。在阿里巴巴外部也有很多Druid的用户，外部用户没有正式统计数据，但经常有反馈。<br><br>## 我想将其中的某个模块（比如监控模块）用到其他连接池，是否可以？模块的独立性如何？ <span class="actions"><a href="http://www.iteye.com/magazines/90#top" target="_blank" rel="noopener"><img src="http://pangguoming.com/blog/images/965d293c-1d26-4c1b-8286-e63b3101fbe2.jpg" alt="Top"></a></span><br><br><div class="news_content">可以通过DruidDriver把内置的Filter用在其他连接池中。在2011年上半年DruidDataSource不成熟的时候，我们也是这么做的。在其他连接池中使用内置的Filter，需要修改jdbc-url，使用DruidDriver作为一个ProxyDriver。<br><br>## 我想在项目中使用，应该注意哪些事项？能否用于商业项目？ <span class="actions"><a href="http://www.iteye.com/magazines/90#top" target="_blank" rel="noopener"><img src="http://pangguoming.com/blog/images/965d293c-1d26-4c1b-8286-e63b3101fbe2.jpg" alt="Top"></a></span><br><br><div class="news_content">Druid是一个开源项目，基于Apache 2.0协议，你可以免费自由使用。Druid只支持JDK 6以上版本，不支持JDK 1.4和JDK 5.0。<br><br>Druid集连接池，监控于一体整好复合当前项目的需要，项目是ssh结构，之前是用C3p0的，现在换一个连接池也是很简单的，首先spring配置DataSource，配置如下：<br><br><div class="dp-highlighter bg_html"><br><div class="bar"><br><div class="tools"><strong>[html]</strong> <a href="http://blog.csdn.net/pk490525/article/details/12621649#" title="view plain" target="_blank" rel="noopener">view plain</a> <a href="http://blog.csdn.net/pk490525/article/details/12621649#" title="copy" target="_blank" rel="noopener">copy</a><br><div><br><br>1.  <span class="tag">&lt;<span class="tag-name">bean <span class="attribute">id=<span class="attribute-value">“dataSource” <span class="attribute">class=<span class="attribute-value">“com.alibaba.druid.pool.DruidDataSource” <span class="attribute">init-method=<span class="attribute-value">“init” <span class="attribute">destroy-method=<span class="attribute-value">“close”<span class="tag">&gt;   </span></span></span></span></span></span></span></span></span></span></span><br>2.      <span class="comments"><!-- 基本属性 url、user、password -->  </span><br>3.      <span class="tag">&lt;<span class="tag-name">property <span class="attribute">name=<span class="attribute-value">“url” <span class="attribute">value=<span class="attribute-value">“${jdbc_url}” <span class="tag">/&gt;  </span></span></span></span></span></span></span><br>4.      <span class="tag">&lt;<span class="tag-name">property <span class="attribute">name=<span class="attribute-value">“username” <span class="attribute">value=<span class="attribute-value">“${jdbc_user}” <span class="tag">/&gt;  </span></span></span></span></span></span></span><br>5.      <span class="tag">&lt;<span class="tag-name">property <span class="attribute">name=<span class="attribute-value">“password” <span class="attribute">value=<span class="attribute-value">“${jdbc_password}” <span class="tag">/&gt;  </span></span></span></span></span></span></span><br>6.<br>7.      <span class="comments"><!-- 配置初始化大小、最小、最大 -->  </span><br>8.      <span class="tag">&lt;<span class="tag-name">property <span class="attribute">name=<span class="attribute-value">“initialSize” <span class="attribute">value=<span class="attribute-value">“1” <span class="tag">/&gt;  </span></span></span></span></span></span></span><br>9.      <span class="tag">&lt;<span class="tag-name">property <span class="attribute">name=<span class="attribute-value">“minIdle” <span class="attribute">value=<span class="attribute-value">“1” <span class="tag">/&gt;   </span></span></span></span></span></span></span><br>10.      <span class="tag">&lt;<span class="tag-name">property <span class="attribute">name=<span class="attribute-value">“maxActive” <span class="attribute">value=<span class="attribute-value">“20” <span class="tag">/&gt;  </span></span></span></span></span></span></span><br>11.<br>12.      <span class="comments"><!-- 配置获取连接等待超时的时间 -->  </span><br>13.      <span class="tag">&lt;<span class="tag-name">property <span class="attribute">name=<span class="attribute-value">“maxWait” <span class="attribute">value=<span class="attribute-value">“60000” <span class="tag">/&gt;  </span></span></span></span></span></span></span><br>14.<br>15.      <span class="comments"><!-- 配置间隔多久才进行一次检测，检测需要关闭的空闲连接，单位是毫秒 -->  </span><br>16.      <span class="tag">&lt;<span class="tag-name">property <span class="attribute">name=<span class="attribute-value">“timeBetweenEvictionRunsMillis” <span class="attribute">value=<span class="attribute-value">“60000” <span class="tag">/&gt;  </span></span></span></span></span></span></span><br>17.<br>18.      <span class="comments"><!-- 配置一个连接在池中最小生存的时间，单位是毫秒 -->  </span><br>19.      <span class="tag">&lt;<span class="tag-name">property <span class="attribute">name=<span class="attribute-value">“minEvictableIdleTimeMillis” <span class="attribute">value=<span class="attribute-value">“300000” <span class="tag">/&gt;  </span></span></span></span></span></span></span><br>20.<br>21.      <span class="tag">&lt;<span class="tag-name">property <span class="attribute">name=<span class="attribute-value">“validationQuery” <span class="attribute">value=<span class="attribute-value">“SELECT ‘x’” <span class="tag">/&gt;  </span></span></span></span></span></span></span><br>22.      <span class="tag">&lt;<span class="tag-name">property <span class="attribute">name=<span class="attribute-value">“testWhileIdle” <span class="attribute">value=<span class="attribute-value">“true” <span class="tag">/&gt;  </span></span></span></span></span></span></span><br>23.      <span class="tag">&lt;<span class="tag-name">property <span class="attribute">name=<span class="attribute-value">“testOnBorrow” <span class="attribute">value=<span class="attribute-value">“false” <span class="tag">/&gt;  </span></span></span></span></span></span></span><br>24.      <span class="tag">&lt;<span class="tag-name">property <span class="attribute">name=<span class="attribute-value">“testOnReturn” <span class="attribute">value=<span class="attribute-value">“false” <span class="tag">/&gt;  </span></span></span></span></span></span></span><br>25.<br>26.      <span class="comments"><!-- 打开PSCache，并且指定每个连接上PSCache的大小 -->  </span><br>27.      <span class="tag">&lt;<span class="tag-name">property <span class="attribute">name=<span class="attribute-value">“poolPreparedStatements” <span class="attribute">value=<span class="attribute-value">“true” <span class="tag">/&gt;  </span></span></span></span></span></span></span><br>28.      <span class="tag">&lt;<span class="tag-name">property <span class="attribute">name=<span class="attribute-value">“maxPoolPreparedStatementPerConnectionSize” <span class="attribute">value=<span class="attribute-value">“20” <span class="tag">/&gt;  </span></span></span></span></span></span></span><br>29.<br>30.      <span class="comments"><!-- 配置监控统计拦截的filters，去掉后监控界面sql无法统计 -->  </span><br>31.      <span class="tag">&lt;<span class="tag-name">property <span class="attribute">name=<span class="attribute-value">“filters” <span class="attribute">value=<span class="attribute-value">“stat” <span class="tag">/&gt;   </span></span></span></span></span></span></span><br>32.  <span class="tag">&lt;/<span class="tag-name">bean<span class="tag">&gt;  </span></span></span><br><br> 目前这样的配置已经能够使用连接池，注意不要忘记了jar文件，下载地址：<a href="http://code.alibabatech.com/mvn/releases/com/alibaba/druid/" target="_blank" rel="noopener">http://code.alibabatech.com/mvn/releases/com/alibaba/druid/</a><br><br>然后是监控的配置：<br><br>web.xml<br><br><div class="dp-highlighter bg_html"><br><div class="bar"><br><div class="tools"><strong>[html]</strong> <a href="http://blog.csdn.net/pk490525/article/details/12621649#" title="view plain" target="_blank" rel="noopener">view plain</a> <a href="http://blog.csdn.net/pk490525/article/details/12621649#" title="copy" target="_blank" rel="noopener">copy</a><br><div><br><br>1.  <span class="tag">  &lt;/<span class="tag-name">span<span class="tag">&gt;<span class="tag">&lt;<span class="tag-name">filter<span class="tag">&gt;  </span></span></span></span></span></span><br>2.          <span class="tag">&lt;<span class="tag-name">filter-name<span class="tag">&gt;DruidWebStatFilter<span class="tag">&lt;/<span class="tag-name">filter-name<span class="tag">&gt;  </span></span></span></span></span></span><br>3.          <span class="tag">&lt;<span class="tag-name">filter-class<span class="tag">&gt;com.alibaba.druid.support.http.WebStatFilter<span class="tag">&lt;/<span class="tag-name">filter-class<span class="tag">&gt;  </span></span></span></span></span></span><br>4.          <span class="tag">&lt;<span class="tag-name">init-param<span class="tag">&gt;  </span></span></span><br>5.              <span class="tag">&lt;<span class="tag-name">param-name<span class="tag">&gt;exclusions<span class="tag">&lt;/<span class="tag-name">param-name<span class="tag">&gt;  </span></span></span></span></span></span><br>6.              <span class="tag">&lt;<span class="tag-name">param-value<span class="tag">&gt;</span></span></span></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></em>.js,<em>.gif,</em>.jpg,<em>.png,</em>.css,<em>.ico,/druid/</em><span class="tag">&lt;/<span class="tag-name">param-value<span class="tag">&gt;  </span></span></span><br>7.          <span class="tag">&lt;/<span class="tag-name">init-param<span class="tag">&gt;  </span></span></span><br>8.        <span class="tag">&lt;/<span class="tag-name">filter<span class="tag">&gt;  </span></span></span><br>9.        <span class="tag">&lt;<span class="tag-name">filter-mapping<span class="tag">&gt;  </span></span></span><br>10.          <span class="tag">&lt;<span class="tag-name">filter-name<span class="tag">&gt;DruidWebStatFilter<span class="tag">&lt;/<span class="tag-name">filter-name<span class="tag">&gt;  </span></span></span></span></span></span><br>11.          <span class="tag">&lt;<span class="tag-name">url-pattern<span class="tag">&gt;/<em><span class="tag">&lt;/<span class="tag-name">url-pattern<span class="tag">&gt;  </span></span></span></em></span></span></span><br>12.        <span class="tag">&lt;/<span class="tag-name">filter-mapping<span class="tag">&gt;  </span></span></span><br><br>filter可以监控webURl 访问<br><br><div class="dp-highlighter bg_html"><br><div class="bar"><br><div class="tools"><strong>[html]</strong> <a href="http://blog.csdn.net/pk490525/article/details/12621649#" title="view plain" target="_blank" rel="noopener">view plain</a> <a href="http://blog.csdn.net/pk490525/article/details/12621649#" title="copy" target="_blank" rel="noopener">copy</a><br><div><br><br>1.  <span class="tag">    <span class="tag">&lt;<span class="tag-name">servlet<span class="tag">&gt;  </span></span></span></span><br>2.          <span class="tag">&lt;<span class="tag-name">servlet-name<span class="tag">&gt;DruidStatView<span class="tag">&lt;/<span class="tag-name">servlet-name<span class="tag">&gt;  </span></span></span></span></span></span><br>3.          <span class="tag">&lt;<span class="tag-name">servlet-class<span class="tag">&gt;com.alibaba.druid.support.http.StatViewServlet<span class="tag">&lt;/<span class="tag-name">servlet-class<span class="tag">&gt;  </span></span></span></span></span></span><br>4.      <span class="tag">&lt;/<span class="tag-name">servlet<span class="tag">&gt;  </span></span></span><br>5.      <span class="tag">&lt;<span class="tag-name">servlet-mapping<span class="tag">&gt;  </span></span></span><br>6.          <span class="tag">&lt;<span class="tag-name">servlet-name<span class="tag">&gt;DruidStatView<span class="tag">&lt;/<span class="tag-name">servlet-name<span class="tag">&gt;  </span></span></span></span></span></span><br>7.          <span class="tag">&lt;<span class="tag-name">url-pattern<span class="tag">&gt;/druid/<span class="tag">&lt;/<span class="tag-name">url-pattern<span class="tag">&gt;  </span></span></span></span></span></span><br>8.      <span class="tag">&lt;/<span class="tag-name">servlet-mapping<span class="tag">&gt;  </span></span></span><br><br> 该配置可以访问监控界面<br><br>配置好后访问 <a href="http://ip：port/projectName/druid/index.html" target="_blank" rel="noopener">http://ip：port/projectName/druid/index.html</a><br><br> 经过上面的配置，我们已经能够达到连接池的使用和监控<br></div></div></div></div></div></div></div></div></div>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://pangguoming.com/post/7f0f88d5.html">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="庞国明">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars0.githubusercontent.com/u/7269202?s=460&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="庞国明-博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/post/7f0f88d5.html" itemprop="url">thinkphp生成的验证码不显示问题解决</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-12-02T15:49:00+08:00">
                2017-12-02
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>在调用验证码之前加上 ob_clean();  </p>
<p>不显示验证码的代码：</p>
<ol>
<li><span class="kwd">public<span class="pln"> <span class="kwd">function<span class="pln"> verify<span class="pun">(){</span></span></span></span></span></li>
<li><span class="pln">                $verify <span class="pun">=<span class="pln"> <span class="kwd">new<span class="pln"> \Think\Verify<span class="pun">();</span></span></span></span></span></span></li>
<li><span class="pln">                $verify<span class="pun">-&gt;<span class="pln">entry<span class="pun">();</span></span></span></span></li>
<li><p><span class="pln">        <span class="pun">}</span></span><br><div class="think-copy">复制代码</div></p>
<p>修改为：</p>
</li>
<li><p><span class="kwd">public<span class="pln"> <span class="kwd">function<span class="pln"> verify<span class="pun">(){</span></span></span></span></span></p>
</li>
<li><span class="pln">                ob_clean<span class="pun">();</span></span></li>
<li><span class="pln">                $verify <span class="pun">=<span class="pln"> <span class="kwd">new<span class="pln"> \Think\Verify<span class="pun">();</span></span></span></span></span></span></li>
<li><span class="pln">                $verify<span class="pun">-&gt;<span class="pln">entry<span class="pun">();</span></span></span></span></li>
<li><p><span class="pln">        <span class="pun">}</span></span><br><div class="think-copy">复制代码</div></p>
<p>这样的话，保存再刷新一次，验证码就出现了  </p>
</li>
</ol>
<p>分析：<br>1、ob_clean这个函数的作用：<br>用来丢弃输出缓冲区中的内容，如果你的网站有许多生成的图片类文件，那么想要访问正确，就要经常清除缓冲区<br>2、在出现问题的页面查看源代码，发现在页面尾部出现了一堆其他代码（原因不明）  </p>
<p>来自：<a href="http://www.phptalker.com/thread-471-1-1.html" target="_blank" rel="noopener">http://www.phptalker.com/thread-471-1-1.html</a><br></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/21/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/21/">21</a><span class="page-number current">22</span><a class="page-number" href="/page/23/">23</a><span class="space">&hellip;</span><a class="page-number" href="/page/42/">42</a><a class="extend next" rel="next" href="/page/23/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
      <div id="sidebar-dimmer"></div>
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="https://avatars0.githubusercontent.com/u/7269202?s=460&v=4" alt="庞国明">
            
              <p class="site-author-name" itemprop="name">庞国明</p>
              <p class="site-description motion-element" itemprop="description">Software make the information world run, and programer make the softeware run.</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">420</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">3</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">267</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/pangguoming" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:pangguoming@yeah.net" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://twitter.com/pangguoming" target="_blank" title="Twitter">
                      
                        <i class="fa fa-fw fa-twitter"></i>Twitter</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://stackoverflow.com/users/1570700/pangguoming" target="_blank" title="StackOverflow">
                      
                        <i class="fa fa-fw fa-stack-overflow"></i>StackOverflow</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://instagram.com/pangguoming" target="_blank" title="Instagram">
                      
                        <i class="fa fa-fw fa-instagram"></i>Instagram</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">庞国明</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  







<!-- LOCAL: You can save these files to your site and update links -->
    
        
        <link rel="stylesheet" href="https://aimingoo.github.io/gitmint/style/default.css">
        <script src="https://aimingoo.github.io/gitmint/dist/gitmint.browser.js"></script>
    
<!-- END LOCAL -->

    

    







  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>




  
  
  
  <link rel="stylesheet" href="/lib/algolia-instant-search/instantsearch.min.css">

  
  
  <script src="/lib/algolia-instant-search/instantsearch.min.js"></script>
  

  <script src="/js/src/algolia-search.js?v=5.1.4"></script>



  

  

  

  
  

  

  

  

</body>
</html>
